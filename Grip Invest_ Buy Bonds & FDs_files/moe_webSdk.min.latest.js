/*! For license information please see sdk.js.LICENSE.txt */
(()=>{var e={372:(e,t,n)=>{e.exports=function(e,t,n){if("number"!=typeof t)throw new Error("second argument must be a Number");let a,r,s,o,c,l,d=!0;Array.isArray(e)?(a=[],s=r=e.length):(o=Object.keys(e),a={},s=r=o.length);function g(e){function t(){n&&n(e,a),n=null}d?i(t):t()}function u(t,n,i){if(a[t]=i,n&&(c=!0),0===--s||n)g(n);else if(!c&&l<r){let t;o?(t=o[l],l+=1,e[t](function(e,n){u(t,e,n)})):(t=l,l+=1,e[t](function(e,n){u(t,e,n)}))}}l=t,s?o?o.some(function(n,i){return e[n](function(e,t){u(n,e,t)}),i===t-1}):e.some(function(e,n){return e(function(e,t){u(n,e,t)}),n===t-1}):g(null);d=!1};const i=n(596)},596:(e,t,n)=>{let i;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:n.g):e=>(i||(i=Promise.resolve())).then(e).catch(e=>setTimeout(()=>{throw e},0))},790:(e,t,n)=>{e.exports=function e(t,n,i){function a(s,o){if(!n[s]){if(!t[s]){if(r)return r(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return a(n||e)},l,l.exports,e,t,n,i)}return n[s].exports}for(var r=void 0,s=0;s<i.length;s++)a(i[s]);return a}({1:[function(e,t,i){(function(e){"use strict";var n,i,a=e.MutationObserver||e.WebKitMutationObserver;if(a){var r=0,s=new a(d),o=e.document.createTextNode("");s.observe(o,{characterData:!0}),n=function(){o.data=r=++r%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)};else{var c=new e.MessageChannel;c.port1.onmessage=d,n=function(){c.port2.postMessage(0)}}var l=[];function d(){var e,t;i=!0;for(var n=l.length;n;){for(t=l,l=[],e=-1;++e<n;)t[e]();n=l.length}i=!1}function g(e){1!==l.push(e)||i||n()}t.exports=g}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){"use strict";var i=e(1);function a(){}var r={},s=["REJECTED"],o=["FULFILLED"],c=["PENDING"];function l(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function d(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function g(e,t,n){i(function(){var i;try{i=t(n)}catch(t){return r.reject(e,t)}i===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,i)})}function u(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function i(t){n||(n=!0,r.reject(e,t))}function a(t){n||(n=!0,r.resolve(e,t))}function s(){t(a,i)}var o=m(s);"error"===o.status&&i(o.value)}function m(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}function h(e){return e instanceof this?e:r.resolve(new this(a),e)}function f(e){var t=new this(a);return r.reject(t,e)}function E(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s=new Array(n),o=0,c=-1,l=new this(a);++c<n;)d(e[c],c);return l;function d(e,a){function c(e){s[a]=e,++o!==n||i||(i=!0,r.resolve(l,s))}t.resolve(e).then(c,function(e){i||(i=!0,r.reject(l,e))})}}function S(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s=-1,o=new this(a);++s<n;)c(e[s]);return o;function c(e){t.resolve(e).then(function(e){i||(i=!0,r.resolve(o,e))},function(e){i||(i=!0,r.reject(o,e))})}}t.exports=l,l.prototype.catch=function(e){return this.then(null,e)},l.prototype.then=function(e,t){if("function"!=typeof e&&this.state===o||"function"!=typeof t&&this.state===s)return this;var n=new this.constructor(a);return this.state!==c?g(n,this.state===o?e:t,this.outcome):this.queue.push(new d(n,e,t)),n},d.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},d.prototype.otherCallFulfilled=function(e){g(this.promise,this.onFulfilled,e)},d.prototype.callRejected=function(e){r.reject(this.promise,e)},d.prototype.otherCallRejected=function(e){g(this.promise,this.onRejected,e)},r.resolve=function(e,t){var n=m(u,t);if("error"===n.status)return r.reject(e,n.value);var i=n.value;if(i)p(e,i);else{e.state=o,e.outcome=t;for(var a=-1,s=e.queue.length;++a<s;)e.queue[a].callFulfilled(t)}return e},r.reject=function(e,t){e.state=s,e.outcome=t;for(var n=-1,i=e.queue.length;++n<i;)e.queue[n].callRejected(t);return e},l.resolve=h,l.reject=f,l.all=E,l.race=S},{1:1}],3:[function(e,t,i){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var s=r();function o(){try{if(!s||!s.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function c(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(a){if("TypeError"!==a.name)throw a;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<e.length;i+=1)n.append(e[i]);return n.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var l=Promise;function d(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function g(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function u(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function p(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var m="local-forage-detect-blob-support",h=void 0,f={},E=Object.prototype.toString,S="readonly",_="readwrite";function v(e){for(var t=e.length,n=new ArrayBuffer(t),i=new Uint8Array(n),a=0;a<t;a++)i[a]=e.charCodeAt(a);return n}function y(e){return new l(function(t){var n=e.transaction(m,_),i=c([""]);n.objectStore(m).put(i,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}}).catch(function(){return!1})}function T(e){return"boolean"==typeof h?l.resolve(h):y(e).then(function(e){return h=e})}function b(e){var t=f[e.name],n={};n.promise=new l(function(e,t){n.resolve=e,n.reject=t}),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then(function(){return n.promise}):t.dbReady=n.promise}function I(e){var t=f[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function A(e,t){var n=f[e.name].deferredOperations.pop();if(n)return n.reject(t),n.promise}function w(e,t){return new l(function(n,i){if(f[e.name]=f[e.name]||x(),e.db){if(!t)return n(e.db);b(e),e.db.close()}var a=[e.name];t&&a.push(e.version);var r=s.open.apply(s,a);t&&(r.onupgradeneeded=function(t){var n=r.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(m)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),r.onerror=function(e){e.preventDefault(),i(r.error)},r.onsuccess=function(){var t=r.result;t.onversionchange=function(e){e.target.close()},n(t),I(e)}})}function D(e){return w(e,!1)}function C(e){return w(e,!0)}function O(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),i=e.version<e.db.version,a=e.version>e.db.version;if(i&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),a||n){if(n){var r=e.db.version+1;r>e.version&&(e.version=r)}return!0}return!1}function P(e){return new l(function(t,n){var i=new FileReader;i.onerror=n,i.onloadend=function(n){var i=btoa(n.target.result||"");t({__local_forage_encoded_blob:!0,data:i,type:e.type})},i.readAsBinaryString(e)})}function N(e){return c([v(atob(e.data))],{type:e.type})}function R(e){return e&&e.__local_forage_encoded_blob}function M(e){var t=this,n=t._initReady().then(function(){var e=f[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return g(n,e,e),n}function L(e){b(e);for(var t=f[e.name],n=t.forages,i=0;i<n.length;i++){var a=n[i];a._dbInfo.db&&(a._dbInfo.db.close(),a._dbInfo.db=null)}return e.db=null,D(e).then(function(t){return e.db=t,O(e)?C(e):t}).then(function(i){e.db=t.db=i;for(var a=0;a<n.length;a++)n[a]._dbInfo.db=i}).catch(function(t){throw A(e,t),t})}function k(e,t,n,i){void 0===i&&(i=1);try{var a=e.db.transaction(e.storeName,t);n(null,a)}catch(a){if(i>0&&(!e.db||"InvalidStateError"===a.name||"NotFoundError"===a.name))return l.resolve().then(function(){if(!e.db||"NotFoundError"===a.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),C(e)}).then(function(){return L(e).then(function(){k(e,t,n,i-1)})}).catch(n);n(a)}}function x(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function U(e){var t=this,n={db:null};if(e)for(var i in e)n[i]=e[i];var a=f[n.name];a||(a=x(),f[n.name]=a),a.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=M);var r=[];function s(){return l.resolve()}for(var o=0;o<a.forages.length;o++){var c=a.forages[o];c!==t&&r.push(c._initReady().catch(s))}var d=a.forages.slice(0);return l.all(r).then(function(){return n.db=a.db,D(n)}).then(function(e){return n.db=e,O(n,t._defaultConfig.version)?C(n):e}).then(function(e){n.db=a.db=e,t._dbInfo=n;for(var i=0;i<d.length;i++){var r=d[i];r!==t&&(r._dbInfo.db=n.db,r._dbInfo.version=n.version)}})}function B(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),R(e)&&(e=N(e)),t(e)},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function F(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).openCursor(),o=1;s.onsuccess=function(){var n=s.result;if(n){var i=n.value;R(i)&&(i=N(i));var a=e(i,n.key,o++);void 0!==a?t(a):n.continue()}else t()},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function H(e,t,n){var i=this;e=u(e);var a=new l(function(n,a){var r;i.ready().then(function(){return r=i._dbInfo,"[object Blob]"===E.call(t)?T(r.db).then(function(e){return e?t:P(t)}):t}).then(function(t){k(i._dbInfo,_,function(r,s){if(r)return a(r);try{var o=s.objectStore(i._dbInfo.storeName);null===t&&(t=void 0);var c=o.put(t,e);s.oncomplete=function(){void 0===t&&(t=null),n(t)},s.onabort=s.onerror=function(){var e=c.error?c.error:c.transaction.error;a(e)}}catch(e){a(e)}})}).catch(a)});return d(a,n),a}function V(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,_,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).delete(e);r.oncomplete=function(){t()},r.onerror=function(){i(s.error)},r.onabort=function(){var e=s.error?s.error:s.transaction.error;i(e)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function W(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,_,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).clear();a.oncomplete=function(){e()},a.onabort=a.onerror=function(){var e=r.error?r.error:r.transaction.error;n(e)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function G(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,S,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).count();r.onsuccess=function(){e(r.result)},r.onerror=function(){n(r.error)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function K(e,t){var n=this,i=new l(function(t,i){e<0?t(null):n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName),o=!1,c=s.openKeyCursor();c.onsuccess=function(){var n=c.result;n?0===e||o?t(n.key):(o=!0,n.advance(e)):t(null)},c.onerror=function(){i(c.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function q(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,S,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).openKeyCursor(),s=[];r.onsuccess=function(){var t=r.result;t?(s.push(t.key),t.continue()):e(s)},r.onerror=function(){n(r.error)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function $(e,t){t=p.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i,a=this;if(e.name){var r=e.name===n.name&&a._dbInfo.db?l.resolve(a._dbInfo.db):D(e).then(function(t){var n=f[e.name],i=n.forages;n.db=t;for(var a=0;a<i.length;a++)i[a]._dbInfo.db=t;return t});i=e.storeName?r.then(function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;b(e);var i=f[e.name],a=i.forages;t.close();for(var r=0;r<a.length;r++){var o=a[r];o._dbInfo.db=null,o._dbInfo.version=n}var c=new l(function(t,i){var a=s.open(e.name,n);a.onerror=function(e){a.result.close(),i(e)},a.onupgradeneeded=function(){a.result.deleteObjectStore(e.storeName)},a.onsuccess=function(){var e=a.result;e.close(),t(e)}});return c.then(function(e){i.db=e;for(var t=0;t<a.length;t++){var n=a[t];n._dbInfo.db=e,I(n._dbInfo)}}).catch(function(t){throw(A(e,t)||l.resolve()).catch(function(){}),t})}}):r.then(function(t){b(e);var n=f[e.name],i=n.forages;t.close();for(var a=0;a<i.length;a++)i[a]._dbInfo.db=null;var r=new l(function(t,n){var i=s.deleteDatabase(e.name);i.onerror=function(){var e=i.result;e&&e.close(),n(i.error)},i.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},i.onsuccess=function(){var e=i.result;e&&e.close(),t(e)}});return r.then(function(e){n.db=e;for(var t=0;t<i.length;t++)I(i[t]._dbInfo)}).catch(function(t){throw(A(e,t)||l.resolve()).catch(function(){}),t})})}else i=l.reject("Invalid arguments");return d(i,t),i}var Y={_driver:"asyncStorage",_initStorage:U,_support:o(),iterate:F,getItem:B,setItem:H,removeItem:V,clear:W,length:G,key:K,keys:q,dropInstance:$};function j(){return"function"==typeof openDatabase}var z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",J="~~local_forage_type~",Q=/^~~local_forage_type~([^~]+)~/,X="__lfsc__:",Z=X.length,ee="arbf",te="blob",ne="si08",ie="ui08",ae="uic8",re="si16",se="si32",oe="ur16",ce="ui32",le="fl32",de="fl64",ge=Z+ee.length,ue=Object.prototype.toString;function pe(e){var t,n,i,a,r,s=.75*e.length,o=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var l=new ArrayBuffer(s),d=new Uint8Array(l);for(t=0;t<o;t+=4)n=z.indexOf(e[t]),i=z.indexOf(e[t+1]),a=z.indexOf(e[t+2]),r=z.indexOf(e[t+3]),d[c++]=n<<2|i>>4,d[c++]=(15&i)<<4|a>>2,d[c++]=(3&a)<<6|63&r;return l}function me(e){var t,n=new Uint8Array(e),i="";for(t=0;t<n.length;t+=3)i+=z[n[t]>>2],i+=z[(3&n[t])<<4|n[t+1]>>4],i+=z[(15&n[t+1])<<2|n[t+2]>>6],i+=z[63&n[t+2]];return n.length%3==2?i=i.substring(0,i.length-1)+"=":n.length%3==1&&(i=i.substring(0,i.length-2)+"=="),i}function he(e,t){var n="";if(e&&(n=ue.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===ue.call(e.buffer))){var i,a=X;e instanceof ArrayBuffer?(i=e,a+=ee):(i=e.buffer,"[object Int8Array]"===n?a+=ne:"[object Uint8Array]"===n?a+=ie:"[object Uint8ClampedArray]"===n?a+=ae:"[object Int16Array]"===n?a+=re:"[object Uint16Array]"===n?a+=oe:"[object Int32Array]"===n?a+=se:"[object Uint32Array]"===n?a+=ce:"[object Float32Array]"===n?a+=le:"[object Float64Array]"===n?a+=de:t(new Error("Failed to get type for BinaryArray"))),t(a+me(i))}else if("[object Blob]"===n){var r=new FileReader;r.onload=function(){var n=J+e.type+"~"+me(this.result);t(X+te+n)},r.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}}function fe(e){if(e.substring(0,Z)!==X)return JSON.parse(e);var t,n=e.substring(ge),i=e.substring(Z,ge);if(i===te&&Q.test(n)){var a=n.match(Q);t=a[1],n=n.substring(a[0].length)}var r=pe(n);switch(i){case ee:return r;case te:return c([r],{type:t});case ne:return new Int8Array(r);case ie:return new Uint8Array(r);case ae:return new Uint8ClampedArray(r);case re:return new Int16Array(r);case oe:return new Uint16Array(r);case se:return new Int32Array(r);case ce:return new Uint32Array(r);case le:return new Float32Array(r);case de:return new Float64Array(r);default:throw new Error("Unkown type: "+i)}}var Ee={serialize:he,deserialize:fe,stringToBuffer:pe,bufferToString:me};function Se(e,t,n,i){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,i)}function _e(e){var t=this,n={db:null};if(e)for(var i in e)n[i]="string"!=typeof e[i]?e[i].toString():e[i];var a=new l(function(e,i){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return i(e)}n.db.transaction(function(a){Se(a,n,function(){t._dbInfo=n,e()},function(e,t){i(t)})},i)});return n.serializer=Ee,a}function ve(e,t,n,i,a,r){e.executeSql(n,i,a,function(e,s){s.code===s.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(e,o){o.rows.length?r(e,s):Se(e,t,function(){e.executeSql(n,i,a,r)},r)},r):r(e,s)},r)}function ye(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT * FROM "+a.storeName+" WHERE key = ? LIMIT 1",[e],function(e,n){var i=n.rows.length?n.rows.item(0).value:null;i&&(i=a.serializer.deserialize(i)),t(i)},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function Te(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT * FROM "+a.storeName,[],function(n,i){for(var r=i.rows,s=r.length,o=0;o<s;o++){var c=r.item(o),l=c.value;if(l&&(l=a.serializer.deserialize(l)),void 0!==(l=e(l,c.key,o+1)))return void t(l)}t()},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function be(e,t,n,i){var a=this;e=u(e);var r=new l(function(r,s){a.ready().then(function(){void 0===t&&(t=null);var o=t,c=a._dbInfo;c.serializer.serialize(t,function(t,l){l?s(l):c.db.transaction(function(n){ve(n,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){r(o)},function(e,t){s(t)})},function(t){if(t.code===t.QUOTA_ERR){if(i>0)return void r(be.apply(a,[e,o,n,i-1]));s(t)}})})}).catch(s)});return d(r,n),r}function Ie(e,t,n){return be.apply(this,[e,t,n,1])}function Ae(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"DELETE FROM "+a.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function we(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"DELETE FROM "+i.storeName,[],function(){e()},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function De(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"SELECT COUNT(key) as c FROM "+i.storeName,[],function(t,n){var i=n.rows.item(0).c;e(i)},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function Ce(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT key FROM "+a.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,n){var i=n.rows.length?n.rows.item(0).key:null;t(i)},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function Oe(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"SELECT key FROM "+i.storeName,[],function(t,n){for(var i=[],a=0;a<n.rows.length;a++)i.push(n.rows.item(a).key);e(i)},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function Pe(e){return new l(function(t,n){e.transaction(function(i){i.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(n,i){for(var a=[],r=0;r<i.rows.length;r++)a.push(i.rows.item(r).name);t({db:e,storeNames:a})},function(e,t){n(t)})},function(e){n(e)})})}function Ne(e,t){t=p.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i,a=this;return d(i=e.name?new l(function(t){var i;i=e.name===n.name?a._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:i,storeNames:[e.storeName]}):t(Pe(i))}).then(function(e){return new l(function(t,n){e.db.transaction(function(i){function a(e){return new l(function(t,n){i.executeSql("DROP TABLE IF EXISTS "+e,[],function(){t()},function(e,t){n(t)})})}for(var r=[],s=0,o=e.storeNames.length;s<o;s++)r.push(a(e.storeNames[s]));l.all(r).then(function(){t()}).catch(function(e){n(e)})},function(e){n(e)})})}):l.reject("Invalid arguments"),t),i}var Re={_driver:"webSQLStorage",_initStorage:_e,_support:j(),iterate:Te,getItem:ye,setItem:Ie,removeItem:Ae,clear:we,length:De,key:Ce,keys:Oe,dropInstance:Ne};function Me(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function Le(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function ke(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}function xe(){return!ke()||localStorage.length>0}function Ue(e){var t=this,n={};if(e)for(var i in e)n[i]=e[i];return n.keyPrefix=Le(e,t._defaultConfig),xe()?(t._dbInfo=n,n.serializer=Ee,l.resolve()):l.reject()}function Be(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var i=localStorage.key(n);0===i.indexOf(e)&&localStorage.removeItem(i)}});return d(n,e),n}function Fe(e,t){var n=this;e=u(e);var i=n.ready().then(function(){var t=n._dbInfo,i=localStorage.getItem(t.keyPrefix+e);return i&&(i=t.serializer.deserialize(i)),i});return d(i,t),i}function He(e,t){var n=this,i=n.ready().then(function(){for(var t=n._dbInfo,i=t.keyPrefix,a=i.length,r=localStorage.length,s=1,o=0;o<r;o++){var c=localStorage.key(o);if(0===c.indexOf(i)){var l=localStorage.getItem(c);if(l&&(l=t.serializer.deserialize(l)),void 0!==(l=e(l,c.substring(a),s++)))return l}}});return d(i,t),i}function Ve(e,t){var n=this,i=n.ready().then(function(){var t,i=n._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(i.keyPrefix.length)),t});return d(i,t),i}function We(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo,n=localStorage.length,i=[],a=0;a<n;a++){var r=localStorage.key(a);0===r.indexOf(e.keyPrefix)&&i.push(r.substring(e.keyPrefix.length))}return i});return d(n,e),n}function Ge(e){var t=this.keys().then(function(e){return e.length});return d(t,e),t}function Ke(e,t){var n=this;e=u(e);var i=n.ready().then(function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)});return d(i,t),i}function qe(e,t,n){var i=this;e=u(e);var a=i.ready().then(function(){void 0===t&&(t=null);var n=t;return new l(function(a,r){var s=i._dbInfo;s.serializer.serialize(t,function(t,i){if(i)r(i);else try{localStorage.setItem(s.keyPrefix+e,t),a(n)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||r(e),r(e)}})})});return d(a,n),a}function $e(e,t){if(t=p.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var n=this.config();e.name=e.name||n.name,e.storeName=e.storeName||n.storeName}var i,a=this;return i=e.name?new l(function(t){e.storeName?t(Le(e,a._defaultConfig)):t(e.name+"/")}).then(function(e){for(var t=localStorage.length-1;t>=0;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}}):l.reject("Invalid arguments"),d(i,t),i}var Ye={_driver:"localStorageWrapper",_initStorage:Ue,_support:Me(),iterate:He,getItem:Fe,setItem:qe,removeItem:Ke,clear:Be,length:Ge,key:Ve,keys:We,dropInstance:$e},je=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)},ze=function(e,t){for(var n=e.length,i=0;i<n;){if(je(e[i],t))return!0;i++}return!1},Je=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Qe={},Xe={},Ze={INDEXEDDB:Y,WEBSQL:Re,LOCALSTORAGE:Ye},et=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],tt=["dropInstance"],nt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(tt),it={description:"",driver:et.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function at(e,t){e[t]=function(){var n=arguments;return e.ready().then(function(){return e[t].apply(e,n)})}}function rt(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(Je(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var st=function(){function e(t){for(var n in a(this,e),Ze)if(Ze.hasOwnProperty(n)){var i=Ze[n],r=i._driver;this[n]=r,Qe[r]||this.defineDriver(i)}this._defaultConfig=rt({},it),this._config=rt({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":i(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var i=new l(function(t,n){try{var i=e._driver,a=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(a);for(var r=nt.concat("_initStorage"),s=0,o=r.length;s<o;s++){var c=r[s];if((!ze(tt,c)||e[c])&&"function"!=typeof e[c])return void n(a)}var g=function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),n=l.reject(t);return d(n,arguments[arguments.length-1]),n}},n=0,i=tt.length;n<i;n++){var a=tt[n];e[a]||(e[a]=t(a))}};g();var u=function(n){Qe[i]&&console.info("Redefining LocalForage driver: "+i),Qe[i]=e,Xe[i]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,n):u(!!e._support):u(!0)}catch(e){n(e)}});return g(i,t,n),i},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var i=Qe[e]?l.resolve(Qe[e]):l.reject(new Error("Driver not found."));return g(i,t,n),i},e.prototype.getSerializer=function(e){var t=l.resolve(Ee);return g(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return g(n,e,e),n},e.prototype.setDriver=function(e,t,n){var i=this;Je(e)||(e=[e]);var a=this._getSupportedDrivers(e);function r(){i._config.driver=i.driver()}function s(e){return i._extend(e),r(),i._ready=i._initStorage(i._config),i._ready}function o(e){return function(){var t=0;function n(){for(;t<e.length;){var a=e[t];return t++,i._dbInfo=null,i._ready=null,i.getDriver(a).then(s).catch(n)}r();var o=new Error("No available storage method found.");return i._driverSet=l.reject(o),i._driverSet}return n()}}var c=null!==this._driverSet?this._driverSet.catch(function(){return l.resolve()}):l.resolve();return this._driverSet=c.then(function(){var e=a[0];return i._dbInfo=null,i._ready=null,i.getDriver(e).then(function(e){i._driver=e._driver,r(),i._wrapLibraryMethodsWithReady(),i._initDriver=o(a)})}).catch(function(){r();var e=new Error("No available storage method found.");return i._driverSet=l.reject(e),i._driverSet}),g(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!Xe[e]},e.prototype._extend=function(e){rt(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var a=e[n];this.supports(a)&&t.push(a)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=nt.length;e<t;e++)at(this,nt[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),ot=new st;t.exports=ot},{3:3}]},{},[4])(4)}},t={};function n(i){var a=t[i];if(void 0!==a)return a.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";n.r(i),n.d(i,{exportForTesting:()=>$o,handleLogout:()=>Fo,initializeLaunchSequence:()=>Wo});var e=n(790),t=n.n(e);const a={DEVICE_ADD:"v2/device/add",DEVICE_TOKEN_CHECK:"v2/device/token-check",REPORT_ADD:"v2/report/add"},r=195,s="v1/sdk_logging/",o="USER_ATTRIBUTE_UNIQUE_ID",c="USER_ATTRIBUTE_USER_EMAIL",l="USER_ATTRIBUTE_USER_NAME",d="USER_ATTRIBUTE_USER_FIRST_NAME",g="USER_ATTRIBUTE_USER_LAST_NAME",u="USER_ATTRIBUTE_USER_MOBILE",p="USER_ATTRIBUTE_USER_GENDER",m="USER_ATTRIBUTE_USER_BDAY",h=[o,"USER_ID_MODIFIED_FROM"],f=[{moeName:"uid",attributeName:"USER_ATTRIBUTE_UNIQUE_ID",programName:"id"},{moeName:"u_em",attributeName:"USER_ATTRIBUTE_USER_EMAIL",programName:"email"},{moeName:"u_gd",attributeName:"USER_ATTRIBUTE_USER_GENDER",programName:"gender"},{moeName:"u_bd",attributeName:"USER_ATTRIBUTE_USER_BDAY",programName:"birthday"},{moeName:"u_n",attributeName:"USER_ATTRIBUTE_USER_NAME",programName:"name"},{moeName:"u_fn",attributeName:"USER_ATTRIBUTE_USER_FIRST_NAME",programName:"first_name"},{moeName:"u_ln",attributeName:"USER_ATTRIBUTE_USER_LAST_NAME",programName:"last_name"},{moeName:"u_mb",attributeName:"USER_ATTRIBUTE_USER_MOBILE",programName:"mobile"}],E="moe_push_opted",S="identifiers",_="uid",v="SESSION",y="sessionKey",T="sessionStartTime",b="sessionExpiryTime",I="sessionMaxTime",A="customIdentifiersToTrack",w="currentSource",D="numberOfSessions",C={TOPIC_NAME:"MOE_LIFECYCLE",EVENT_NAMES:{MOE_INIT:"SDK_INITIALIZED",SETTINGS_FETCHED:"SETTINGS_FETCHED",EVENT_TRACKED:"EVENT_TRACKED",DEVICE_UUID:"DEVICE_UUID",MOE_INIT_COMPLETED:"SDK_INITIALIZATION_COMPLETED",CARDS_INIT:"CARDS_INITIALIZED",SDK_DISABLED:"SDK_DISABLED",SDK_ENABLED:"SDK_ENABLED",OSM_INIT:"OSM_INITIALIZED",WEBP_INIT:"WEBP_INITIALIZED",LANDING_PAGE_DEVICE_ADD:"LANDING_PAGE_DEVICE_ADD"}},O={TOPIC_NAME:"MOE_OPT_IN",EVENT_NAMES:{HARD_ASK_SHOWN:"HARD_ASK_SHOWN",HARD_ASK_DISMISSED:"HARD_ASK_DISMISSED",HARD_ASK_ATTEMPTED:"HARD_ASK_ATTEMPTED",HARD_ASK_ALLOWED:"HARD_ASK_ALLOWED",HARD_ASK_DENIED:"HARD_ASK_DENIED",SOFT_ASK_SHOWN:"SOFT_ASK_SHOWN",SOFT_ASK_DISMISSED:"SOFT_ASK_DISMISSED",SOFT_ASK_ALLOWED:"SOFT_ASK_ALLOWED"}},P={TOPIC_NAME:"USER_LIFECYCLE",EVENT_NAMES:{USER_IDENTITY_UPDATE:"USER_IDENTITY_UPDATE",LOGOUT:"LOGOUT"}},N={TOPIC_NAME:"SPA",EVENT_NAMES:{PAGE_CHANGED:"PAGE_CHANGED"}},R="DC_3",M={DC_1:"sdk-01.moengage.com",DC_2:"sdk-02.moengage.com",DC_3:"sdk-03.moengage.com",DC_4:"sdk-04.moengage.com",DC_5:"sdk-05.moengage.com",DC_6:"sdk-06.moengage.com",DC_100:"sdk-100.moengage.com",EU:"sdk-02.moengage.com",IN:"sdk-03.moengage.com"},L={COOKIE_NAME_MAPPING:{USER_DATA:"moe_u_d",SUBSCRIPTION_DETAILS:"moe_s_d",PUSH_TOKEN:"moe_p_t",OPT_IN_SHOWN_TIME:"moe_o_s_t",SOFT_ASK_STATUS:"moe_s_a_s",HARD_ASK_STATUS:"moe_h_a_s",SESSION:"moe_s_n",DEVICE_DATA:"moe_d_d",IDENTITY_MAP:"moe_i_m",SDK_DISABLED:"moe_dis",COOKIE_SHARING:"moe_c_s"},PERMISSION_STATE_MAPPING:{prompt:2,granted:1,dismissed:3,denied:0,shown:4,"not shown":5,allowed:6},SUBSCRIPTION_DETAILS_KEYS:{domain:"d",token:"t",endpoint:"e",keys:"k",p256dh:"p",auth:"a"},USER_DATA_KEYS:{attributes:"a",subscribedToOldSdk:"s_old",deviceUuid:"d_id",deviceAdded:"d_added"},ATTRIBUTE_KEYS:{key:"k",value:"v",updated_at:"u_at",level:"l"},IDENTITY_MAP_KEYS:{userIdentities:"u_i",previousIdentities:"p_i",previousIdentitiesUpdatedTime:"p_i_u_t"},SESSION_KEYS:{sessionKey:"s_k",sessionStartTime:"s_s_t",sessionMaxTime:"s_m_t",customIdentifiersToTrack:"c_i_t_t",sessionExpiryTime:"s_e_t",numberOfSessions:"n_o_s",currentSource:"c_s"},SOURCE_KEYS:{source:"s",medium:"m",source_url:"s_u",term:"t",campaign_name:"c_n",campaign_id:"c_id",content:"c",extra:"e"},DEVICE_DATA_KEYS:{deviceUniqueId:"d_uid"},ENDPOINT_URL_MAPPING:{"https://fcm.googleapis.com/fcm/send/":"f","https://wns2-pn1p.notify.windows.com/w/":"w","https://wns2-sin1p.notify.windows.com/":"w1","https://wns2-bay1p.notify.windows.com/":"w2","https://updates.push.services.mozilla.com/wpush/v2/":"m","https://web.push.apple.com/":"a"}},k={TV:"tv",TABLET:"tablet",MOBILE:"mobile",WEB:"web"},x="Tizen",U="WebOS",B="Xbox",F="viziotv",H="SmartTV",V="number",W="EVENT_ACTION_USER_ATTRIBUTE",G="MOE_WEB_UNSUBSCRIBED",K="EVENT_ACTION_WEB_SESSION_START",q="MOE_PAGE_VIEWED",$="MOE_WEB_OPTIN_BANNER_LOAD",Y="MOE_WEB_OPTIN_CLOSED",j="MOE_WEB_OPTIN_ACCEPTED",z="MOE_OPT_IN_SHOWN",J="MOE_OPT_IN_ALLOWED",Q="MOE_OPT_IN_DISMISSED",X="MOE_OPT_IN_BLOCKED",Z="MOE_OPT_IN_ATTEMPT",ee="MOE_LOGOUT",te="EVENT_ACTION_DEVICE_ATTRIBUTE",ne="MOE_PUSH_PERMISSION_STATE_ALLOWED",ie="MOE_PUSH_PERMISSION_STATE_BLOCKED",ae="MOE_PAGE_EXIT",re="MOE_PAGE_SCROLL",se="MOE_PAGE_URL_EVENT",oe="MOE_EXIT",ce="URL",le="moe_logged_in_status",de="moe_first_visit",ge={MOE_DASHBOARD:"https://dashboard.moengage.com",WEBSDK_DOCS:"https://developers.moengage.com/hc/en-us/articles/360060713252-Web-SDK-Integration",SELF_HANDLED_DOCS:"https://developers.moengage.com/hc/en-us/articles/360061219351-Configure-Self-Handled-Opt-In"},ue="Dashboard --\x3e Settings --\x3e Channel --\x3e Push",pe="moe_uuid",me="moe_uuid",he="MoengagePageEventHistoryManager",fe=["moe-card=1"],Ee="A pop-up has appeared on screen",Se="moe-floating-icon-iframe",_e="moe-floating-icon",ve="web_personalization",ye="onsite_messaging",Te={CARDS:{name:"CARDS",src:"https://cdn.moengage.com/release/dc_3/versions/2.64.00/moe_webSdk_cards.min.latest.js",windowLocation:"moeCards"}},be={USER_DATA:"USER_DATA",PUSH_TOKEN:"PUSH_TOKEN",SUBSCRIPTION_DETAILS:"SUBSCRIPTION_DETAILS",SETUP_TIME:"SETUP_TIME",OPT_IN_SHOWN_TIME:"OPT_IN_SHOWN_TIME",OPTED_STATUS_TRACK_TIME:"OPTED_STATUS_TRACK_TIME",SOFT_ASK_STATUS:"SOFT_ASK_STATUS",HARD_ASK_STATUS:"HARD_ASK_STATUS",WEB_SETTINGS:"WEB_SETTINGS",GRACEFUL_DATA:"GRACEFUL_DATA",Q:{PREFIX:"Q",REPORT:"REPORT",DEVICE:"DEVICE"},INIT_DATA:"INIT_DATA",OLD_SDK:{USER_DATA:"moengage_data",SUBSCRIPTION_DETAILS:"MOE_PUSH_ENDPOINT",PUSH_TOKEN:"MOE_PUSH_TOKEN"},BROWSER_DETAILS:"browserDetails",SESSION:"SESSION",DEVICE_DATA:"DEVICE_DATA",IDENTITY_MAP:"IDENTITY_MAP",SDK_VERSION:"SDK_VERSION",SDK_DISABLED:"SDK_DISABLED",LOGOUT_IN_PROGRESS:"LOGOUT_IN_PROGRESS"},Ie="initData",Ae="browserDetails",we="unifiedLogs",De="hasUserLoggedOut",Ce="landingPageTracking",Oe={EXPIRY_YEARS:2},Pe="COOKIE_SHARING",Ne="moe_tracking",Re="events",Me="moe_database",Le="moe_data",ke=[be.DEVICE_DATA],xe=500,Ue=10,Be=5e3,Fe=["Google Chrome","Mozilla Firefox","Opera","Apple Safari","Edge"];function He(e,t,n){return null!=e&&t?(e=e[(t=Array.isArray(t)?t:t.split("."))[0]])&&t.length>1?He(e,t.slice(1),n):void 0===e?n||null:e:null}function Ve(e,t,n){if(null==e||!t)return void 0!==n?n:void 0;const i=e[(t=Array.isArray(t)?t:t.split("."))[0]];return null!=i&&t.length>1?Ve(i,t.slice(1),n):null==i?void 0!==n?n:void 0:i}class We{static baseLogTag="EphemeralStorage";static set(e,t){We.baseLogTag;window&&(window.moeInternals?(window.moeInternals.ephemeral||(window.moeInternals.ephemeral={}),window.moeInternals.ephemeral[e]=t):(window.moeInternals={},window.moeInternals.ephemeral={},window.moeInternals.ephemeral[e]=t))}static get(e){return He(window,"moeInternals.ephemeral."+e,null)}static clear(){window&&(window.moeInternals={},window.moeInternals.ephemeral={})}}function Ge(){return window[window.moengage_object||"Moengage"]}class Ke{static isTrackingEnabled;static logLevel;static logData(e,t){return{log_type:e,sent_time:(new Date).toISOString(),lake_fields:t}}static setRemoteLogging(e,t){return this.isTrackingEnabled||(this.logLevel=e,this.isTrackingEnabled=t),this.isTrackingEnabled}static log(e,t,n,i,...a){!this.isTrackingEnabled||e!==this.logLevel&&"verbose"!==this.logLevel||Ge().remoteLogs.addRemoteLogs(this.logData(e,{msg:n+[...a].toString(),file_name:t,trace:i}))}}let qe="color: white; background: #41AE55; border-radius: 5px;";class $e{static baseLogTag="Logger";static logBrand="MoEngage";static logLevel=0;static tagLogStyle="color: white; background: #48beab; border-radius: 5px;";static setLogLevel(e,t){const n=$e.baseLogTag+".setLogLevel";null==We.get(we)&&We.set(we,[]),null==e?$e.logLevel=0:e in[0,1,2]?($e.logLevel=e,e>0&&t&&$e.releaseAllLogs()):$e.warn(0,n,"Value",e,"not supported for setDebugLevel(). Current log level is",$e.logLevel,". Debug level can only be [0, 1, 2]")}static setLogTabStyle(e){$e.tagLogStyle=$e.tagLogStyle.replace("#48beab",e)}static log(e,t,n,...i){e<=$e.logLevel?console.log("%c "+$e.logBrand+" %c %c info %c %c "+t+" ",qe,"","color: white; background: #18a0bf; border-radius: 5px;","",$e.tagLogStyle,n,...i):$e.cacheLog(()=>{$e.log(e,t,n,...i)})}static remoteLogTracking(e,t,n,i,...a){Ke.log(t,n,i,...a),this.log(e,n,i,...a)}static error(e,t,n,...i){!i[i.length-1]?.isCached&&Ke.log("error",t,n,...i),e<=$e.logLevel?console.error("%c "+$e.logBrand+" %c %c error %c %c "+t+" ",qe,"","color: white; background: #cc0a0a; border-radius: 5px;","",$e.tagLogStyle,n,...i.slice(0,-1)):$e.cacheLog(()=>{$e.error(e,t,n,...i,{isCached:!0})})}static warn(e,t,n,...i){!i[i.length-1]?.isCached&&Ke.log("warning",t,n,...i),e<=$e.logLevel?console.warn("%c "+$e.logBrand+" %c %c warn %c %c "+t+" ",qe,"","color: white; background: #e8ab51; border-radius: 5px;","",$e.tagLogStyle,n,...i.slice(0,-1)):$e.cacheLog(()=>{$e.warn(e,t,n,...i,{isCached:!0})})}static customLabel(e,t,n,...i){e<=$e.logLevel?console.log("%c "+$e.logBrand+" %c %c "+t+" %c %c "+n+" %c ",qe,"",$e.tagLogStyle,"","color: white; background: #a400ff; border-radius: 5px;","",...i):$e.cacheLog(()=>{$e.customLabel(e,t,n,...i)})}static image(e,t){e<=$e.logLevel?console.log("%c+","font-size: 1px; padding: 20px 80px; line-height: 45px; background: url("+t+"); background-size: 160px 90px; color: transparent;"):$e.cacheLog(()=>{$e.image(e,t)})}static releaseAllLogs(){const e=We.get(we),t=e.length,n=e;if(We.set(we,[]),t>0){$e.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS BEGIN ----\x3e");for(let e=0;e<t;e++)n[e]();$e.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS END ----\x3e")}}static setLogBrand(e){$e.logBrand=e}static setBrandColor(e){qe="color: white; background: "+e+"; border-radius: 5px;"}static cacheLog(e){let t=We.get(we);null==t&&(t=[]),t.push(e),We.set(we,t)}}function Ye(e,t){return!(e!==c&&e!==u&&!t.includes(e))}class je{static baseLogTag="InitData";integrationType;appId;debugLevel=0;cluster=null;environment=null;baseDomainName="https://sdk-01.moengage.com/";inapp=null;swPath;swScope;customSoftAsk=null;forceSwUpdate;disableOnsite;enableSPA;cards;proxyDomains;disableWebPush;disableCookies;disableSdk;projectId;constructor(e){const t=je.baseLogTag+".constructor";null!=He(e,"app_id",null)?(this.appId=He(e,"app_id",null),this.integrationType=ze.OLD_SDK):null!=He(e,"appId",null)?(this.appId=He(e,"appId",null),this.integrationType=ze.NEW_SDK):($e.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",ge.WEBSDK_DOCS),this.integrationType=null),null!=He(e,"debug_logs",null)?this.debugLevel=He(e,"debug_logs",0):null!=He(e,"debugLevel",null)?this.debugLevel=He(e,"debugLevel",0):($e.log(2,t,"No log level config found. Using default value of",0),this.debugLevel=0),this.appId&&(this.baseDomainName="https://sdk-01.moengage.com/",this.forceSwUpdate=He(e,"forceSwUpdate",!1),this.cluster=R,this.cluster=He(e,"cluster",this.cluster),this.cluster&&null!=M[this.cluster.toUpperCase()]&&(this.environment=M[this.cluster.toUpperCase()]),He(e,"environment",null)&&(this.environment=e.environment),this.environment&&(this.baseDomainName="https://"+this.environment+"/"),this.debugLevel>0&&this.appId.indexOf("_DEBUG")<0?this.appId=this.appId+"_DEBUG":0===this.debugLevel&&this.appId.indexOf("_DEBUG")>=0&&(this.appId=this.appId.substr(0,this.appId.indexOf("_DEBUG"))),this.swPath=He(e,"swPath",null),null!=e.customSoftAsk?this.customSoftAsk={mainClass:He(e,"customSoftAsk.mainClass",null),allowClass:He(e,"customSoftAsk.allowClass",null),dismissClass:He(e,"customSoftAsk.dismissClass",null)}:this.customSoftAsk={mainClass:He(e,"main_class",null),allowClass:He(e,"allow_class",null),dismissClass:He(e,"block_class",null)},null!=He(e,"inapp.host",null)&&(this.inapp={host:He(e,"inapp.host",null)}),null!=He(e,"swScope",null)&&(this.swScope=He(e,"swScope",null)),null!=He(e,"disable_onsite",null)&&(this.disableOnsite=He(e,"disable_onsite",!1)),null!=He(e,"enableSPA",null)&&(this.enableSPA=He(e,"enableSPA",!1)),null!=He(e,"cards",null)&&(this.cards=He(e,"cards",{})),null!=He(e,"proxyDomains",null)&&(this.proxyDomains=He(e,"proxyDomains",null),this.proxyDomains.api&&(this.baseDomainName="https://"+this.proxyDomains.api+"/",this.environment=this.proxyDomains.api)),null!=He(e,"disable_web_push",null)&&(this.disableWebPush=He(e,"disable_web_push",!1)),null!=He(e,"disableCookies",null)&&(this.disableCookies=He(e,"disableCookies",!1)),null!=He(e,"disableSdk",null)&&(this.disableSdk=He(e,"disableSdk",!1)),null!=He(e,"project_id",null)&&(this.projectId=He(e,"project_id",null)))}static save(e){We.set(Ie,new je(e)),gn.set(be.INIT_DATA,new je(e))}static get(){return We.get(Ie)}}var ze;!function(e){e.OLD_SDK="OLD_SDK",e.NEW_SDK="NEW_SDK"}(ze||(ze={}));var Je=Uint8Array,Qe=Uint16Array,Xe=Int32Array,Ze=new Je([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),et=new Je([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),tt=new Je([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),nt=function(e,t){for(var n=new Qe(31),i=0;i<31;++i)n[i]=t+=1<<e[i-1];var a=new Xe(n[30]);for(i=1;i<30;++i)for(var r=n[i];r<n[i+1];++r)a[r]=r-n[i]<<5|i;return{b:n,r:a}},it=nt(Ze,2),at=it.b,rt=it.r;at[28]=258,rt[258]=28;for(var st=nt(et,0),ot=st.b,ct=st.r,lt=new Qe(32768),dt=0;dt<32768;++dt){var gt=(43690&dt)>>1|(21845&dt)<<1;gt=(61680&(gt=(52428&gt)>>2|(13107&gt)<<2))>>4|(3855&gt)<<4,lt[dt]=((65280&gt)>>8|(255&gt)<<8)>>1}var ut=function(e,t,n){for(var i=e.length,a=0,r=new Qe(t);a<i;++a)e[a]&&++r[e[a]-1];var s,o=new Qe(t);for(a=1;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(n){s=new Qe(1<<t);var c=15-t;for(a=0;a<i;++a)if(e[a])for(var l=a<<4|e[a],d=t-e[a],g=o[e[a]-1]++<<d,u=g|(1<<d)-1;g<=u;++g)s[lt[g]>>c]=l}else for(s=new Qe(i),a=0;a<i;++a)e[a]&&(s[a]=lt[o[e[a]-1]++]>>15-e[a]);return s},pt=new Je(288);for(dt=0;dt<144;++dt)pt[dt]=8;for(dt=144;dt<256;++dt)pt[dt]=9;for(dt=256;dt<280;++dt)pt[dt]=7;for(dt=280;dt<288;++dt)pt[dt]=8;var mt=new Je(32);for(dt=0;dt<32;++dt)mt[dt]=5;var ht=ut(pt,9,0),ft=ut(pt,9,1),Et=ut(mt,5,0),St=ut(mt,5,1),_t=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},vt=function(e,t,n){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&n},yt=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},Tt=function(e){return(e+7)/8|0},bt=function(e,t,n){return(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length),new Je(e.subarray(t,n))},It=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],At=function(e,t,n){var i=new Error(t||It[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,At),!n)throw i;return i},wt=function(e,t,n,i){var a=e.length,r=i?i.length:0;if(!a||t.f&&!t.l)return n||new Je(0);var s=!n,o=s||2!=t.i,c=t.i;s&&(n=new Je(3*a));var l=function(e){var t=n.length;if(e>t){var i=new Je(Math.max(2*t,e));i.set(n),n=i}},d=t.f||0,g=t.p||0,u=t.b||0,p=t.l,m=t.d,h=t.m,f=t.n,E=8*a;do{if(!p){d=vt(e,g,1);var S=vt(e,g+1,3);if(g+=3,!S){var _=e[(P=Tt(g)+4)-4]|e[P-3]<<8,v=P+_;if(v>a){c&&At(0);break}o&&l(u+_),n.set(e.subarray(P,v),u),t.b=u+=_,t.p=g=8*v,t.f=d;continue}if(1==S)p=ft,m=St,h=9,f=5;else if(2==S){var y=vt(e,g,31)+257,T=vt(e,g+10,15)+4,b=y+vt(e,g+5,31)+1;g+=14;for(var I=new Je(b),A=new Je(19),w=0;w<T;++w)A[tt[w]]=vt(e,g+3*w,7);g+=3*T;var D=_t(A),C=(1<<D)-1,O=ut(A,D,1);for(w=0;w<b;){var P,N=O[vt(e,g,C)];if(g+=15&N,(P=N>>4)<16)I[w++]=P;else{var R=0,M=0;for(16==P?(M=3+vt(e,g,3),g+=2,R=I[w-1]):17==P?(M=3+vt(e,g,7),g+=3):18==P&&(M=11+vt(e,g,127),g+=7);M--;)I[w++]=R}}var L=I.subarray(0,y),k=I.subarray(y);h=_t(L),f=_t(k),p=ut(L,h,1),m=ut(k,f,1)}else At(1);if(g>E){c&&At(0);break}}o&&l(u+131072);for(var x=(1<<h)-1,U=(1<<f)-1,B=g;;B=g){var F=(R=p[yt(e,g)&x])>>4;if((g+=15&R)>E){c&&At(0);break}if(R||At(2),F<256)n[u++]=F;else{if(256==F){B=g,p=null;break}var H=F-254;if(F>264){var V=Ze[w=F-257];H=vt(e,g,(1<<V)-1)+at[w],g+=V}var W=m[yt(e,g)&U],G=W>>4;W||At(3),g+=15&W;k=ot[G];if(G>3){V=et[G];k+=yt(e,g)&(1<<V)-1,g+=V}if(g>E){c&&At(0);break}o&&l(u+131072);var K=u+H;if(u<k){var q=r-k,$=Math.min(k,K);for(q+u<0&&At(3);u<$;++u)n[u]=i[q+u]}for(;u<K;++u)n[u]=n[u-k]}}t.l=p,t.p=B,t.b=u,t.f=d,p&&(d=1,t.m=h,t.d=m,t.n=f)}while(!d);return u!=n.length&&s?bt(n,0,u):n.subarray(0,u)},Dt=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8},Ct=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8,e[i+2]|=n>>16},Ot=function(e,t){for(var n=[],i=0;i<e.length;++i)e[i]&&n.push({s:i,f:e[i]});var a=n.length,r=n.slice();if(!a)return{t:xt,l:0};if(1==a){var s=new Je(n[0].s+1);return s[n[0].s]=1,{t:s,l:1}}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var o=n[0],c=n[1],l=0,d=1,g=2;for(n[0]={s:-1,f:o.f+c.f,l:o,r:c};d!=a-1;)o=n[n[l].f<n[g].f?l++:g++],c=n[l!=d&&n[l].f<n[g].f?l++:g++],n[d++]={s:-1,f:o.f+c.f,l:o,r:c};var u=r[0].s;for(i=1;i<a;++i)r[i].s>u&&(u=r[i].s);var p=new Qe(u+1),m=Pt(n[d-1],p,0);if(m>t){i=0;var h=0,f=m-t,E=1<<f;for(r.sort(function(e,t){return p[t.s]-p[e.s]||e.f-t.f});i<a;++i){var S=r[i].s;if(!(p[S]>t))break;h+=E-(1<<m-p[S]),p[S]=t}for(h>>=f;h>0;){var _=r[i].s;p[_]<t?h-=1<<t-p[_]++-1:++i}for(;i>=0&&h;--i){var v=r[i].s;p[v]==t&&(--p[v],++h)}m=t}return{t:new Je(p),l:m}},Pt=function(e,t,n){return-1==e.s?Math.max(Pt(e.l,t,n+1),Pt(e.r,t,n+1)):t[e.s]=n},Nt=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new Qe(++t),i=0,a=e[0],r=1,s=function(e){n[i++]=e},o=1;o<=t;++o)if(e[o]==a&&o!=t)++r;else{if(!a&&r>2){for(;r>138;r-=138)s(32754);r>2&&(s(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(s(a),--r;r>6;r-=6)s(8304);r>2&&(s(r-3<<5|8208),r=0)}for(;r--;)s(a);r=1,a=e[o]}return{c:n.subarray(0,i),n:t}},Rt=function(e,t){for(var n=0,i=0;i<t.length;++i)n+=e[i]*t[i];return n},Mt=function(e,t,n){var i=n.length,a=Tt(t+2);e[a]=255&i,e[a+1]=i>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var r=0;r<i;++r)e[a+r+4]=n[r];return 8*(a+4+i)},Lt=function(e,t,n,i,a,r,s,o,c,l,d){Dt(t,d++,n),++a[256];for(var g=Ot(a,15),u=g.t,p=g.l,m=Ot(r,15),h=m.t,f=m.l,E=Nt(u),S=E.c,_=E.n,v=Nt(h),y=v.c,T=v.n,b=new Qe(19),I=0;I<S.length;++I)++b[31&S[I]];for(I=0;I<y.length;++I)++b[31&y[I]];for(var A=Ot(b,7),w=A.t,D=A.l,C=19;C>4&&!w[tt[C-1]];--C);var O,P,N,R,M=l+5<<3,L=Rt(a,pt)+Rt(r,mt)+s,k=Rt(a,u)+Rt(r,h)+s+14+3*C+Rt(b,w)+2*b[16]+3*b[17]+7*b[18];if(c>=0&&M<=L&&M<=k)return Mt(t,d,e.subarray(c,c+l));if(Dt(t,d,1+(k<L)),d+=2,k<L){O=ut(u,p,0),P=u,N=ut(h,f,0),R=h;var x=ut(w,D,0);Dt(t,d,_-257),Dt(t,d+5,T-1),Dt(t,d+10,C-4),d+=14;for(I=0;I<C;++I)Dt(t,d+3*I,w[tt[I]]);d+=3*C;for(var U=[S,y],B=0;B<2;++B){var F=U[B];for(I=0;I<F.length;++I){var H=31&F[I];Dt(t,d,x[H]),d+=w[H],H>15&&(Dt(t,d,F[I]>>5&127),d+=F[I]>>12)}}}else O=ht,P=pt,N=Et,R=mt;for(I=0;I<o;++I){var V=i[I];if(V>255){Ct(t,d,O[(H=V>>18&31)+257]),d+=P[H+257],H>7&&(Dt(t,d,V>>23&31),d+=Ze[H]);var W=31&V;Ct(t,d,N[W]),d+=R[W],W>3&&(Ct(t,d,V>>5&8191),d+=et[W])}else Ct(t,d,O[V]),d+=P[V]}return Ct(t,d,O[256]),d+P[256]},kt=new Xe([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),xt=new Je(0),Ut=function(e,t,n,i,a,r){var s=r.z||e.length,o=new Je(i+s+5*(1+Math.ceil(s/7e3))+a),c=o.subarray(i,o.length-a),l=r.l,d=7&(r.r||0);if(t){d&&(c[0]=r.r>>3);for(var g=kt[t-1],u=g>>13,p=8191&g,m=(1<<n)-1,h=r.p||new Qe(32768),f=r.h||new Qe(m+1),E=Math.ceil(n/3),S=2*E,_=function(t){return(e[t]^e[t+1]<<E^e[t+2]<<S)&m},v=new Xe(25e3),y=new Qe(288),T=new Qe(32),b=0,I=0,A=r.i||0,w=0,D=r.w||0,C=0;A+2<s;++A){var O=_(A),P=32767&A,N=f[O];if(h[P]=N,f[O]=P,D<=A){var R=s-A;if((b>7e3||w>24576)&&(R>423||!l)){d=Lt(e,c,0,v,y,T,I,w,C,A-C,d),w=b=I=0,C=A;for(var M=0;M<286;++M)y[M]=0;for(M=0;M<30;++M)T[M]=0}var L=2,k=0,x=p,U=P-N&32767;if(R>2&&O==_(A-U))for(var B=Math.min(u,R)-1,F=Math.min(32767,A),H=Math.min(258,R);U<=F&&--x&&P!=N;){if(e[A+L]==e[A+L-U]){for(var V=0;V<H&&e[A+V]==e[A+V-U];++V);if(V>L){if(L=V,k=U,V>B)break;var W=Math.min(U,V-2),G=0;for(M=0;M<W;++M){var K=A-U+M&32767,q=K-h[K]&32767;q>G&&(G=q,N=K)}}}U+=(P=N)-(N=h[P])&32767}if(k){v[w++]=268435456|rt[L]<<18|ct[k];var $=31&rt[L],Y=31&ct[k];I+=Ze[$]+et[Y],++y[257+$],++T[Y],D=A+L,++b}else v[w++]=e[A],++y[e[A]]}}for(A=Math.max(A,D);A<s;++A)v[w++]=e[A],++y[e[A]];d=Lt(e,c,l,v,y,T,I,w,C,A-C,d),l||(r.r=7&d|c[d/8|0]<<3,d-=7,r.h=f,r.p=h,r.i=A,r.w=D)}else{for(A=r.w||0;A<s+l;A+=65535){var j=A+65535;j>=s&&(c[d/8|0]=l,j=s),d=Mt(c,d+1,e.subarray(A,j))}r.i=s}return bt(o,0,i+Tt(d)+a)},Bt=function(e,t,n,i,a){if(!a&&(a={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),s=new Je(r.length+e.length);s.set(r),s.set(e,r.length),e=s,a.w=r.length}return Ut(e,null==t.level?6:t.level,null==t.mem?a.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,n,i,a)};function Ft(e,t){return Bt(e,t||{},0,0)}function Ht(e,t){return wt(e,{i:2},t&&t.out,t&&t.dictionary)}var Vt="undefined"!=typeof TextEncoder&&new TextEncoder,Wt="undefined"!=typeof TextDecoder&&new TextDecoder;try{Wt.decode(xt,{stream:!0})}catch(e){}var Gt=function(e){for(var t="",n=0;;){var i=e[n++],a=(i>127)+(i>223)+(i>239);if(n+a>e.length)return{s:t,r:bt(e,n-1)};a?3==a?(i=((15&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t+=String.fromCharCode(55296|i>>10,56320|1023&i)):t+=1&a?String.fromCharCode((31&i)<<6|63&e[n++]):String.fromCharCode((15&i)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(i)}};function Kt(e,t){if(t){for(var n=new Je(e.length),i=0;i<e.length;++i)n[i]=e.charCodeAt(i);return n}if(Vt)return Vt.encode(e);var a=e.length,r=new Je(e.length+(e.length>>1)),s=0,o=function(e){r[s++]=e};for(i=0;i<a;++i){if(s+5>r.length){var c=new Je(s+8+(a-i<<1));c.set(r),r=c}var l=e.charCodeAt(i);l<128||t?o(l):l<2048?(o(192|l>>6),o(128|63&l)):l>55295&&l<57344?(o(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++i))>>18),o(128|l>>12&63),o(128|l>>6&63),o(128|63&l)):(o(224|l>>12),o(128|l>>6&63),o(128|63&l))}return bt(r,0,s)}function qt(e,t){if(t){for(var n="",i=0;i<e.length;i+=16384)n+=String.fromCharCode.apply(null,e.subarray(i,i+16384));return n}if(Wt)return Wt.decode(e);var a=Gt(e),r=a.s;return(n=a.r).length&&At(8),r}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;function $t(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";const n=atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);return qt(Ht(i))}catch(e){return null}}function Yt(e){if("undefined"==typeof document)return null;const t=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){const i=n[e].trim();if(0===i.indexOf(t)){const e=i.substring(t.length);try{return decodeURIComponent(e)}catch(t){return e}}}return null}const{SUBSCRIPTION_DETAILS_KEYS:jt,USER_DATA_KEYS:zt,ATTRIBUTE_KEYS:Jt,IDENTITY_MAP_KEYS:Qt,SESSION_KEYS:Xt,SOURCE_KEYS:Zt,DEVICE_DATA_KEYS:en}=L;function tn(e){if(!e)return e;const{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:s}=jt,o={};return e[t]&&(o.domain=e[t]),e[n]&&(o.token=e[n]),e[i]&&("string"==typeof e[i]&&e[i].startsWith("h://")?o.endpoint=e[i].replace("h://","https://"):o.endpoint=e[i]),e[a]&&(o.keys={},e[a][r]&&(o.keys.p256dh=e[a][r]),e[a][s]&&(o.keys.auth=e[a][s])),o}function nn(e){if(!e)return e;const{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=zt,{key:r,value:s,updated_at:o,level:c}=Jt,l={};return e.attributes&&(l[t]=e.attributes.map(e=>{const t={};return e.key&&(t[r]=function(e){const t=f.find(t=>t.attributeName===e);return t?t.moeName:e}(e.key)),void 0!==e.value&&(t[s]=e.value),void 0!==e.updated_at&&(t[o]=e.updated_at),void 0!==e.level&&(t[c]=e.level),t})),void 0!==e.subscribedToOldSdk&&(l[n]=e.subscribedToOldSdk),e.deviceUuid&&(l[i]=e.deviceUuid),void 0!==e.deviceAdded&&(l[a]=e.deviceAdded),l}function an(e){if(!e)return e;const{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=zt,{key:r,value:s,updated_at:o,level:c}=Jt,l={};return e[t]&&(l.attributes=e[t].map(e=>{const t={};return e[r]&&(t.key=function(e){const t=f.find(t=>t.moeName===e);return t?t.attributeName:e}(e[r])),void 0!==e[s]&&(t.value=e[s]),void 0!==e[o]&&(t.updated_at=e[o]),void 0!==e[c]&&(t.level=e[c]),t})),void 0!==e[n]&&(l.subscribedToOldSdk=e[n]),e[i]&&(l.deviceUuid=e[i]),void 0!==e[a]&&(l.deviceAdded=e[a]),l}function rn(e){if(!e)return e;const{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=Qt,a={};return e[t]&&(a.userIdentities=e[t]),e[n]&&(a.previousIdentities=e[n]),void 0!==e[i]&&(a.previousIdentitiesUpdatedTime=e[i]),a}function sn(e){if(!e)return e;const{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:s,currentSource:o}=Xt,c={};return e.sessionKey&&(c[t]=e.sessionKey),e.sessionStartTime&&(c[n]=e.sessionStartTime),void 0!==e.sessionMaxTime&&(c[i]=e.sessionMaxTime),e.customIdentifiersToTrack&&(c[a]=e.customIdentifiersToTrack),void 0!==e.sessionExpiryTime&&(c[r]=e.sessionExpiryTime),void 0!==e.numberOfSessions&&(c[s]=e.numberOfSessions),e.currentSource&&(c[o]=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:s,content:o,extra:c}=Zt,l={};e.source&&(l[t]=e.source);e.medium&&(l[n]=e.medium);e.source_url&&(l[i]=e.source_url);e.term&&(l[a]=e.term);e.campaign_name&&(l[r]=e.campaign_name);e.campaign_id&&(l[s]=e.campaign_id);e.content&&(l[o]=e.content);e.extra&&(l[c]=e.extra);return l}(e.currentSource)),c}function on(e){if(!e)return e;const{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:s,currentSource:o}=Xt,c={};return e[t]&&(c.sessionKey=e[t]),e[n]&&(c.sessionStartTime=e[n]),void 0!==e[i]&&(c.sessionMaxTime=e[i]),e[a]&&(c.customIdentifiersToTrack=e[a]),void 0!==e[r]&&(c.sessionExpiryTime=e[r]),void 0!==e[s]&&(c.numberOfSessions=e[s]),e[o]&&(c.currentSource=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:s,content:o,extra:c}=Zt,l={};e[t]&&(l.source=e[t]);e[n]&&(l.medium=e[n]);e[i]&&(l.source_url=e[i]);e[a]&&(l.term=e[a]);e[r]&&(l.campaign_name=e[r]);e[s]&&(l.campaign_id=e[s]);e[o]&&(l.content=e[o]);e[c]&&(l.extra=e[c]);return l}(e[o])),c}class cn{static REVERSE_ENDPOINT_URL_MAPPING=Object.fromEntries(Object.entries(L.ENDPOINT_URL_MAPPING).map(([e,t])=>[t,e]));static REVERSE_COOKIE_NAME_MAPPING=Object.fromEntries(Object.entries(L.COOKIE_NAME_MAPPING).map(([e,t])=>[t,e]));static getCompressedKeyName(e){return L.COOKIE_NAME_MAPPING[e]||e}static getOriginalName(e){return cn.REVERSE_COOKIE_NAME_MAPPING[e]||e}static getCookieVersion(e,t){if([L.COOKIE_NAME_MAPPING[Pe],L.COOKIE_NAME_MAPPING[be.HARD_ASK_STATUS],L.COOKIE_NAME_MAPPING[be.SOFT_ASK_STATUS],pe,L.COOKIE_NAME_MAPPING[be.OPT_IN_SHOWN_TIME],L.COOKIE_NAME_MAPPING[be.SDK_DISABLED]].includes(e))return 3;if(Object.keys(L.COOKIE_NAME_MAPPING).includes(e))return 1;if(Object.values(L.COOKIE_NAME_MAPPING).includes(e))try{let n;try{if(n=JSON.parse(t),cn.hasV3Structure(n,e))return 3;if("string"==typeof n){const e=$t(n);if(null!==e)try{JSON.parse(e);return 3}catch(e){}}return 2}catch(e){const i=$t(t);if(null!==i)try{return n=JSON.parse(i),3}catch(e){return 2}return 2}}catch(e){return 2}return 1}static hasV3Structure(e,t){if(!e||"object"!=typeof e)return!1;switch(cn.getOriginalName(t)){case be.SUBSCRIPTION_DETAILS:return e.e&&"string"==typeof e.e&&e.e.length<=2;case be.USER_DATA:return e.d_uid||e.a&&!Array.isArray(e.a)||!e.hasOwnProperty("a");case be.IDENTITY_MAP:return!e.hasOwnProperty("p_i")||!e.hasOwnProperty("p_i_u_t");case be.SESSION:return e.s_s_t&&"number"==typeof e.s_s_t;default:return!1}}static getAllCookieNames(e){const t=[e],n=L.COOKIE_NAME_MAPPING[e];return n&&n!==e&&t.push(n),t}static compressValue(e,t){if(null==e)return e;if("object"!=typeof e||Array.isArray(e))return"boolean"!=typeof e||t!==be.SDK_DISABLED&&t!==Pe?"string"==typeof e&&Object.keys(L.PERMISSION_STATE_MAPPING).includes(e)?L.PERMISSION_STATE_MAPPING[e]:e:e?1:0;const n=cn.compressObjectV3(e,t);if(null===n)return null;const i=JSON.stringify(n),a=function(e){try{const t=Ft(Kt(e));let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}catch(e){return null}}(i);if(null!==a){const e=encodeURIComponent(i).length;if(a.length<e){if($t(a)===i)return a}}return n}static decompressValue(e,t,n){if(null==e)return e;if(void 0===n){const i=cn.getCompressedKeyName(t);n="string"==typeof e?cn.getCookieVersion(i,e):2}if((3===n||void 0===n)&&"string"==typeof e){const i=$t(e);if(null!==i)try{const e=JSON.parse(i);return cn.decompressObjectV3(e,t)}catch(e){n=2}}if(1===n&&cn.isLegacyValue(e))return"string"===e.MOE_DATA_TYPE?e.actualValue?String(e.actualValue):null:(e.MOE_DATA_TYPE,e.actualValue);if(!("number"!=typeof e||0!==e&&1!==e||t!==be.SDK_DISABLED&&t!==Pe))return 1===e;if("number"==typeof e&&e>=0&&e<=6&&(t===be.SOFT_ASK_STATUS||t===be.HARD_ASK_STATUS))return Object.keys(L.PERMISSION_STATE_MAPPING).find(t=>L.PERMISSION_STATE_MAPPING[t]===e);if("object"==typeof e&&!Array.isArray(e)){if(void 0===n||2===n){const n=cn.getCompressedKeyName(t);if(cn.hasV3Structure(e,n))return cn.decompressObjectV3(e,t)}return 3===n?cn.decompressObjectV3(e,t):cn.decompressObject(e,t)}return e}static compressObjectV3(e,t){if(!e)return e;switch(t){case be.SUBSCRIPTION_DETAILS:return cn.compressSubscriptionDetailsV3(e);case be.USER_DATA:return cn.compressUserDataV3(e);case be.IDENTITY_MAP:return cn.compressIdentityMapV3(e);case be.SESSION:return cn.compressSessionV3(e);case be.DEVICE_DATA:return null;default:return e}}static compressSubscriptionDetailsV3(e){const t=function(e){if(!e)return e;const{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:s}=jt,o={};return e.domain&&(o[t]=e.domain),e.token&&(o[n]=e.token),e.endpoint&&(o[i]=e.endpoint),e.keys&&(o[a]={},e.keys.p256dh&&(o[a][r]=e.keys.p256dh),e.keys.auth&&(o[a][s]=e.keys.auth)),o}(e);if(t.e&&"string"==typeof t.e){const e=L.ENDPOINT_URL_MAPPING[t.e];e&&(t.e=e)}return t}static compressUserDataV3(e){const t=nn(e);if(!t.d_uid){const e=cn.getDeviceDataForMigration();e&&e.deviceUniqueId&&(t.d_uid=e.deviceUniqueId)}if(t.d_id&&delete t.d_id,t.a&&Array.isArray(t.a)&&0===t.a.length&&delete t.a,t.a&&Array.isArray(t.a)&&t.a.length>0){const e={};t.a.forEach(t=>{if(t.k&&void 0!==t.v){const n=t.l?`${t.k}_p_attr`:t.k;e[n]={v:t.v,u_at:t.u_at,l:t.l||void 0}}}),t.a=e}return t}static compressIdentityMapV3(e){const t=function(e){if(!e)return e;const{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=Qt,a={};return e.userIdentities&&(a[t]=e.userIdentities),e.previousIdentities&&(a[n]=e.previousIdentities),void 0!==e.previousIdentitiesUpdatedTime&&(a[i]=e.previousIdentitiesUpdatedTime),a}(e);return t.p_i&&0!==Object.keys(t.p_i).length||0!==t.p_i_u_t||(delete t.p_i,delete t.p_i_u_t),t}static compressSessionV3(e){const t=sn(e);if(t.s_s_t&&"string"==typeof t.s_s_t){const e=new Date(t.s_s_t).getTime();t.s_s_t=e}return t}static decompressObject(e,t){if(!e)return e;switch(t){case be.SUBSCRIPTION_DETAILS:return tn(e);case be.USER_DATA:return an(e);case be.IDENTITY_MAP:return rn(e);case be.SESSION:return on(e);case be.DEVICE_DATA:return function(e){if(!e)return e;const{deviceUniqueId:t}=en,n={};return e[t]&&(n.deviceUniqueId=e[t]),n}(e);default:return e}}static decompressObjectV3(e,t){if(!e)return e;switch(t){case be.SUBSCRIPTION_DETAILS:return cn.decompressSubscriptionDetailsV3(e);case be.USER_DATA:return cn.decompressUserDataV3(e);case be.IDENTITY_MAP:return cn.decompressIdentityMapV3(e);case be.SESSION:return cn.decompressSessionV3(e);case be.DEVICE_DATA:return cn.getDeviceDataFromUserData();default:return e}}static decompressSubscriptionDetailsV3(e){const t={...e};if(t.e&&"string"==typeof t.e){const e=cn.REVERSE_ENDPOINT_URL_MAPPING[t.e];e&&(t.e=e)}return tn(t)}static decompressUserDataV3(e,t){const n={...e},i=!n.hasOwnProperty("a");if(n.a&&"object"==typeof n.a&&!Array.isArray(n.a)){const e=Object.entries(n.a).map(([e,t])=>{const n=void 0!==t.l,i=e.endsWith("_p_attr");return{k:n&&i?e.slice(0,-7):e,v:t.v,u_at:t.u_at||(new Date).getTime(),l:t.l||void 0}});n.a=e}i&&(n.a=[]);const a=an(n);if(!a.deviceUuid){const e=Yt("moe_uuid");e&&(a.deviceUuid=e)}return a}static decompressIdentityMapV3(e){const t={...e};return t.hasOwnProperty("p_i")||(t.p_i={}),t.hasOwnProperty("p_i_u_t")||(t.p_i_u_t=0),rn(t)}static decompressSessionV3(e){const t={...e};return t.s_s_t&&"number"==typeof t.s_s_t&&(t.s_s_t=new Date(t.s_s_t).toISOString()),on(t)}static getDeviceDataForMigration(){if("undefined"==typeof localStorage)return null;try{const e=localStorage.getItem("MOE_DATA");if(e){const t=JSON.parse(e);if(t&&t.DEVICE_DATA&&t.DEVICE_DATA.deviceUniqueId)return t.DEVICE_DATA}}catch(e){}return null}static getDeviceDataFromUserData(){const e=cn.getAllCookieNames(be.USER_DATA);for(const t of e){const e=Yt(t);if(null!==e)try{let t=JSON.parse(e);if("string"==typeof t){const e=$t(t);null!==e&&(t=JSON.parse(e))}if(t.d_uid)return{deviceUniqueId:t.d_uid};const n=cn.decompressUserDataV3(t);if(n.deviceUuid)return{deviceUniqueId:n.deviceUuid}}catch(e){continue}}return null}static isCompressedCookie(e){return e.startsWith("moe_")&&Object.values(L.COOKIE_NAME_MAPPING).includes(e)}static isLegacyValue(e){return"object"==typeof e&&null!==e&&e.hasOwnProperty("MOE_DATA_TYPE")&&e.hasOwnProperty("actualValue")}}class ln{static baseTag="CookieStorage";static set(e,t){if(je.get()?.disableCookies)return;const n=ln.baseTag+".set";if(null==t)ln.remove(e);else{if(e===be.PUSH_TOKEN)return void $e.log(2,n,"Skipping PUSH_TOKEN as it is redundant with SUBSCRIPTION_DETAILS");if(e===be.DEVICE_DATA)return;const i=cn.compressValue(t,e),a=cn.getCompressedKeyName(e);let r;ln.cleanupOldVersions(e,a),r="string"==typeof i?i:"object"==typeof i&&null!==i?JSON.stringify(i):String(i);const s=Date.now(),o=";expires="+new Date(s+31536e6*Oe.EXPIRY_YEARS).toUTCString();document.cookie=a+"="+encodeURIComponent(r)+o+";domain="+ln.getOrigin()+ln.getCookieFlags()}}static get(e){if(je.get()?.disableCookies)return;const t=cn.getAllCookieNames(e);let n=null,i=null,a=1;for(const e of t)if(n=ln.getCookieValue(e),null!==n){i=e,a=cn.getCookieVersion(e,n);break}if(null===n)return null;const r=ln.processParseValue(n,e,a>1,a);return i&&a<3&&ln.migrateToV3(e,r,i),r}static migrateToV3(e,t,n){const i=ln.baseTag+".migrateToV3";try{ln.set(e,t),ln.removeSpecificCookie(n)}catch(e){$e.error(2,i,`Failed to migrate cookie ${n} to V3:`,e)}}static cleanupOldVersions(e,t){cn.getAllCookieNames(e).forEach(e=>{const t=ln.getCookieValue(e);if(null!==t){cn.getCookieVersion(e,t)<3&&ln.removeSpecificCookie(e)}})}static removeSpecificCookie(e){document.cookie=e+"=;domain="+ln.getOrigin()+";expires=Thu, 01 Jan 1970 00:00:01 GMT"+ln.getCookieFlags()}static getCookieValue(e){const t=e+"=",n=ln.getDecodedCookies();for(let e=n.length-1;e>=0;e--){let i=n[e];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null}static processParseValue(e,t,n,i){const a="MOE_DATA_TYPE",r="actualValue";try{let s;try{s=JSON.parse(e)}catch(t){s=e}cn.isLegacyValue(s)?"string"===He(s,a,null)?e=(e=He(s,r,null))?String(e):null:"boolean"===He(s,a,null)&&(e=He(s,r,null)):e=n?cn.decompressValue(s,t,i):s}catch(e){}return e}static remove(e){if(je.get()?.disableCookies)return;cn.getAllCookieNames(e).forEach(e=>{ln.removeSpecificCookie(e)})}static setRaw(e,t,n){if(je.get()?.disableCookies)return;ln.baseTag;if(null==t)ln.remove(e);else{let i="";null!=n&&(i=";expires="+n.toISOString()),document.cookie=e+"="+encodeURIComponent(t)+i+";domain="+ln.getOrigin()+ln.getCookieFlags()}}static getOrigin(){if(je.get()?.disableCookies)return"";const e=ln.baseTag+".getOrigin",t=window.location.hostname;if("localhost"===t||"127.0.0.1"===t)return $e.warn(1,e,"Cross domain user persistence will not work with localhost. \n\nWe will save the key-value pairs in the localhost cookie store for reference. You'll be able to test this functionality in a hosted staging/test environment."),"";const n=t.split(".");if(n.length<=1||2===n.length)return"."+t;const i=n[n.length-1],a=n[n.length-2],r=2===i.length,s=a.length>=2&&a.length<=3,o=r&&s;return 3===n.length?o?"."+t:"."+n.slice(-2).join("."):n.length>=4?o?"."+n.slice(-3).join("."):"."+n.slice(-2).join("."):void 0}static getCookieFlags(){return"https:"===window.location.protocol||"chrome-extension:"===window.location.protocol?";path=/;SameSite=None;Secure":";path=/;"}static getDecodedCookies(){const e=ln.baseTag+".getDecodedCookies";return document.cookie.split(";").map(t=>{let n=t.trim();"%"===n.slice(-1)&&(n+="25");try{return decodeURIComponent(n)}catch(t){return $e.error(2,e,"Error decoding cookie:",n,t),n}})}}const dn="MOE_DATA";class gn{static baseLogTag="PersistentStorage";static prefix="";static isSharedWithCookie=!1;static KEYS_SHARED_WITH_COOKIE=[be.USER_DATA,be.SUBSCRIPTION_DETAILS,be.SOFT_ASK_STATUS,be.OPT_IN_SHOWN_TIME,be.HARD_ASK_STATUS,be.SESSION,be.DEVICE_DATA,be.IDENTITY_MAP,be.SDK_DISABLED];static moeDataStore;static setPrefix(e){gn.prefix=e+"_"}static set(e,t){gn.baseLogTag;if(e=gn.prefix+e,localStorage){const n=gn.getMoeData();n[e]=t,localStorage.setItem(dn,JSON.stringify(n))}const n=gn.KEYS_SHARED_WITH_COOKIE.indexOf(e);if(gn.isSharedWithCookie&&n>=0){const i="object"!=typeof t||Array.isArray(t)?t:{...t};if(0===n&&Array.isArray(i.attributes)){const e=gn.get(be.WEB_SETTINGS);i.attributes=i.attributes.filter(t=>!!this.isPushBillingOrIdentityAttribute(t.key,e))}e===be.SUBSCRIPTION_DETAILS&&(i.domain=t.domain,i.token=t.token,i.endpoint=t.endpoint,i.keys=t.keys),ln.set(e,i)}}static get(e){gn.baseLogTag;if(e=gn.prefix+e,localStorage){return He(gn.getMoeData(),e,null)}return null}static remove(e){const t=gn.baseLogTag+".remove",n=gn.prefix+e;if(localStorage&&null!=gn.get(e)){const i=gn.getMoeData();delete i[n],localStorage.setItem(dn,JSON.stringify(i)),$e.log(2,t,"Key",e,"removed.")}gn.isSharedWithCookie&&gn.KEYS_SHARED_WITH_COOKIE.indexOf(e)>=0&&ln.remove(e)}static logout(){const e=["INIT_DATA","Q","WEB_SETTINGS","SUBSCRIPTION_DETAILS","PUSH_TOKEN","GRACEFUL_DATA","DEVICE_DATA","SDK_VERSION","SDK_DISABLED"];for(const t in be){if([be.HARD_ASK_STATUS,be.SOFT_ASK_STATUS].includes(t)){const e=gn.get(be.SUBSCRIPTION_DETAILS);if(e&&e.domain!==window.location.origin)continue}e.indexOf(t)<0&&gn.remove(be[t])}for(const e in be.Q)un.purge(e)}static getString(e){if(e=gn.prefix+e,localStorage){const t=gn.get(e);return"string"==typeof t||t instanceof String?t:JSON.stringify(t)}}static removePrefix(){gn.prefix=""}static copyKeysFromCookie(){let e=null;for(let t=0;t<gn.KEYS_SHARED_WITH_COOKIE.length;t++){const n=gn.KEYS_SHARED_WITH_COOKIE[t],i=ln.get(n);if(null!=i){const t="object"!=typeof i||Array.isArray(i)?i:{...i};if(n===be.USER_DATA){const i=gn.get(n)&&gn.get(n).attributes;if(Array.isArray(t.attributes)&&Array.isArray(i)&&i.length>0){let e=[...i];t.attributes.forEach(t=>{const n=e.findIndex(e=>e.key===t.key&&e.level===t.level);n>=0?e[n]=t:e.push(t)});const n=gn.get(be.WEB_SETTINGS);e=e.filter(e=>{if(this.isPushBillingOrIdentityAttribute(e.key,n)){if(t.attributes.findIndex(t=>t.key===e.key&&t.level===e.level)<0)return!1}return!0}),t.attributes=e}t.d_uid&&(e={deviceUniqueId:t.d_uid},delete t.d_uid)}else n===be.DEVICE_DATA&&(e=t);gn.set(n,t)}}e&&gn.set(be.DEVICE_DATA,e),ln.get(be.PUSH_TOKEN)&&ln.remove(be.PUSH_TOKEN),gn.removeStaleKeysFromLS(),gn.copyIdentitiesFromCookiesToIDB()}static isPushBillingOrIdentityAttribute(e,t){const n=t?.configs?.identityAttributes||[],i=t?.configs?.subscriberBasedBillingAttributes||[];return!!(t?.isPushSubBilling&&Ye(e,i)||h.includes(e)||n.includes(f.find(t=>t.attributeName===e)?.moeName||e))}static copyIdentitiesFromCookiesToIDB(){const e=`${this.baseLogTag}.copyIdentitiesFromCookiesToIDB`,n=ln.get(be.IDENTITY_MAP),i=ln.get(be.USER_DATA),a={};if(n?.userIdentities){const{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:i}=n;a.userIdentities=e,a.previousIdentities=t,a.previousIdentitiesUpdatedTime=i}i?.attributes?.length&&i.attributes.find(e=>e.key===o)&&(a.moe_user_id=i.attributes.find(e=>e.key===o).value),this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:"moe_database",storeName:"moe_data"}),this.moeDataStore&&(this.moeDataStore.setItem(S,a),$e.log(2,e,"Copied identities from cookie to IndexedDB")))}static removeStaleKeysFromLS(){const e=gn.baseLogTag+".removeStaleKeysFromLS";try{Object.keys(gn.getMoeData()).forEach(e=>{const t=ln.get(e);!this.KEYS_SHARED_WITH_COOKIE.includes(e)||ke.includes(e)||t||!1===t||gn.remove(e)})}catch(t){$e.error(1,e,t)}}static getMoeData(){const e=gn.baseLogTag+".getMoeData";let t=localStorage.getItem(dn);if(null==t)return{};try{return t=JSON.parse(t),t}catch(t){return $e.error(1,e,t),{}}}}class un{static baseLogTag="LocalQ";items;constructor(){this.items=[]}static enqueue(e,t){const n=un.getLocalStorageQName(e);let i=new un;gn.get(n)&&(i=gn.get(n)),i.items.push(t),i.items=i.items.slice(Math.max(i.items.length-50,0)),gn.set(n,i)}static dequeue(e){const t=un.getLocalStorageQName(e),n=gn.get(t);let i=null;return n&&n.items.length>0&&(i=n.items[0],n.items.splice(0,1),gn.set(t,n)),i}static isEmpty(e){const t=un.getLocalStorageQName(e);if(gn.get(t)){if(gn.get(t).items.length>0)return!1}return!0}static purge(e){const t=`${this.baseLogTag}.purge`,n=un.getLocalStorageQName(e);un.isEmpty(e)||gn.remove(n),$e.log(2,t,`Queue "${e}" has been cleared.`)}static getLocalStorageQName(e){return be.Q.PREFIX+"_"+e}}const pn={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var mn,hn=new Uint8Array(16);function fn(){if(!mn&&!(mn="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return mn(hn)}for(var En=[],Sn=0;Sn<256;++Sn)En.push((Sn+256).toString(16).slice(1));function _n(e,t=0){return(En[e[t+0]]+En[e[t+1]]+En[e[t+2]]+En[e[t+3]]+"-"+En[e[t+4]]+En[e[t+5]]+"-"+En[e[t+6]]+En[e[t+7]]+"-"+En[e[t+8]]+En[e[t+9]]+"-"+En[e[t+10]]+En[e[t+11]]+En[e[t+12]]+En[e[t+13]]+En[e[t+14]]+En[e[t+15]]).toLowerCase()}const vn=function(e,t,n){if(pn.randomUUID&&!t&&!e)return pn.randomUUID();var i=(e=e||{}).random||(e.rng||fn)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){n=n||0;for(var a=0;a<16;++a)t[n+a]=i[a];return t}return _n(i)},yn=["MOE_OPT_IN_ATTEMPT"],Tn={TOPIC:"MOE_AUTOMATED_EVENTS",NAMES:["MOE_WEB_UNSUBSCRIBED","EVENT_ACTION_WEB_SESSION_START","MOE_PAGE_VIEWED","EVENT_ACTION_USER_ATTRIBUTE","EVENT_ACTION_DEVICE_ATTRIBUTE","MOE_WEB_OPTIN_BANNER_LOAD","MOE_WEB_OPTIN_CLOSED","MOE_WEB_OPTIN_ACCEPTED","MOE_USER_SUBSCRIBED","MOE_OPT_IN_ATTEMPT","MOE_OPT_IN_SHOWN","MOE_OPT_IN_ALLOWED","MOE_OPT_IN_DISMISSED","MOE_OPT_IN_BLOCKED","MOE_PUSH_PERMISSION_STATE_ALLOWED","MOE_PUSH_PERMISSION_STATE_BLOCKED","MOE_LOGOUT","MOE_FIRST_VISIT","MOE_WEBP_MESSAGE_SHOWN","MOE_WEBP_MESSAGE_CLICKED","MOE_WEBP_MESSAGE_DISMISSED","MOE_WEBP_MESSAGE_DELIVERED","MOE_ONSITE_MESSAGE_CLICKED","MOE_ONSITE_MESSAGE_SHOWN","MOE_ONSITE_MESSAGE_DISMISSED","MOE_ONSITE_MESSAGE_AUTO_DISMISS","MOE_ONSITE_MESSAGE_DELIVERED","MOE_CARD_DELIVERED","MOE_CARD_IMPRESSION","MOE_CARD_CLICKED","MOE_CARD_DISMISSED","MOE_CARD_INBOX_CLICKED","MOE_OFFERING_CLICKED","MOE_OFFERING_SHOWN","MOE_LANDING_PAGE_SHOWN","MOE_LANDING_PAGE_CLICKED","MOE_RESPONSE_SUBMITTED","MOE_PAGE_EXIT","MOE_PAGE_SCROLL","MOE_PAGE_URL_EVENT","MOE_EXIT"]},bn=1,In={REPORT_ADD:"v2/sdk/report/"},An={TIME_BETWEEN_BATCHES:15e3},wn={TRACK:"v1/sdk/track/click"},Dn="moeq",Cn="User is offline.",On=["id","first_name","last_name","email","mobile","name","gender","birthday"],Pn="moe_tracking",Nn="batched_events",Rn="moe_database",Mn="moe_offline_data_sync",Ln={OFFLINE_DATA:{NAME:"offline_data"}},kn=e=>{if(e){const t=e.indexOf("?");if(t<0)return{};const n=(e=e.slice(t+1)).replace("?","").split("&"),i={};return n.forEach(e=>{const t=e.split("="),n=t[0],a=decodeURIComponent(t[1]||"");i[n]?"[object Array]"===Object.prototype.toString.call(i[n])?i[n].push(a):i[n]=[i[n],a]:i[n]=a}),JSON.parse(JSON.stringify(i))}return{}},xn=(e,t)=>{if(!t)return e;"?"!==e[e.length-1]&&(e+="?");for(const n in t)t.hasOwnProperty(n)&&null!=t[n]&&(e+=n+"="+encodeURIComponent(t[n])+"&");return"&"===e[e.length-1]&&(e=e.slice(0,-1)),e};class Un{static get(e,t){return Un.makeNetworkCall(Bn.METHODS.GET,e,t)}static post(e,t){return Un.makeNetworkCall(Bn.METHODS.POST,e,t)}static makeNetworkCall(e,t,n={}){return new Promise((i,a)=>{const r=JSON.stringify(He(n,"postData",null));t=xn(t,He(n,"queryParams",null));const s=new XMLHttpRequest;s.open(e,t,!0),Un.addRequestHeaders(s,He(n,"headers",{})),s.onreadystatechange=()=>{4===s.readyState&&200===s.status||4===s.readyState&&410===s.status?i({status:s.status,responseText:s.responseText}):4===s.readyState&&200!==s.status&&a({code:s.status,reason:s.responseText})},s.send(r)})}static addRequestHeaders(e,t){for(const n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n]);return e}}var Bn;function Fn(){const e=navigator.userAgent;return!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))}function Hn(){const e=navigator.userAgent.toLowerCase(),t=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(e);return/nexus player|neo-x5|adt-2|tsbnettv|roku|tizen|smart-tv.+(samsung)|hbbtv.+maple;(\d+)|(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))|(apple) ?tv|crkey|droid.+aft(\w)( bui|\))|\(dtv[\);].+(aquos)|(aquos-tv[\w ]+)\)|(bravia[\w ]+)( bui|\))|(mitv-\w{5}) bui|Hbbtv.*(technisat) (.*);|\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)|hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)|\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i.test(e)?k.TV:t?k.TABLET:Fn()?k.MOBILE:k.WEB}function Vn(e,t){const n=t&&new RegExp("^("+t.join("|")+")$");return Hn()!==k.TV||!n?.test(e)&&t?{}:{moe_os_type:Wn(),os:k.TV.toUpperCase()}}function Wn(){const e=navigator.userAgent.toLowerCase();return/tizen/i.test(e)?x:/web0s/i.test(e)?U:/xbox/i.test(e)?B:/vizio/i.test(e)?F:H}!function(e){let t;!function(e){e.GET="GET",e.POST="POST"}(t=e.METHODS||(e.METHODS={}))}(Bn||(Bn={}));class Gn{p=null;res=null;rej=null;constructor(){try{this.p=new Promise((e,t)=>{this.res=e,this.rej=t})}catch(e){$e.error(1,"Utils.PromiseObject","Promises not supported")}}}function Kn(e,t){return!je.get().disableWebPush&&e.isWebPushEnabled&&Fe.includes(t.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window}function qn(e,t){return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?"vapid"===e?.chrome?.subscriptionMode&&!!e?.chrome?.vapidPublicKey||!1:t.isFirefox()&&"vapid"===e?.firefox?.subscriptionMode&&!!e?.firefox?.vapidPublicKey||!1}function $n(){const e=je.get()?.swPath;return!(!e||!e.includes("tools/moengage"))}function Yn(e,t){return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?e?.chrome?.vapidPublicKey||"":t.isFirefox()&&e?.firefox?.vapidPublicKey||""}class jn{static baseLogTag="IdentityMethods";static moeDataStore;static getIdentityMap(){const e=gn.get(be.WEB_SETTINGS);return e?.isDomainLevelStorage?this.getIdentitiesFromCookies():this.getIdentitiesFromLocalStorage()}static getIdentitiesFromLocalStorage(){const e=gn.get(be.IDENTITY_MAP);return e?.userIdentities?e:null}static getIdentitiesFromCookies(){const e=ln.get(be.IDENTITY_MAP);if(e&&"object"==typeof e&&e.userIdentities){const t={userIdentities:e.userIdentities};return e.previousIdentities&&(t.previousIdentities=e.previousIdentities,t.previousIdentitiesUpdatedTime=e.previousIdentitiesUpdatedTime),t}return null}static getUserIdentities(){const e=this.getIdentityMap();return e?.userIdentities?e.userIdentities:null}static async updateCurrentUserIdentities(e){let t;const n=this.getIdentityMap();n?.userIdentities?(t={...n,userIdentities:{...n.userIdentities,...e}},gn.set(be.IDENTITY_MAP,t)):(this.createIdentityMap(),t={...this.getIdentityMap(),userIdentities:e},gn.set(be.IDENTITY_MAP,t)),await this.updateIdentifiersIDB(t)}static broadcastUserIdentityUpdate(){const e=this.baseLogTag+".broadcastUserIdentityUpdate";$e.log(1,e,"User Identities Updated."),Ti.broadcastToWindow({topic:P.TOPIC_NAME,name:P.EVENT_NAMES.USER_IDENTITY_UPDATE})}static broadcastLogout(){Ti.broadcastToWindow({topic:P.TOPIC_NAME,name:P.EVENT_NAMES.LOGOUT})}static async updatePreviousUserIdentities(e,t){let n;const i=this.getIdentityMap();if(i?.userIdentities){const a=i?.previousIdentities||{};n={...i,previousIdentities:{...a,...e},previousIdentitiesUpdatedTime:t||(new Date).getTime()},gn.set(be.IDENTITY_MAP,n)}else this.createIdentityMap(),n={...this.getIdentityMap(),previousIdentities:e,previousIdentitiesUpdatedTime:t||(new Date).getTime()},gn.set(be.IDENTITY_MAP,n);await this.updateIdentifiersIDB(n)}static async updateIdentifiersIDB(e){if(this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Me,storeName:Le})),this.moeDataStore)if(Object.keys(e).length){const t=await this.moeDataStore.getItem(S)||{};await this.moeDataStore.setItem(S,{...t,...e})}else await this.moeDataStore.setItem(S,e)}static copyUidIntoIdentityMap(e){const t=this.baseLogTag+".copyUidIntoIdentityMap",n=e.getAttribute("id");if(n){const e={uid:n};this.updateCurrentUserIdentities(e),$e.log(1,t,"UID copied into IdentityMap.")}}static getIdentifiersFromIdentities(){const{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:n}=this.getIdentityMap()||{},i={};return e&&Object.keys(e).length&&(i.userIdentities=e),n>0&&((new Date).getTime()-n>216e5?this.removePreviousUserIdentities():i.previousIdentities=t),i}static async removePreviousUserIdentities(){const e=this.baseLogTag+".removePreviousUserIdentities",t={...this.getIdentityMap(),previousIdentities:{},previousIdentitiesUpdatedTime:0};gn.set(be.IDENTITY_MAP,t),await this.updateIdentifiersIDB(t),$e.log(1,e,"previousIdentities removed from IdentityMap.")}static createIdentityMap(){gn.set(be.IDENTITY_MAP,{userIdentities:{},previousIdentities:{},previousIdentitiesUpdatedTime:0})}}function zn(e,t){if(null==e||null==t)return e===t;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object))return!1;if(!(t instanceof Object))return!1;const n=Object.keys(e);return Object.keys(t).every(e=>-1!==n.indexOf(e))&&n.every(n=>zn(e[n],t[n]))}class Jn{os="web";osPlatform;isMobile;name;isIncognito;constructor(e,t,n){this.osPlatform=e.userAgent,this.isMobile=Fn(),this.os=Fn()?"mweb":"web",this.name=Jn.getBrowserName(e.userAgent,t),this.isIncognito=n}static async getInstance(){if(null==We.get(Ae)){const e=await Jn.isIncognito(window),t=new Jn(navigator,document,e);We.set(Ae,t);const n=gn.get(be.BROWSER_DETAILS);return n&&Jn.isBrowserUpdated(n,t)||gn.set(Ae,t),t}return We.get(Ae)}static isIncognito(e){const t=e.RequestFileSystem||e.webkitRequestFileSystem;return new Promise(n=>{t?t(e.TEMPORARY,100,()=>{n(!1)},()=>{n(!0)}):n(!1)})}static getBrowserName(e,t){return-1!==e.indexOf("MSIE")||1==t.documentMode?Jn.BROWSER_NAMES.INTERNET_EXPLORER:e.indexOf("Edg")>-1?Jn.BROWSER_NAMES.EDGE:e.indexOf("OPR")>-1||e.indexOf("Opera")>-1?Jn.BROWSER_NAMES.OPERA:e.indexOf("Chrome")>-1||e.match(/\b(?:crmo|crios)\/([\w\.]+)/i)?e.indexOf("MMS")>-1?Jn.BROWSER_NAMES.OPERA_NEON:Jn.BROWSER_NAMES.CHROME:e.indexOf("Safari")>-1?Jn.BROWSER_NAMES.SAFARI:e.indexOf("Firefox")>-1?Jn.BROWSER_NAMES.FIREFOX:Jn.BROWSER_NAMES.OTHERS}static isBrowserUpdated(e,t){return zn(e,t)}isWebPushCompatible(){return this.isChrome()||this.isFirefox()||this.isOpera()||this.isSafari()||this.isEdge()}isChrome(){return this.name===Jn.BROWSER_NAMES.CHROME}isFirefox(){return this.name===Jn.BROWSER_NAMES.FIREFOX}isOpera(){return this.name===Jn.BROWSER_NAMES.OPERA||this.name===Jn.BROWSER_NAMES.OPERA_NEON}isSafari(){return this.name===Jn.BROWSER_NAMES.SAFARI}isEdge(){return this.name===Jn.BROWSER_NAMES.EDGE}static isIOS(){return!(!navigator.userAgent.match(/iPad/i)&&!navigator.userAgent.match(/iPhone/i))}}!function(e){let t;!function(e){e.CHROME="Google Chrome",e.FIREFOX="Mozilla Firefox",e.OPERA="Opera",e.OPERA_NEON="Opera Neon",e.SAFARI="Apple Safari",e.INTERNET_EXPLORER="Internet Explorer",e.EDGE="Edge",e.OTHERS="Others"}(t=e.BROWSER_NAMES||(e.BROWSER_NAMES={}))}(Jn||(Jn={}));const Qn=Jn,Xn=()=>new Promise((e,t)=>{try{const n=JSON.parse(localStorage.getItem("MOE_DATA"));n&&n.WEB_SETTINGS&&n.WEB_SETTINGS.configs&&e(n.WEB_SETTINGS),t("Error in getting sdk settings from localstorage - no data found")}catch(e){$e.error(1,"getSDKSettings","Error in getting sdk settings from localstorage ",e),t(e)}}),Zn=()=>new Promise((e,t)=>{try{const t=JSON.parse(localStorage.getItem("MOE_DATA"));return t&&t.INIT_DATA&&e(t.INIT_DATA),{}}catch(e){$e.error(1,"getSDKSettings","Error in getting init data from localstorage ",e),t(e)}});class ei{key;value;updated_at;level;constructor(e,t,n){this.key=e,this.value=t,this.updated_at=(new Date).getTime(),n===ei.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&(this.level=n)}static equal(e,t){return e.key===t.key&&JSON.stringify(e.value)===JSON.stringify(t.value)}}!function(e){let t;!function(e){e.PORTFOLIO="PORTFOLIO",e.PROJECT="PROJECT"}(t=e.USER_ATTRIBUTE_LEVEL||(e.USER_ATTRIBUTE_LEVEL={}))}(ei||(ei={}));const ti=ei;function ni(){return gn.get(be.SUBSCRIPTION_DETAILS)?.token||null}function ii(e,t){const{web:n,mobile:i}=e,a=hi(`\n  <div id="desktopBannerWrapped" aria-labelledby="optInTitle" data-rapid_height="50"\n  style="width: 422px; top: 1px; left: calc(50% - 211px); margin: 0px; padding: 0px; box-shadow: rgb(136, 136, 136) 0px 0px 4px; font-size: 11px; font-weight: 400; position: fixed; z-index: 2147483647; background: ${n.banner.backgroundColor};">\n    <div style="margin: 0;padding: 0 20px 10px;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n      <div\n        style="float: left;position: relative;display: inline-block;margin: 15px 15px 0 0!important;padding: 0!important;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;height: 65px!important;width: 65px!important;" src="${n.banner.icon}" alt="${n.banner.altText||""}"/>\n      </div>\n      <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;position: relative!important;padding: 10px 0 0!important;color: #000!important;text-align: left!important;margin: 0!important;line-height: 1.4em!important;display: inline-block!important;width: calc(100% - 80px)!important;">\n        <h2 id="optInTitle" style="margin-bottom: 5px; text-align: left; font-size: 14px; font-weight: 700; overflow: hidden; height: 2.8em; line-height: 1.4em; display: block; font-family: Open Sans, sans-serif !important; word-spacing: normal !important; letter-spacing: normal !important; color: ${n.banner.title.textColor+" !important"};">\n          ${n.banner.title.text}\n        </h2>\n        <p aria-describedby="optInTitle" style="overflow: hidden; height: 2.8em; word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; font-size: 12px !important; line-height: 1.4em !important; margin: 10px 0px !important; padding: 0px !important; text-align: left !important; color: ${n.banner.body.textColor+" !important"};">\n          ${n.banner.body.text}\n        </p>\n      </div>\n      <div\n        style="display: flex;justify-content: space-between;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">${t?"":`<div style="margin-top: 0.5em;">\n          <a aria-label="${n.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${n.logo.logoColor+" !important"};">\n            Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;vertical-align: bottom;"><img alt="" id="moeBannerLogoweb" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;"></span>\n          </a>\n        </div>`}\n        <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;margin: 0!important;padding: 0!important;margin-left: auto !important;">\n          <button id="moe-dontallow_button" style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 100px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px 20px 0px 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.dismissButton.textColor}; background: ${n.dismissButton.backgroundColor};">\n            ${n.dismissButton.text}\n          </button>\n          <button\n            style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 90px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.allowButton.textColor}; background: ${n.allowButton.backgroundColor};" id="optInText">\n            ${n.allowButton.text}\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  `);return{mobileUI:hi(`\n  <div id="mobileBannerWrapped" aria-labelledby="optInTitle" class="moe-mobile-box" style="position: fixed; top: 0px; left: 0px; width: 100%; box-shadow: rgb(51, 51, 51) 0px 5px 10px -5px; z-index: 2147483647; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif; background: ${i.nudge.backgroundColor};">\n    <div class="moe-logo-text" style="box-sizing: border-box;padding: 10px !important;float: left !important;width: 100% !important">\n      <img height="40px" width="40px" style="box-sizing: border-box;width: 40px !important;height: 40px !important;float: left !important" alt="${i.nudge.altText||""}" src="${i.nudge.icon}">\n      <h2 aria-labelledby="optInTitle" style="box-sizing: border-box; width: calc(100% - 40px); overflow: hidden; height: 2.4em; float: left !important; word-break: break-word !important; font-weight: 400 !important; line-height: 1.2em !important; font-size: 17px !important; text-align: left !important; padding: 0px 0px 0px 10px !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; color:${i.nudge.title.textColor+" !important"}">\n        ${i.nudge.title.text}\n      </h2>\n    </div>\n    <div class="moe-buttons-panel" style="box-sizing: border-box;text-align: right;padding: 0 10px !important;float: left;width: 100% !important;margin-top: 5px;margin-bottom: 3px">\n      <div style="width: 100%;box-sizing: border-box">\n        <button id="moe-dontallow_button" class="moe-mobile-button-outline" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px 5px 0px 0px !important; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n            ${i.dismissButton.text}\n          </div>\n        </button>\n        <button class="moe-mobile-button-fill" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px !important; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};" id="optInText">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};">\n            ${i.allowButton.text}\n          </div>\n        </button>\n      </div>\n    </div>${t?"":`<div style="float: left;margin-top: -2.25em;">\n    <a aria-label="${i.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${i.logo.logoColor+" !important"};">\n    Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img alt="" id="moeBannerLogomobile" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;">\n      </span>\n    </a>\n    </div>`}\n  </div>\n  `),webUI:a}}async function ai(e,t){let n="",i="";const a=await Qn.getInstance();var r;return a.isFirefox()?(i=ri((r=e.firefox,hi(`\n  <div class="moe_firefox" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${r?.desktop?.text||""}\n    </div>\n    <div\n    style="position:relative;top: 45px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)),t),n=si(function(e){const t=e?.mobile?.text||"";return hi(`\n  <div class='moe_firefox' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.firefox),t)):a.isOpera()?(i=ri(function(e){const t=e?.desktop?.text||"";return hi(`\n  <div class="moe_opera" style="display:none;">\n    <div style='position:relative;top: 240px;left: 40%;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 45px;left: 55%;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg) scaleX(-1);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t),n=si(function(e){const t=e?.mobile?.text||"";return hi(`\n  <div class='moe_opera' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t)):(i=ri(function(e){return hi(`\n  <div class="moe_chrome" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e.desktop.text}\n    </div>\n    <div\n      style="position:relative;top: 30px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.chrome),t),n=si(function(e){const t=e?.mobile?.text||"";return hi(`\n  <div class='moe_chrome' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.chrome),t)),{mobileUI:n,webUI:i}}function ri(e,t){return`\n  <div id='chrome_desktop_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.89);'>\n    ${e}\n    ${t?"":hi('\n    <a href="#" target="_blank"\n    style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;bottom: 0px;left: 10px;position: absolute;"\n    onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n    Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n      style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}function si(e,t){return`\n  <div id='chrome_mobile_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.798039);'>\n    ${e}\n    ${t?"":hi('\n    <a href="#" target="_blank"\n      style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;left: 0px;bottom: 23%;position: absolute;"\n      onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n      Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n        style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}class oi{static shouldTriggerSubscriberBilling(e){const t="MoEngage.billing.shouldTriggerSubscriberBilling";let n=[];return e.attributeNames?.length?n=e.attributeNames:e.user?.attributes?.length&&(n=e.user.attributes.map(e=>e.key)),n?.length&&oi.checkAttributeTrigger(n,e.sdkSettings)?($e.log(1,t,"Subscriber billing is/ can be triggered by available user attributes"),!0):oi.checkPushTokenTrigger(e.pushToken)?($e.log(1,t,"Subscriber billing is/ can be triggered by current web push subscription"),!0):!!oi.checkIdentityTrigger(e.identities||jn.getUserIdentities(),e.sdkSettings)&&($e.log(1,t,"Subscriber billing is/ can be triggered by available user identities"),!0)}static checkAttributeTrigger(e,t){return e.some(e=>Ye(f.find(t=>t.moeName===e)?.attributeName||e,t.configs?.subscriberBasedBillingAttributes||[]))}static checkPushTokenTrigger(e){return null!==e&&!(!e&&!ni())}static checkIdentityTrigger(e,t){if(!e)return!1;const n=t.configs?.subscriberBasedBillingAttributes||[];return Object.keys(e).some(e=>{if(n.includes(e))return!0;if(["u_em","u_mb"].includes(e))return!0;const t=f.find(t=>t.moeName===e);return!(!t||!n.includes(t.attributeName))})}}let ci=null;class li{static baseLogTag="UserModel";static isResolved=!1;attributes=[];deviceUuid;deviceAdded;static instance=null;subscribedToOldSdk=!1;constructor(e){null==e?(this.deviceUuid=vn(),this.attributes=[],this.deviceAdded=!1):(this.deviceUuid=He(e,"deviceUuid",vn()),this.attributes=He(e,"attributes",[]),this.deviceAdded=He(e,"deviceAdded",!1))}addAttribute(e){const t=li.baseLogTag+".addAttribute";return new Promise(async n=>{let i=!0;e.key=li.getMorphedKey(e.key);let a=-1;for(let t=this.attributes.length-1;t>=0;t--)e.key===this.attributes[t].key&&e.level===this.attributes[t].level&&(a=t);a>=0?(zn(this.attributes[a].value,e.value)&&($e.log(2,t,"Duplicate attribute found: ",e),i=await this.isAttibuteTrackingRequired(this.attributes[a].updated_at,this.attributes[a].level)),i&&(this.attributes[a].value=e.value,this.attributes[a].updated_at=(new Date).getTime())):($e.log(2,t,"Adding attribute:",e),this.attributes.push(e)),this.save().then(()=>{n(i)})})}async isAttibuteTrackingRequired(e,t=ti.USER_ATTRIBUTE_LEVEL.PROJECT){const n=await Xn();return t===ti.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&null!==n.configs.portfolioUserAttributeCacheTime?vi(e)>n.configs.portfolioUserAttributeCacheTime:null===n.configs.userAttributeCacheTime||vi(e)>n.configs.userAttributeCacheTime}static getLocalUser(){const e=li.baseLogTag+".getLocalUser";return new Promise(t=>{if(gn.get(be.USER_DATA)){$e.log(2,e,"Found user in localstorage");const n=gn.get(be.USER_DATA);t(new li(n))}else t(null)})}static getCookieUser(){return new Promise(e=>{const t=li.baseLogTag+".getLocalUser";if(ln.get(be.USER_DATA)){$e.log(2,t,"Found user in cookie");const n=ln.get(be.USER_DATA);e(new li(n))}else e(null)})}static getMigrationUser(){const e=li.baseLogTag+".getLocalUser";return new Promise(t=>{const n=localStorage.getItem(be.OLD_SDK.USER_DATA);if(n)try{const e=JSON.parse(n);if(e.is_new_sdk_migrated)t(null);else{const n=new li({deviceAdded:He(e,"device_add",!1),deviceUuid:He(e,"uuid",vn())}),i=He(e,"user_attrs",{});for(const e in i)i.hasOwnProperty(e)&&n.attributes.push(new ti(e,i[e]));const a=localStorage.getItem(be.OLD_SDK.PUSH_TOKEN);null!=a&&"NA"!==a&&"null"!==a&&(n.subscribedToOldSdk=!0),t(n)}}catch(n){$e.error(1,e,"Error getting the migration user. Resolving as a new user."),$e.error(1,e,n),t(null)}else t(null)})}static getSync(){return li.instance}static get(){const e=li.baseLogTag+".get";return null!=ci||(ci=new Promise((t,n)=>{Qn.getInstance().then(e=>Xn()).then(t=>{const n=li.getLocalUser(),i=t.isDomainLevelStorage?li.getCookieUser():"resolved",a=li.getMigrationUser();return Promise.all([n,i,a]).then(n=>{const i=n[0],a=n[1],r=n[2];return r?r.save().then(n=>{const i=localStorage.getItem(be.OLD_SDK.USER_DATA);if(i)try{const e=JSON.parse(i);e.is_new_sdk_migrated=!0,localStorage.setItem(be.OLD_SDK.USER_DATA,JSON.stringify(e))}catch(t){$e.error(2,e,"Error parsing migration user JSON",t)}return $e.log(2,e,"User resolved from older SDK: ",n),{resolvedUser:n,sdkSettings:t}}):(()=>{if(a&&"resolved"!==a)return $e.log(2,e,"User resolved from cookie: ",a),a.save();{$e.log(2,e,"Local user: ",i);const n=new li(i);return t.isPushSubBilling&&(oi.shouldTriggerSubscriberBilling({sdkSettings:t,user:n})?(n.deviceAdded=!0,zi.trackDeviceAttributes()):n.deviceAdded=!1),n.save()}})().then(e=>({resolvedUser:e,sdkSettings:t}))})}).then(({resolvedUser:e,sdkSettings:n})=>{li.isResolved=!0,n?.isDomainLevelStorage&&(ci=null),t(e)}).catch(t=>{$e.error(2,e,"Error in fetching/creating user",t),ci=null,n(t)})})),ci}static logout(){return new Promise(e=>{ci=null,this.instance=null,window.MoeWebP&&(window.MoeWebP.deviceUuid=null),e(!0)})}save(){li.baseLogTag;li.isAmpEnabled()&&(this.deviceUuid=ln.get("moe_uuid")),gn.get("WEB_SETTINGS");const e=gn.get(be.WEB_SETTINGS);return e?.configs?.isWebPersonalizationModuleEnabled&&window.MoeWebP?.deviceUuid&&this.deviceUuid!==window.MoeWebP.deviceUuid&&(this.deviceUuid=window.MoeWebP.deviceUuid),li.instance=this,new Promise(e=>{gn.set(be.USER_DATA,this),ln.set(me,li.instance.deviceUuid),e(this)})}static isAmpEnabled(){const e=ln.get(me);return e&&e.includes("amp")}getAttribute(e){let t=null;return e=li.getMorphedKey(e),this.attributes.map(n=>{n.key===e&&(t=n.value)}),t}indexOfAttribute(e){let t=-1;return e=li.getMorphedKey(e),this.attributes.map((n,i)=>{n.key===e&&(t=i)}),t}static getMorphedKey(e){switch(e){case"id":e=o;break;case"email":e=c;break;case"name":e=l;break;case"first_name":e=d;break;case"last_name":e=g;break;case"mobile":e=u;break;case"gender":e=p;break;case"birthday":e=m}return e}}function di(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}function gi(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),a=i.byteLength,r=a%3,s=a-r;let o,c,l,d,g;for(let e=0;e<s;e+=3)g=i[e]<<16|i[e+1]<<8|i[e+2],o=(16515072&g)>>18,c=(258048&g)>>12,l=(4032&g)>>6,d=63&g,t+=n[o]+n[c]+n[l]+n[d];return 1==r?(g=i[s],o=(252&g)>>2,c=(3&g)<<4,t+=n[o]+n[c]+"=="):2==r&&(g=i[s]<<8|i[s+1],o=(64512&g)>>10,c=(1008&g)>>4,l=(15&g)<<2,t+=n[o]+n[c]+n[l]+"="),t}function ui(e){return e.replace(/[\uff0e]/g,".")}function pi(e){return new Date(Date.parse(e))}async function mi(){const e={},t=jn.getIdentityMap(),n=await async function(){const e=await li.get(),t=e.getAttribute(o)||"";return{uniqueId:e.deviceUuid,uid:t}}();return t&&(t.userIdentities&&(e.user_identities=t.userIdentities),t.previousIdentities&&(e.previous_identities=t.previousIdentities)),n.uid&&(e.uid=n.uid),{identifiers:e,uniqueId:n.uniqueId}}function hi(e){let t=e;const n=je.get();return"string"==typeof t&&t.length&&n?.proxyDomains?.api&&(n.proxyDomains.cdnApp&&(t=t.replace(/app-cdn\.moengage\.com/gi,n.proxyDomains.cdnApp)),n.proxyDomains.cdnScript&&(t=t.replace(/cdn\.moengage\.com/gi,n.proxyDomains.cdnScript)),n.proxyDomains.cdnImage&&(t=t.replace(/image\.moengage\.com/gi,n.proxyDomains.cdnImage))),t}function fi(){if(We.get(De))return;const e=kn(window.location.href);return e.moe_aid&&!e.moe_aid.includes("{{")?e.moe_aid:void 0}function Ei(){const e=je.get(),t=!!e&&!!e.disableSdk;let n=!1;return n=Si()?ln.get(be.SDK_DISABLED):gn.get(be.SDK_DISABLED),!(n||t&&!1!==n)}function Si(){const e=gn.get(be.WEB_SETTINGS);return e?.isDomainLevelStorage||!1}function _i(e){return null!=e&&"NA"!==e&&""!==e&&"null"!==e}function vi(e){const t=(new Date).getTime()-e;return Math.round(t/1e3)}class yi{static listeners=[];static topicListeners={};static getListeners(){return this.listeners}static getTopicListeners(e){return He(yi.topicListeners,e,[])}static addListener(e){yi.listeners.push(e)}static addTopicListener(e,t){yi.topicListeners[e]=yi.getTopicListeners(e),yi.topicListeners[e].push(t)}static broadcast(e){yi.listeners.map(t=>{t(e)}),He(yi.topicListeners,e.topic,[]).map(t=>{t(e)})}static broadcastToWindow(e,t=!1){window&&(t||Ei())&&window.dispatchEvent(new CustomEvent(e.topic,{detail:{name:e.name,data:e.data?e.data:null}}))}static deprecatedSdkCallback(e){window.dispatchEvent(new CustomEvent("MOE_OPT_IN",{detail:e}))}static resetAllListeners(){yi.listeners=[],yi.topicListeners={}}static resetListeners(){yi.listeners=[]}}const Ti=yi,bi=e=>e===G||e===ie;function Ii(){Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.MOE_INIT_COMPLETED})}const Ai=e=>{let t;try{t=JSON.stringify(e)}catch(e){return!1}return new Blob([t]).size/1024>r};function wi(e){return`Event "${e}" can't get tracked as its size is more than ${r} KB. Max permissible event size is ${r} KB.`}const Di=e=>"string"==typeof e,Ci=e=>"[object Date]"===Object.prototype.toString.call(e),Oi=e=>Array.isArray(e);class Pi{static NON_INTERACTIVE_EVENTS=[$,z,$,ee];initiateSessionAndSource(e){return new Promise((t,n)=>{(()=>{this.isSessionRunning()&&this.isCurrentSourceSameAsPreviousSource()||this.startNewSession(e),t(!0)})()})}clearSessionAndSource(){gn.remove(v)}isSessionRunning(){return this.getSessionKey()&&!this.isSessionExpired()}isSessionExpired(){const e=this.getSessionExpiryTime(),t=We.get("wasBrowserInactive");return!(!t&&null!==t)&&(this.isWindowActive()&&We.set("wasBrowserInactive",!1),(new Date).getTime()>e)}isNonEventInteractive(e){return Pi.NON_INTERACTIVE_EVENTS.includes(e.name)||e.attributes.filter(e=>"moe_non_interactive"===e.key&&1===e.value).length>0}getCurrentSource(){const e=kn(window.location.href);let t="";const n={};if(!Object.keys(e).includes("utm_source"))return;t="utm_",this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(n[t]=e[t])});const i={source_url:window.location.href};return e[t+"source"]&&(i.source=e[t+"source"]),e[t+"medium"]&&(i.medium=e[t+"medium"]),e[t+"term"]&&(i.term=e[t+"term"]),e[t+"campaign"]&&(i.campaign_name=e[t+"campaign"]),e[t+"content"]&&(i.content=e[t+"content"]),e.utm_id&&(i.campaign_id=e.utm_id),Object.keys(n).length&&(i.extra=n),i}getActiveSource(){const e=this.getSavedSource();return e||this.getCurrentSource()}isSourceOrganic(){const e=kn(window.location.href),t=Object.keys(e);let n=!1;return this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(n=!0)}),!t.includes("utm_source")&&!t.includes("source")&&!n}setCurrentSource(e){const t=this.getSession()||{};t.currentSource=e,gn.set(v,t)}removeCurrentSource(){const e=this.getSession();e&&(e.currentSource=void 0,gn.set(v,e))}getSavedSource(){const e=He(this.getSession(),w,void 0);if(e)return e}isCurrentSourceSameAsPreviousSource(){if(this.isSourceOrganic())return!0;const e={...this.getCurrentSource()};delete e.source_url;const t={...this.getSavedSource()};return delete t.source_url,zn(e,t)}getSessionKey(){return He(this.getSession(),y,null)}getSessionStartTime(){return He(this.getSession(),T,null)}getSessionExpiryTime(){return He(this.getSession(),b,null)}getSessionMaxTime(){return He(this.getSession(),I,null)}getSession(){return gn.get(v)}geCustomIdentifiersToTrack(){return He(this.getSession(),A,[])||[]}generateSessionKey(){return vn()}startNewSession(e){this.removeCurrentSource();let t=this.getNumberOfSessions();const n={sessionKey:this.generateSessionKey(),sessionStartTime:(new Date).toISOString(),sessionMaxTime:e.configs.sessionInactiveDuration,customIdentifiersToTrack:e.configs.sourceExtraParams,sessionExpiryTime:(new Date).getTime()+1e3*e.configs.sessionInactiveDuration,numberOfSessions:++t};gn.set(v,n)}extendSession(){const e=this.getSession();e&&(e.sessionExpiryTime=(new Date).getTime()+1e3*e.sessionMaxTime,gn.set(v,e))}handleBrowserInactivity(e){"hidden"===e&&We.set("wasBrowserInactive",!0)}isWindowActive(){return!!We.get("isWindowActive")}getNumberOfSessions(){return He(gn.get(v),D)||0}}function Ni(e){const t=e?new Date(e):new Date;return`${t.getDate()}:${t.getMonth()+1}:${t.getFullYear()}:${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`}function Ri(e){return"object"==typeof e&&!Ci(e)}function Mi(e){const t=String(e.getMonth()+1).padStart(2,"0");return`${String(e.getDate()).padStart(2,"0")}${t}${String(e.getFullYear()).slice(-2)}`}class Li{static baseLogTag="ReportAddViewEvent";EVENT_ACTION;EVENT_ATTRS;EVENT_L_TIME;EVENT_G_TIME;EVENT_ATTRS_CUST;N_I_E;IS_PORTFOLIO;constructor(e){this.EVENT_ACTION=e.event.name,this.EVENT_ATTRS=e.event.attributes&&ki(e.event.attributes),this.EVENT_G_TIME=(new Date).getTime().toString(),this.EVENT_L_TIME=Ni(e.event.timestamp),this.EVENT_ATTRS_CUST=e.postData.c,this.N_I_E=e.postData.nie,e.isPortfolioAttribute&&(this.IS_PORTFOLIO=e.isPortfolioAttribute)}}const ki=e=>{const t={};return e.forEach(e=>{t[e.key]=e.value}),t};class xi{static windowClosed=!1;static visibilityChange(){"hidden"===document.visibilityState&&(xi.windowClosed||Vi.reactToTriggerEvents())}static removeEventListeners(){document.removeEventListener("visibilitychange",xi.visibilityChange,!1)}static addListeners(){document.addEventListener("visibilitychange",xi.visibilityChange,!1)}}const Ui=xi;class Bi{static ready;static offlineDataStore;static async initialize(){if(null==Bi.ready){Bi.offlineDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Rn,storeName:Ln.OFFLINE_DATA.NAME});const e=t().createInstance({driver:[t().INDEXEDDB],name:Rn,storeName:"moe_data"}),n=t().createInstance({driver:[t().INDEXEDDB],name:Rn,storeName:"moe_backup"}),i=[Bi.offlineDataStore.ready(),e.ready(),n.ready()];Bi.ready=Promise.all(i)}return await Bi.ready}}class Fi{static batchRemoteLogsApiRetries=1;static getRemoteLogsBatchRequestOptions(e){return new Promise(t=>{zi.collectGetParams().then(n=>{const i={query_params:{...n,unique_id:n.unique_id,os:"web"===n.os?"Web":"mWeb"},logs:[...e]};t(i)})})}static sendBatchOfLogs(e){const t=zi.baseLogTag+".sendBatchOfLogs";return new Promise((n,i)=>{Fi.getRemoteLogsBatchRequestOptions(e).then(i=>{const a=Zn(),r=a.baseDomainName+s+i.query_params.os.toLowerCase()+"/"+a.appId;Un.post(r,{postData:i}).then(()=>{$e.log(1,t,"[sendBatchOfLogs] batch payload: "+JSON.stringify(e)),$e.log(1,t,"Batch Remote Logs sent to MoEngage successfully"),Fi.batchRemoteLogsApiRetries=1,n(!0)}).catch(n=>{$e.log(1,t,"Batch Remote Logs API failed",n),this.handleRemoteLogsFailure(e)})})})}static handleRemoteLogsFailure(e){const t=zi.baseLogTag+".handleRemoteLogsFailure";$e.log(1,t,"Retry Batch Logs Failed API",Fi.batchRemoteLogsApiRetries),Fi.batchRemoteLogsApiRetries<3&&setTimeout(()=>{Fi.batchRemoteLogsApiRetries++,Fi.sendBatchOfLogs(e)},3e3*Fi.batchRemoteLogsApiRetries)}static sendBeacon(e){Fi.getRemoteLogsBatchRequestOptions(e).then(e=>{const t=Zn(),n=t.baseDomainName+s+e.query_params.os.toLowerCase()+"/"+t.appId+"?"+(new Date).getTime();$e.log(1,"RemoteLogsApi.sendBeacon","[sendBeacon] Remote Logs batch payload: "+JSON.stringify(e)),navigator.sendBeacon(n,JSON.stringify(e))})}}class Hi{static baseLogTag="BatchManager";static reports=[];static remoteLogs=[];static periodicSyncInterval;static lastbatchCreatedAt=null;static lastRemoteLogsbatchCreatedAt=null;static updateEventStore(){if(Hn()!==k.TV){t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Pn,storeName:Nn}).setItem(Nn,Hi.reports)}}static spliceReports(e=Hi.reports.length){const t=Hi.reports.splice(0,e);return Hi.updateEventStore(),t}static spliceRemoteLogs(e=Hi.remoteLogs.length){return Hi.remoteLogs.splice(0,e)}static suspendBatching(){const e=Hi.baseLogTag+".suspendBatching";this.spliceReports(),this.spliceRemoteLogs(),Hi.periodicSyncInterval&&Hi.clearInterval(),Ui.removeEventListeners(),$e.log(2,e,"Batching has stopped.")}static shouldCreateNewBatch(){return!Hi.lastbatchCreatedAt||(new Date).getTime()-Hi.lastbatchCreatedAt>=An.TIME_BETWEEN_BATCHES}static shouldCreateNewBatchForRemoteLogs(){return!Hi.lastRemoteLogsbatchCreatedAt||(new Date).getTime()-Hi.lastRemoteLogsbatchCreatedAt>=An.TIME_BETWEEN_BATCHES}static reactToTriggerEvents(){const e=Hi.baseLogTag+".reactToTriggerEvents";Hi.reports.length>0?($e.log(1,e,`Trigger Events: Created Batch of ${Hi.reports.length} reports`,Ni()),Hi.createBatch()):$e.log(2,e,`${Ni()}: No report's to sync for this event.`),Hi.remoteLogs.length>0?($e.log(1,e,`Trigger Events: Created Batch of remote logs ${Hi.remoteLogs.length} reports`,Ni()),Hi.createRemoteLogsBatch()):$e.log(2,e,`${Ni()}: No logs's to sync for remote logs.`)}static periodicSync(e){const t=Hi.baseLogTag+".periodicSync";Hi.reports.length>0&&Hi.shouldCreateNewBatch()?($e.log(1,t,`Periodic sync: Created Batch of ${Hi.reports.length} reports`,Ni()),Hi.createBatch()):$e.log(2,t,`${Ni()}: No report's to sync at this interval. The next sync will attempt in ${e} seconds`),Hi.remoteLogs.length>0&&Hi.shouldCreateNewBatchForRemoteLogs()?($e.log(1,t,`Periodic sync: Created Batch of remote logs ${Hi.reports.length} reports`,Ni()),Hi.createRemoteLogsBatch()):$e.log(2,t,`${Ni()}: No report's to sync at this interval for remote logs. The next sync will attempt in ${e} seconds`)}static clearInterval(){clearInterval(Hi.periodicSyncInterval),Hi.lastbatchCreatedAt=null}static init(e){Qn.getInstance().then(async t=>{(Hi.isOfflineBatchingSupported(t,e)||e.configs.remoteLogTracking)&&(await Bi.initialize(),Hi.periodicSyncInterval&&Hi.clearInterval(),Hi.periodicSyncInterval=window.setInterval(Hi.periodicSync.bind(this,e.configs.periodicFlushTime),1e3*e.configs.periodicFlushTime),Ui.addListeners())})}static sendBatch(e){const t=Hi.baseLogTag+".sendBatch";return new Promise(n=>{try{zi.sendBatchOfReports(e).then(()=>{Hi.lastbatchCreatedAt=(new Date).getTime(),n(!0)})}catch(e){$e.error(1,t,"Error in sending batch",e),n(!1)}})}static sendRemoteLogs(e){const t=Hi.baseLogTag+".sendRemoteLogs";return new Promise(n=>{try{Fi.sendBatchOfLogs(e).then(()=>{Hi.lastRemoteLogsbatchCreatedAt=(new Date).getTime(),n(!0)})}catch(e){$e.error(1,t,"Error in sending batch of remote logs",e),n(!1)}})}static createBatch(e){if(Hi.reports.length>0){const t=Hi.spliceReports(e);Hi.sendBatch(t)}}static createRemoteLogsBatch(e){if(Hi.remoteLogs.length>0){const t=Hi.spliceRemoteLogs(e);Hi.sendRemoteLogs(t)}}static addReport(e,t){const n=Hi.baseLogTag+".addReport",i=new Li(e);return Ai(i)?($e.error(1,n,wi(i.EVENT_ACTION)),!1):(Hi.reports.push(i),Ai(Hi.reports)?(Hi.reports.pop(),$e.log(1,n,`Created Batch of ${Hi.reports.length} reports as payload size would have breached after adding new event to this batch: "${i.EVENT_ACTION}"`,Ni()),Hi.createBatch(),Hi.reports.push(i),Hi.updateEventStore()):(Hi.updateEventStore(),Hi.reports.length===t&&($e.log(1,n,`Created Batch of ${t} reports`,Ni()),Hi.createBatch(t))),!0)}static sendBeacon(){const e=Hi.baseLogTag+".sendBeacon";Hi.reports.length>0&&($e.log(1,e,`Window Unload: Created batch of ${Hi.reports.length} reports`,Ni()),zi.sendBeacon(Hi.spliceReports())),Hi.remoteLogs.length>0&&($e.log(1,e,`Window Unload: Created Remote Logs batch of ${Hi.remoteLogs.length} reports`,Ni()),Fi.sendBeacon(Hi.spliceRemoteLogs()),Hi.lastRemoteLogsbatchCreatedAt=(new Date).getTime())}static async flushReports(e=!1){const t=Hi.baseLogTag+".flushReports";try{e&&Ui.removeEventListeners(),Hi.reports.length>0&&($e.log(1,t,`Flushed ${Hi.reports.length} reports`,Ni()),await Hi.sendBatch(Hi.spliceReports())),Hi.remoteLogs.length>0&&($e.log(1,t,`Flushed ${Hi.remoteLogs.length} remote logs`,Ni()),await Hi.sendRemoteLogs(Hi.spliceRemoteLogs()))}catch(e){$e.error(1,t,"Error in flushing reports",e)}}static isOfflineBatchingSupported(e,t){return t||(t=gn.get(be.WEB_SETTINGS)),Hi.isBatchingSupported(t,e)}static addRemoteLogs(e,t=15){const n=Hi.baseLogTag+".addRemoteLogs";Hi.remoteLogs.push(e),Hi.remoteLogs.length===t&&($e.log(1,n,`Created Batch of ${t} reports`,Ni()),Hi.createRemoteLogsBatch(t))}static isBatchingSupported(e,t){try{const n=Hn();return!(!e?.configs.isBatchingEnabled||("web"!==n||t.name!==Qn.BROWSER_NAMES.CHROME&&t.name!==Qn.BROWSER_NAMES.EDGE&&t.name!==Qn.BROWSER_NAMES.OPERA)&&("mobile"!==n||Qn.isIOS()||t.name!==Qn.BROWSER_NAMES.CHROME&&t.name!==Qn.BROWSER_NAMES.OPERA)||!navigator.sendBeacon)}catch(e){$e.error(1,"BatchManager.isBatchingSupported",e)}}}const Vi=Hi;class Wi{static baseLogTag="ReportPostData";e;a;c;h;identifiers;meta;url;nie;constructor(){const e=Wi.baseLogTag+".constructor";let t=li.getSync().getAttribute("id");t=t?t.toString():void 0;const n=window.analytics;let i,a;if(n){a=n._VERSIONS;try{i=n.user().anonymousId()}catch(t){$e.error(1,e,"Error getting anonymous id from segment api",t)}}this.c=void 0,this.h="";const r=jn.getIdentityMap();(t||i||r?.userIdentities)&&(this.identifiers={moe_user_id:t,segment_id:i,user_identities:r?.userIdentities||void 0,previous_identities:r?.previousIdentities||void 0}),this.meta={bid:vn(),segmentSdkData:n?a:void 0}}}class Gi{static baseLogTag="ReportClass";status;type;getParams;postData;event;isPortfolioAttribute;constructor(e,t,n,i=ti.USER_ATTRIBUTE_LEVEL.PROJECT){Gi.baseLogTag;this.type=e,this.getParams=t,this.event=n,this.isPortfolioAttribute=i===ti.USER_ATTRIBUTE_LEVEL.PORTFOLIO,this.postData=new Wi;const a={},r={};for(const e of n.attributes)if(e&&null!=e.key&&(this.status=Gi.STATUS.VALID,null!=e.value))if("function"==typeof e.value.getMonth){const t={};t[e.key]=Math.round(e.value.getTime()-6e4*e.value.getTimezoneOffset()),null==r.timestamp&&(r.timestamp=[]),r.timestamp.push(t)}else a[e.key]=e.value;var s;this.postData.e=n.name,this.postData.a=a,this.postData.c=(s=r,0===Object.keys(s).length&&s.constructor===Object?void 0:r),window&&window.location&&null!=window.location.href&&(this.postData.url=window.location.href)}}!function(e){let t,n;!function(e){e[e.INVALID=0]="INVALID",e[e.VALID=1]="VALID"}(t=e.STATUS||(e.STATUS={})),function(e){e[e.USER_ATTRIBUTE=0]="USER_ATTRIBUTE",e[e.EVENT=1]="EVENT"}(n=e.REPORT_ADD_TYPE||(e.REPORT_ADD_TYPE={}))}(Gi||(Gi={}));const Ki=Gi;class qi{name;attributes;timestamp;constructor(e,t,n=!0){this.name=e,this.attributes=t,this.timestamp=(new Date).getTime(),n&&this.attributes.push(new ti(ce,location.href))}static createUserAttributeEvent(e){return new Promise((t,n)=>{const i=[],a=e.key;switch(e.key){case"id":e.key=o;break;case"email":e.key=c;break;case"name":e.key=l;break;case"first_name":e.key=d;break;case"last_name":e.key=g;break;case"mobile":e.key=u;break;case"gender":e.key=p;break;case"birthday":e.key=m}i.push(e),e.key!==a&&$e.log(2,"Event.createUserAttributeEvent","Key changed to MoE reserved keyname: ",e.key),t(new qi(W,i,!1))})}static createEvent(e,t,n){return new Promise((i,a)=>{li.get().then(async a=>{try{const r=new ti(le,!!a.getAttribute("id")),s=new Pi,o=new ti(de,s.getNumberOfSessions()<=bn);t.push(r,o),i(new qi(e,t,n))}catch(e){$e.error(1,"Event.createEvent","Error occurred in create events ",e)}})})}}class $i{static history=[];static listeners=[];static addEvent(e){$i.history.push(e),$i.listeners.forEach(t=>{t(e)})}static getHistory(){return $i.history}static addEventListener(e){$i.listeners.push(e)}static clear(){$i.history=[]}static clearAll(){$i.history=[],$i.listeners=[]}}class Yi{static track(e,t,n){const i="MoEngage.event.trackEvent";return new Promise(async(a,r)=>{if(!Ei())return $e.warn(2,i,`Not tracking the event "${e}" as Web SDK has been disabled.`),void a(!1);let s;n=!!n;try{s=await Xn()}catch(n){return $e.warn(1,i,"SDK not yet initialized. Caching event and will track when SDK is initialized.",n),window.moengage_q?.push({f:"track_event",a:[e,t]}),void a(!1)}if("string"==typeof e&&e)if(s.configs.blacklistedEvents&&s.configs.blacklistedEvents.includes(e))$e.error(1,i,`This event "${e}" is blacklisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is blacklisted.`});else if(!yn.includes(e)||s.configs.whitelistedEvents&&s.configs.whitelistedEvents.includes(e))try{const r=[];if(null==t||null!==t&&t===Object(t)&&"[object Object]"===Object.prototype.toString.call(t)){null==t&&(t={});for(const e in t)t.hasOwnProperty(e)&&r.push(new ti(e,t[e]));const i=new Pi;await i.initiateSessionAndSource(s);const o=await qi.createEvent(e,r);$i.addEvent(o),s?.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP?.handleInSessionEvent(o),zi.collectGetParams().then(t=>{bi(e)&&delete t.push_id;const r=new Ki(Ki.REPORT_ADD_TYPE.EVENT,t,o),s={session_id:i.getSessionKey(),start_time:i.getSessionStartTime(),background_initiated:0},c=[],l=i.getActiveSource();l&&(i.setCurrentSource(l),c.push(l)),r.postData.meta.session=s,c.length&&(r.postData.meta.source=c),i.isNonEventInteractive(o)&&(r.postData.nie=1),zi.reportAdd(r,n).then(()=>{i.isNonEventInteractive(o)||i.extendSession(),a(!0)})})}else $e.error(1,i,`Event attributes were not passed a key-value pair object for event: ${e}`),a({error:5002,message:"Event value needs to be a key-value pair object"})}catch(e){$e.error(1,i,"Error occurred in tracking events ",e)}else $e.log(2,i,`This event "${e}" has not been whitelisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is not whitelisted.`});else $e.error(1,i,"Event name not a string or null or empty string:",e),a({error:5001,message:"Event name can not be null"})})}}var ji;!function(e){e.PROMPT="prompt",e.GRANTED="granted",e.DENIED="denied",e.DISMISSED="dismissed"}(ji||(ji={}));class zi{static baseLogTag="MoeApi";static onDeviceAdd=new Gn;static webSdkApiRetries=1;static offlineEvents=[];static addReportApiRetries=1;static isExecutingDeviceAdd=!1;static deviceAdd(e=!0){const t=zi.baseLogTag+".deviceAdd";return zi.isExecutingDeviceAdd?($e.warn(2,t,"Device add is already in progress. Skipping this call."),Promise.resolve(!1)):(zi.isExecutingDeviceAdd=!0,new Promise(async(t,n)=>{if(!Ei())return void t(!1);const i=je.get();return zi.collectGetParams(a.DEVICE_ADD).then(r=>{const s={queryParams:r={...r,url:window.location.href}};Un.post(i.baseDomainName+a.DEVICE_ADD,s).then(()=>{e?li.get().then(e=>{e.deviceAdded=!0,e.save().then(()=>{Xi.startPeriodicClear(be.Q.REPORT),zi.onDeviceAdd.res()})}).then(()=>{this.trackDeviceAttributes(),zi.isExecutingDeviceAdd=!1,t(!0)}):(zi.isExecutingDeviceAdd=!1,t(!0))}).catch(e=>{un.enqueue(be.Q.DEVICE,!0),zi.isExecutingDeviceAdd=!1,n(!1)})})}))}static trackDeviceAttributes(){const e=zi.baseLogTag+".trackDeviceAttributes";return new Promise(async(t,n)=>{try{let t=Hn().toUpperCase();t="WEB"===t?"DESKTOP":t,Yi.track(te,{deviceType:t});let n=!1;Qn.getInstance().then(t=>{Xn().then(async i=>{if(Kn(i,t)){let t=ni();if(!t)try{const e=Ge()||{};let n="";"function"==typeof e.getPermissionState&&(n=await e.getPermissionState()),n===ji.GRANTED&&(t=!0)}catch(t){$e.error(2,e,"Failed to get push notification permission state.",t)}n=t}}).then(()=>{Yi.track(te,{[E]:!!n,source:"deviceAdd"}),gn.set(be.OPTED_STATUS_TRACK_TIME,Date.now())})})}catch(t){$e.error(2,e,"Failed to track device attributes.",t)}t(null)})}static reportAdd(e,t){const n=zi.baseLogTag+".reportAdd";return new Promise((i,a)=>{t=!!t,Xn().then(r=>{li.get().then(s=>{const o=We.get(Ce)&&r?.configs?.landingPageTracking;try{if(o&&!oi.shouldTriggerSubscriberBilling({user:s,sdkSettings:r,attributeNames:[e.event.attributes[0].key]}))return $e.log(2,n,"Landing page tracking enabled (both flag and config), processing report immediately:",e.event.name),un.isEmpty(be.Q.REPORT)||($e.log(2,n,"Flushing queued reports as landing page tracking is enabled"),Xi.clear(be.Q.REPORT)),zi.executeReportAdd(e,t,i,a)}catch(e){$e.error(2,n,"Error checking push subscription attribute acceptance for landing page tracking:",e)}return r.isPushSubBilling?zi.handleReportPushSubBilling(e,t,r,s,i,a):zi.executeReportAdd(e,t,i,a)}).catch(r=>($e.error(1,n,"Error getting user data for push subscriber billing:",r),zi.executeReportAdd(e,t,i,a)))}).catch(e=>{$e.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})})}static executeReportAdd(e,t,n,i){zi.reportAddInternal(e,t).then(()=>{this.sendBroadcast(e),n(!0)}).catch(()=>{i(!1)})}static handleReportPushSubBilling(e,t,n,i,a,r){const s=zi.baseLogTag+".handleReportPushSubBilling";i.deviceAdded?zi.executeReportAdd(e,t,a,r):($e.log(2,s,"Device not added yet, queuing report:",e.event.name),zi.queueReportForDeviceAdd(e,n,i),a(!0))}static queueReportForDeviceAdd(e,t,n){const i=zi.baseLogTag+".queueReportForDeviceAdd";un.enqueue(be.Q.REPORT,e),$e.log(2,i,"Report added to queue as device not added yet:",e.event.name),e.type===Ki.REPORT_ADD_TYPE.USER_ATTRIBUTE&&zi.handleUserAttributeForPushSubBilling(e,t,n)}static handleUserAttributeForPushSubBilling(e,t,n){const i=zi.baseLogTag+".handleUserAttributeForPushSubBilling";e.event.attributes&&0!==e.event.attributes.length&&(oi.shouldTriggerSubscriberBilling({user:n,sdkSettings:t,attributeNames:[e.event.attributes[0].key]})?($e.log(2,i,"Attribute accepted for push sub billing."),zi.deviceAdd()):$e.log(2,i,"Attribute NOT accepted for push sub billing."))}static sendBroadcast(e){Tn.NAMES.includes(e.event.name)&&Ti.broadcastToWindow({topic:Tn.TOPIC,name:e.event.name,data:e.event.attributes})}static getSegmentId(){const e=window.analytics;if(e&&e.user)return e.user().anonymousId()}static getBatchRequestOptions(e){return new Promise(t=>{zi.collectGetParams(In.REPORT_ADD).then(async n=>{const i=zi.getSegmentId()||"",a=li.getSync(),r=je.get(),s=new Pi,o={session_id:s.getSessionKey(),start_time:s.getSessionStartTime(),background_initiated:0},c=[],l=s.getActiveSource();l&&(s.setCurrentSource(l),c.push(l));const{userIdentities:d,previousIdentities:g}=await jn.getIdentifiersFromIdentities(),u={user_identities:d||void 0,previous_identities:g||void 0},p=await this.getParamsFromCookie();let m=null;const h={...n};null!==p&&"object"==typeof p&&(m=p.moe_user_id,null!==p.push_id&&(h.push_id=p.push_id),null!==p.unique_id&&(h.unique_id=p.unique_id));const f={query_params:h,identifiers:{moe_user_id:null!==m?m:a.getAttribute("id")||d?.uid||void 0,segment_id:i||void 0,...u,moe_aid:fi()},meta:{bid:vn(),request_time:(new Date).toISOString(),session:o,source:c.length?c:void 0,initiator:r?.proxyDomains?.api?.length?"proxy_server":void 0},viewsCount:e.length,viewsInfo:[...e]};t(f)})})}static getParamsFromCookie(){const e=`${this.baseLogTag}.getMoeUserIdFromCookies`,t={moe_user_id:null,unique_id:null,push_id:null};return new Promise(n=>{Xn().then(e=>{if(e?.isDomainLevelStorage){const e=ln.get(be.USER_DATA),n=ln.get(be.SUBSCRIPTION_DETAILS)?.token;e&&(e.attributes?.length&&e.attributes.find(e=>e.key===o)?t.moe_user_id=e.attributes.find(e=>e.key===o).value:t.moe_user_id=void 0,e.deviceUuid?.length&&(t.unique_id=e.deviceUuid)),n?.length&&_i(n)?t.push_id=n:t.push_id=void 0}n(t)}).catch(i=>{$e.error(2,e,"Error occurred while trying to fetch SDK Settings: ",i),n(t)})})}static async addReportsToOfflineDB(e,t){const n=zi.baseLogTag+".addReportsToOfflineDB",i=await zi.getBatchRequestOptions([]);await Bi.offlineDataStore.setItem(t||`report_add_${(new Date).getTime()}`,e),await Bi.offlineDataStore.setItem("requestMetaData",i),await Bi.offlineDataStore.setItem(t||`batch_${(new Date).getTime()}`,{...i,viewsCount:e.length,viewsInfo:e}),navigator.serviceWorker&&navigator.serviceWorker.ready.then(e=>{e.sync?e.sync.register(Mn).then(()=>{$e.log(2,n,"offline sync event registered")}).catch(e=>{$e.error(1,n,"Service worker sync error",e)}):$e.log(2,n,"Service worker sync unavailable")})}static sendReportBeacon(e,t,n){const i=zi.baseLogTag+".sendReportBeacon";try{if(!e&&navigator.sendBeacon&&navigator.sendBeacon(t,new Blob([JSON.stringify(n)],{type:"text/plain;charset=UTF-8"})))return!0}catch(e){$e.error(2,i,"Failed to send Report call with Beacon:",e)}return!1}static sendBatchOfReports(e){const t=zi.baseLogTag+".sendBatchOfReports";return new Promise((n,i)=>{zi.getBatchRequestOptions(e).then(a=>{const r=je.get(),s=r.baseDomainName+In.REPORT_ADD+r.appId;Xn().then(i=>window.navigator.onLine?zi.sendReportBeacon(i.configs.isBeaconDisabled,s,a)?($e.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),$e.log(1,t,"Batch sent to MoEngage successfully through beacon"),void n(!0)):void Un.post(s,{postData:a}).then(()=>{$e.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),$e.log(1,t,"Batch sent to MoEngage successfully"),n(!0)}).catch(a=>{$e.error(1,t,"Batch Report add API failed",a),n(this.sendToOfflineTracking(e,a,i))}):this.sendToOfflineTracking(e,Cn,i)).catch(e=>{e!==Cn&&$e.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),i(e)})})})}static sendToOfflineTracking(e,t,n){const i=zi.baseLogTag+".sendToOfflineTracking";return new Promise((a,r)=>{if(!Ei())return $e.warn(2,i,"Not adding report(s) to offline db as SDK has been disabled."),void r(t);Qn.getInstance().then(s=>{Vi.isOfflineBatchingSupported(s,n)?($e.error(1,i,"Add Report API failed, adding reports to offline db. ",t),zi.addReportsToOfflineDB(e).then(()=>{$e.log(2,i,"Network offline: Batch added to offline db")}),a(!0)):($e.warn(1,i,"Report not added to offline db. Offline tracking is supported only if batching is enabled. It is supported only on Chrome, Edge and Opera browsers on desktop web and Chrome and Opera browsers on Android web."),r(t))}).catch(()=>{r(t)})})}static checkAndTrackUniversalLink(){const e=zi.baseLogTag+".trackUniversalLink",t=kn(window.location.href)[Dn];if(t){if($e.log(2,e,"Universal link found: ",t),!Ei())return void $e.warn(2,e,"Not tracking universal link as Web SDK has been disabled.");li.get().then(async e=>{Qn.getInstance().then(n=>{const i=je.get(),a={meta_data:{app_id:i.appId,request_id:vn(),project_code:i.projectId||void 0,sdk_ver:"2.64.00",app_ver:"1.0",os:n.os,unique_id:e.deviceUuid,device_unique_id:this.getDeviceUniqueId(),url:window.location.href},tracking_data:{timestamp:(new Date).getTime(),moeq:t}};navigator.sendBeacon(i.baseDomainName+wn.TRACK,JSON.stringify(a))})})}}static reportAddInternal(e,t){const n=zi.baseLogTag+".reportAddInternal";return new Promise((i,r)=>{Xn().then(r=>{Qn.getInstance().then(s=>{if(t){const t=zi.getUpdatedPushDetails();for(const n in t)!t.hasOwnProperty(n)||bi(e.event.name)&&"push_id"===n||(e.getParams[n]=t[n]);const n=Vn(),o={queryParams:{...e.getParams,...n}};if(e.postData.nie){const t=Object.assign({},e);delete t.postData.meta.source,delete t.postData.meta.session,o.postData=t.postData}else o.postData=e.postData;let c=je.get().baseDomainName;c+=a.DEVICE_ADD,Un.post(c,o).then(()=>{let t=Hn().toUpperCase();t="WEB"===t?"DESKTOP":t,Yi.track(te,{deviceType:t}),i(zi.handleReportAddSuccess(e))}).catch(t=>{Vi.isBatchingSupported(r,s)?un.enqueue(be.Q.DEVICE,e):zi.handleReportAddFailure(e,t)})}else if(Vi.isBatchingSupported(r,s))Vi.addReport(e,r.configs.eventBatchCount)&&($e.log(1,n,"Event batched successfully:",e.event),this.addEventsToIDB(e.event)),i(!0);else{const t=new Li(e);Ai(t)?($e.error(1,n,wi(t.EVENT_ACTION)),i(!1)):zi.sendBatchOfReports([t]).then(()=>{i(zi.handleReportAddSuccess(e))}).catch(t=>{zi.handleReportAddFailure(e,t)})}})}).catch(e=>{$e.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),r(!1)})})}static handleReportAddSuccess(e){const t=zi.baseLogTag+".handleReportAddSuccess";return e.type===Ki.REPORT_ADD_TYPE.EVENT?($e.log(1,t,"Event tracked successfully:",e.event),this.addEventsToIDB(e.event)):e.type===Ki.REPORT_ADD_TYPE.USER_ATTRIBUTE&&$e.log(1,t,"User attribute added successfully:",e.event.attributes),zi.addReportApiRetries=1,!0}static handleReportAddFailure(e,t){const n=zi.baseLogTag+".handleReportAddFailure";$e.error(1,n,"Add Report API failed",t),e.type===Ki.REPORT_ADD_TYPE.EVENT?$e.log(1,n,"Queueing unsuccessful event tracking:",e.event):e.type===Ki.REPORT_ADD_TYPE.USER_ATTRIBUTE&&$e.log(1,n,"Queueing unsuccessful user attribute add:",e.event.attributes),zi.addReportApiRetries<3&&setTimeout(()=>{zi.addReportApiRetries++,un.enqueue(be.Q.REPORT,e),Xi.startPeriodicClear(be.Q.REPORT)},3e3*zi.addReportApiRetries)}static checkIfTokenValid(e){const t=je.get().baseDomainName+a.DEVICE_TOKEN_CHECK,n=je.get();return new Promise(i=>{e?li.get().then(a=>{const r={queryParams:{app_id:n.appId,unique_id:a.deviceUuid,push_id:e}};Un.post(t,r).then(e=>{200===e.status?i(!0):i(!1)}).catch(e=>{i(!1)})}):i(!1)})}static collectGetParams(e){return new Promise((t,n)=>{li.get().then(async n=>{let i=je.get();null!=i&&null!=i.appId||(i=new je(gn.get(be.INIT_DATA)));const r=await Xn(),s=new Date,o=Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds());Qn.getInstance().then(s=>{const c=this.getDeviceUniqueId(),l=Vn(e,[a.REPORT_ADD,a.DEVICE_ADD,In.REPORT_ADD]),d={os:s.os,os_platform:s.osPlatform,is_incognito:s.isIncognito,app_id:i.appId,os_ver:s.name,sdk_ver:"2.64.00",model:s.name,app_ver:"1.0",device_ts:Number(o),device_tz_offset:(-6e4*(new Date).getTimezoneOffset()).toString(),unique_id:n.deviceUuid,device_tz:(new Date).getTimezoneOffset().toString(),device_unique_id:c,...l};i.projectId&&(d.project_code=i.projectId);const g=n.getAttribute("cart_token");$n()&&g&&r?.configs.isMultiIdEnabled&&e!==a.DEVICE_ADD&&(d.cart_token=g);const u=ni();_i(u)&&(d.push_id=u),s.isWebPushCompatible()&&(qn(r.webPushPlatformData,s)?(d.subscription_type="vapid",d.vapid_public=Yn(r.webPushPlatformData,s)):d.subscription_type="normal"),null!=i.environment&&(d.environment=i.environment);const p=gn.get(be.SUBSCRIPTION_DETAILS);if(null!=p&&null!=p.keys){for(const e in p.keys)d["keys_"+e]=encodeURI(p.keys[e]);null!=p.endpoint&&(d.endpoint=encodeURI(p.endpoint)),d.expirationTime=p.expirationTime}t(d)})})})}static getDeviceUniqueId(){return gn.get(be.DEVICE_DATA)?.deviceUniqueId||void 0}static getUpdatedPushDetails(){const e={},t=gn.get(be.SUBSCRIPTION_DETAILS);if(null!=t){const n=t.token;if(null!=n&&"NA"!==n&&""!==n&&"null"!==n&&(e.push_id=n),t.keys){for(const n in t.keys)e["keys_"+n]=encodeURI(t.keys[n]);null!=t.endpoint&&(e.endpoint=encodeURI(t.endpoint)),e.expirationTime=t.expirationTime}}return e}static sendBeacon(e){if(!window.navigator.onLine)return this.sendToOfflineTracking(e,Cn);zi.getBatchRequestOptions(e).then(e=>{const t=je.get(),n=t.baseDomainName+In.REPORT_ADD+t.appId+"?"+(new Date).getTime();$e.log(1,"MoeApi.sendBeacon","[sendBeacon] batch payload: "+JSON.stringify(e)),navigator.sendBeacon(n,JSON.stringify(e))})}static addEventsToIDB(e){if(Hn()!==k.TV){const n=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne,storeName:Re});n?.setItem(e.name,e)}}}const Ji=n(372),Qi=be.Q;class Xi{static baseLogTag="QManager";static intervals={};static processing={};static clear(e){const t=Xi.baseLogTag+".clear";if(!Ei())return;const n=[];for(;!un.isEmpty(e);)switch(e){case Qi.REPORT:const i=un.dequeue(Qi.REPORT);n.push(e=>{zi.reportAdd(i).then(()=>{e()})});break;case Qi.DEVICE:un.dequeue(Qi.DEVICE)&&n.push(e=>{zi.deviceAdd().then(()=>{e()})});break;default:$e.error(1,t,"Do not know how to handle queue with name:",e)}setTimeout(()=>{Xi.processing[e]=!0,Ji(n,5,(t,n)=>{Xi.processing[e]=!1})},0)}static startPeriodicClear(e){const t=Xi.baseLogTag+".startPeriodicCleanQ";Xi.clearInterval(e);const n=()=>{un.isEmpty(e)?($e.log(1,t,"If you see multiple event tracks with same, they were captured over multiple visits or page refreshes."),He(Xi.processing,e,!1)||Xi.clearInterval(e)):(Xi.clear(e),$e.log(1,t,"Starting periodic queue clear for",e))};n(),Xi.intervals[e]=setInterval(n,6e3)}static clearInterval(e){null!=Xi.intervals[e]&&(clearInterval(Xi.intervals[e]),Xi.intervals[e]=null)}}const Zi=()=>{const e=gn.get(be.USER_DATA);return e&&e.deviceUuid};const ea=class{isBeaconDisabled;isCardsModuleEnabled;isWebPersonalizationModuleEnabled;eventBatchCount;logLevel;periodicFlushTime;isBatchingEnabled;sessionInactiveDuration;isRemoteLoggingEnabled;sourceExtraParams;whitelistedEvents;blacklistedEvents;blacklistedPortfolioUserAttributes;isAppActive;remoteLogTracking;subscriberBasedBillingAttributes;isMultiIdEnabled;userAttributeCacheTime;portfolioUserAttributeCacheTime;identityAttributes;landingPageTracking;constructor(e){this.isBeaconDisabled=this.parseSentryBooleanFlag(He(e,"b_d",!1)),this.isCardsModuleEnabled=this.parseSentryBooleanFlag(He(e,"c_s",!1)),this.isWebPersonalizationModuleEnabled=this.parseSentryBooleanFlag(He(e,"c_w_p_e",!1)),this.eventBatchCount=He(e,"e_b_c",15),this.logLevel=He(e,"log_level"),this.periodicFlushTime=He(e,"p_f_t",30),this.isBatchingEnabled=this.parseSentryBooleanFlag(He(e,"s_e_b_e",!1)),this.sessionInactiveDuration=He(e,"s_i_d",1800),this.isRemoteLoggingEnabled=this.parseSentryBooleanFlag(He(e,"s_log",!1)),this.sourceExtraParams=He(e,"src_ext",[]),this.whitelistedEvents=He(e,"w_e",[]),this.blacklistedEvents=He(e,"b_e",[]),this.blacklistedPortfolioUserAttributes=He(e,"p_b_ua",[]),this.isAppActive=this.parseSentryBooleanFlag(He(e,"a_s",!0)),this.remoteLogTracking=this.isRemoteLoggingEnabled&&!!this.logLevel,this.subscriberBasedBillingAttributes=He(e,"s_b_a",[]),this.isMultiIdEnabled=this.parseSentryBooleanFlag(He(e,"m_i_e",!1)),this.userAttributeCacheTime=He(e,"u_a_c_t",43200),this.portfolioUserAttributeCacheTime=He(e,"p_u_a_c_t",43200),this.identityAttributes=He(e,"u_i_s",[]),this.landingPageTracking=this.parseSentryBooleanFlag(He(e,"lp_t",!1))}parseSentryBooleanFlag(e="blocked"){return"allowed"===e||!0===e||"true"===e}};class ta{mobile;web;constructor(e){this.mobile=new na(He(e,"mobile",{})),this.web=new na(He(e,"web",{}))}}class na{nudge;banner;allowButton;dismissButton;logo;constructor(e){this.nudge=e.nudge?new ia(e.nudge):void 0,this.banner=e.banner?new ia(e.banner):void 0,this.allowButton=e.allow_button?new aa(e.allow_button):void 0,this.dismissButton=e.dismiss_button?new aa(e.dismiss_button):void 0,this.logo=e.logo?new sa(e.logo):void 0}}class ia{title;body;backgroundColor;icon;altText;constructor(e){this.title=new ra(He(e,"title",{})),this.body=e?.body?new ra(He(e,"body",{})):void 0,this.backgroundColor=e?.background_color,this.icon=e?.icon,this.altText=e?.alt_text||""}}class aa{textColor;text;backgroundColor;constructor(e){this.textColor=e?.text_color,this.text=He(e,"text",""),this.backgroundColor=e?.background_color}}class ra{textColor;text;constructor(e){this.textColor=e?.text_color,this.text=He(e,"text","")}}class sa{logoUrl;logoColor;altText;constructor(e){this.logoUrl=e?.logo_url||"",this.logoColor=e?.logo_color||"",this.altText=e?.alt_text||""}}var oa;!function(e){e.ONE_STEP="1-step",e.TWO_STEP="2-step",e.SELF_HANDLED="self-handled"}(oa||(oa={}));class ca{subscriptionMode;vapidPublicKey;constructor(e){this.subscriptionMode=He(e,"subscription_mode","vapid"),this.vapidPublicKey=He(e,"vapid_public_key",null)}}class la{chrome;firefox;constructor(e){this.chrome=new ca(e?.chrome),this.firefox=new ca(e?.firefox)}}const da=class{configs;settingsVersion;isDomainLevelStorage=!1;toShowOverlay;loadTime;promptAgain;optInType;isWebPushEnabled;optInPreview;overlay;webPushPlatformData;isPushSubBilling;isBrandingHidden;constructor(e){this.configs=new ea({}),this.settingsVersion="V2",this.isDomainLevelStorage=He(e,"domain_level_storage",!1),Hn()===k.TV&&(this.isDomainLevelStorage=!1),this.toShowOverlay=He(e,"show_overlay",!1),this.loadTime=He(e,"load_time",0),this.promptAgain=He(e,"prompt_again",24),this.optInType=He(e,"opt_in_type",oa.TWO_STEP),this.isWebPushEnabled=He(e,"is_enabled",!1),this.optInPreview=new ta(He(e,"opt_in_preview",{})),this.overlay=He(e,"overlay",null),this.webPushPlatformData=new la(e.web_push_platform_data),this.isPushSubBilling=He(e,"sub_billing",!1),this.isBrandingHidden=He(e,"hide_moe_branding",!1),this.configs=new ea(e)}};class ga{static BASE_LOG_TAG="CoreApi";static sdkSettings;static RESET_DURATION_IN_HOURS=24;static API_URLS={SETTINGS:e=>`${e}v2/websdksettings`,CONFIG:(e,t,n)=>`${e}v3/sdkconfig/${t}/${n}`};static webSdkApiRetries=1;static WEB_SDK_API_MAX_RETRIES=3;static getWebSDKSettings(){ga.BASE_LOG_TAG;return new Promise((e,t)=>{const n=ga.getInitData(),i=n=>{ga.isAppBlocked(n)?t(!1):(n?.isDomainLevelStorage&&ln.set(Pe,n.isDomainLevelStorage),e(n))};if(ga.sdkSettings)i(ga.sdkSettings);else if(Ei()){const a=(new Date).getTime(),r=gn.get(be.SETUP_TIME),s=()=>ga.getAndPersistWebSettings(n).then(t=>e(t)).catch(e=>t(!1));if(null==r||n.debugLevel>0)s();else if(gn.get(be.SDK_VERSION)!==Ge().getSdkVersion())s();else if(a-r>60*ga.RESET_DURATION_IN_HOURS*60*1e3)s();else{const e=gn.get(be.WEB_SETTINGS);e?(ga.sdkSettings=e,i(ga.sdkSettings)):s()}}else{const e=gn.get(be.WEB_SETTINGS);e&&(ga.sdkSettings=e,i(ga.sdkSettings))}})}static getAndPersistWebSettings(e){const t=ga.BASE_LOG_TAG+".getAndPersistWebSettings";return new Promise(async(n,i)=>{try{$e.log(1,t,`Fetching latest settings for workspace id: ${e.appId}${e.projectId?" and project id: "+e.projectId:""}`);const a={queryParams:{app_id:e.appId}},r={postData:{query_params:{unique_id:Zi()}}};e.projectId&&(a.queryParams.project_code=e.projectId,r.postData.query_params.project_code=e.projectId);const s=Un.get(ga.API_URLS.SETTINGS(e.baseDomainName),a),o=Un.post(ga.API_URLS.CONFIG(e.baseDomainName,Fn()?"mweb":"web",e.appId),r);Promise.all([s,o]).then(e=>{let t=e[0].responseText;"string"==typeof t&&(t=JSON.parse(t));let a=e[1].responseText;200===e[1].status&&"string"==typeof a&&(a=JSON.parse(a));let r=t;r=new da({...t.webData,...a}),ga.updateLocalStorage(r),ga.isAppBlocked(r)?i(!1):(ga.sdkSettings=r,ga.sdkSettings?.isDomainLevelStorage&&ln.set(Pe,ga.sdkSettings.isDomainLevelStorage),n(r))}).catch(e=>{$e.error(1,t,"Config API failed",e)})}catch(a){$e.error(1,t,"Settings APi Failed: ",a),ga.webSdkApiRetries<ga.WEB_SDK_API_MAX_RETRIES?setTimeout(()=>{ga.webSdkApiRetries++,n(ga.getAndPersistWebSettings(e))},3e3*ga.webSdkApiRetries):i(!1)}})}static isAppBlocked(e){return!(!e||!e.configs||!1!==e.configs.isAppActive)}static getInitData(){let e=je.get();return null!=e&&null!=e.appId||(e=new je(gn.get(be.INIT_DATA))),e}static updateLocalStorage(e){const t=(new Date).getTime();gn.set(be.WEB_SETTINGS,e),gn.set(be.SETUP_TIME,t),gn.set(be.SDK_VERSION,Ge().getSdkVersion())}}class ua{static baseLogTag="SPAManager";static isObserverRunning;static observer;addURLChangeObserver(e){const t=ua.baseLogTag+".addURLChangeObserver";let n=document.location.href;(()=>{ua.isObserverRunning=!0,$e.log(2,t,"Start listening to URL changes for SPA");const i=document.querySelector("body");ua.observer=new MutationObserver(i=>{i.forEach(i=>{n===window.location.href||fe.some(e=>window.location.href.includes(e))||(n=window.location.href,$e.log(1,t,"URL Change detected",n),ua.pageChangeHandler(e))})});ua.observer.observe(i,{childList:!0,subtree:!0})})()}static pageChangeHandler(e){Ti.broadcastToWindow({topic:N.TOPIC_NAME,name:N.EVENT_NAMES.PAGE_CHANGED}),$i.clearAll();Ge().track_page_view(),e&&gn.copyKeysFromCookie()}static removeURLChangeObserver(){const e=this.baseLogTag+".removeURLChangeObserver";this.isObserverRunning=!1,this.observer?.disconnect(),$e.log(2,e,"SPA URL Change Observer removed.")}}const pa="MOE_LANDING_PAGE_SHOWN",ma="MOE_LANDING_PAGE_CLICKED",ha="MOE_RESPONSE_SUBMITTED";class fa{static baseLogTag="Landing Pages Tracking";constructor(){fa.handlePublicFunctions()}trackClick(e,t){return fa.track(ma,e,{widget_id:t})}trackImpression(e){return fa.triggerDeviceAddForLandingPageTracking(),fa.track(pa,e)}trackFormSubmit(e,t){return fa.track(ha,e,t)}trackEvent(e,t,n){return fa.track(e,t,n)}static track(e,t,n){We.get(Ce)||We.set(Ce,!0);const i=fa.baseLogTag+".track";if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void $e.error(2,i,"Error parsing JSON string:",e)}if(n){if("string"==typeof n)try{n=JSON.parse(n)}catch(e){return void $e.error(2,i,"Error parsing attributes JSON string:",e)}t={...n,...t}}try{return Ge()?($e.log(1,i,e+": Event Tracked"),Ge().track_event(e,{...t})):(window.addEventListener(C.TOPIC_NAME,n=>{if(n.detail.name===C.EVENT_NAMES.MOE_INIT)return $e.log(1,i,e+": Event Tracked"),Ge().track_event(e,{...t})}),Promise.resolve())}catch(e){$e.error(2,i,"Failed Tracking expression",e)}}static triggerDeviceAddForLandingPageTracking(){const e=fa.baseLogTag+".triggerDeviceAddForLandingPageTracking";$e.log(2,e,"Landing page tracking flag set, broadcasting device add request"),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD,data:{reason:"landing_page_tracking_enabled",source:"landing_pages_module"}})}static handlePublicFunctions(){(Ge()||{}).landingPages=fa}}const Ea="moe_segment_cluster",Sa="moe_segment_sw_path",_a="moe_segment_sw_scope",va="moe_segment_enable_spa",ya="moe_segment_cards",Ta="moe_segment_disable_cookies",ba="moe_segment_disable_onsite";class Ia{static baseLogTag="MoEngage";static landingPages=new fa;static getSdkVersion=()=>"2.64.00";static setDebugLevel=async e=>{const t=Ia.baseLogTag+".setDebugLevel",n=Ge();try{"number"==typeof e&&($e.setLogLevel(e,!0),!je.get().disableOnsite&&n?.onsite?.setLogLevel&&n.onsite.setLogLevel(e),ga.getWebSDKSettings().then(t=>{t?.configs.isCardsModuleEnabled&&n?.cards&&n.cards.setLogLevel(e),t?.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP&&window.MoeWebP.setLogLevel&&window.MoeWebP.setLogLevel(e)}).catch(e=>{$e.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}))}catch(e){$e.error(0,t,"Error changing log level:",e)}};static vitals=()=>{const e=gn.get(be.USER_DATA);return{userDetails:e,deviceUuid:e?.deviceUuid,pushToken:gn.get(be.PUSH_TOKEN),softAskStatus:gn.get(be.SOFT_ASK_STATUS),hardAskStatus:gn.get(be.HARD_ASK_STATUS)}};static help=()=>{for(const e in ge)ge.hasOwnProperty(e)&&$e.log(0,"Moengage.help",e,"-",ge[e])};static getBranch=()=>"dev";static handle_page_change=()=>{ga.getWebSDKSettings().then(e=>{ua.pageChangeHandler(e.isDomainLevelStorage)})}}const Aa={getData:(e,t)=>{window.addEventListener(C.TOPIC_NAME,n=>{n.detail.name===C.EVENT_NAMES.OSM_INIT&&Ge()?.onsite.getData(e,t)})},registerCallback:(e,t)=>{window.addEventListener(C.TOPIC_NAME,n=>{n.detail.name===C.EVENT_NAMES.OSM_INIT&&Ge()?.onsite.registerCallback(e,t)})},getSelfHandledOSM:e=>{window.addEventListener(C.TOPIC_NAME,t=>{t.detail.name===C.EVENT_NAMES.OSM_INIT&&Ge()?.onsite.getSelfHandledOSM(e)})}},wa=()=>{},Da={track_event:wa,add_user_attribute:wa,add_first_name:wa,add_last_name:wa,add_email:wa,add_mobile:wa,add_user_name:wa,add_gender:wa,add_birthday:wa,destroy_session:wa,add_unique_user_id:wa,moe_events:wa,location_type_attribute:wa,call_web_push:wa,setDebugLevel:wa},Ca={META:"v3/campaigns/inapp/live",CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/live/",DRAFT_CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/test/",STATS:"v3/campaigns/inapp/live/v2/stats",CAMPAIGNS_PAYLOAD:"v3/campaigns/inapp/live/campaigns",FC_USER_ACTIVITY:"v3/campaigns/inapp/live/fc-user-activity"},Oa={DATABASE_NAME:"moe_onsite",CAMPAIGNS_META:{NAME:"campaigns_meta"},CAMPAIGNS_TAGS:{NAME:"campaigns_tags"},CAMPAIGNS_STATS:{NAME:"campaigns_stats"},EXIT_INTENT_CAMPAIGN_STORE:{NAME:"exit_intent"},SERVICE_META:{NAME:"service_meta",KEYS:{LAST_META_CALL_TIME:"last_meta_call_time",GLOBAL_DELAY:"global_delay_between_inapps",LAST_INAPP_SHOWN_TIME:"last_inapp_shown",LAST_FETCH_SDK_VERSION:"last_fetch_sdk_version",UNIQUE_ID:"unique_id",SESSION_KEY:"session_key"}},PENDING_SECONDARY_EVENTS:{NAME:"pending_secondary_events"},PENDING_TIMER_CAMPAIGNS:{NAME:"pending_timer_campaigns"},TRIGGERING_PRIMARY_EVENTS:{NAME:"triggering_primary_events"}},Pa={OSM:{CLICK:"MOE_ONSITE_MESSAGE_CLICKED",IMPRESSION:"MOE_ONSITE_MESSAGE_SHOWN",DISMISS:"MOE_ONSITE_MESSAGE_DISMISSED",AUTO_DISMIS:"MOE_ONSITE_MESSAGE_AUTO_DISMISS",DELIVERED:"MOE_ONSITE_MESSAGE_DELIVERED",TYPE:"onsite"},WP:{CLICK:"MOE_WEBP_MESSAGE_CLICKED",IMPRESSION:"MOE_WEBP_MESSAGE_SHOWN",DISMISS:"MOE_WEBP_MESSAGE_DISMISSED",DELIVERED:"MOE_WEBP_MESSAGE_DELIVERED",TYPE:"webp"}},Na={ATTEMPTED:{CAMPAIGN_ATTEMPTED:"ATM"},PRIORITIZED:{CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE:"PRT_HIGH_PRT_CMP_AVL",CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN:"PRT_MAX_TIM_SWN",CAMPAIGN_PRIORITY_MIN_DELAY:"PRT_MIN_DEL",CAMPAIGN_PRIORITY_GLOBAL_DELAY:"PRT_GBL_DEL",CAMPAIGN_PRIORITY_EXPIRED:"PRT_EXP",PRIORITY_STAGE_ALL_CAMPAIGNS_FREQUENCY_CAPPING_LIMIT_REACHED:"PRT_FC_A_C",PRIORITY_STAGE_PAGE_LOAD_FREQUENCY_CAPPING_LIMIT_REACHED:"PRT_FC_P_L",PRIORITY_STAGE_CUSTOM_EVENT_FREQUENCY_CAPPING_LIMIT_REACHED:"PRT_FC_C_E",PRIORITY_STAGE_EXIT_INTENT_FREQUENCY_CAPPING_LIMIT_REACHED:"PRT_FC_E_I",PRIORITY_STAGE_ALL_TAGS_FREQUENCY_CAPPING_FAILED:"PRT_FC_ALL_T",PRIORITY_STAGE_ANY_TAGS_FREQUENCY_CAPPING_FAILED:"PRT_FC_ANY_T"},DELIVERED:{CAMPAIGN_DELIVERED_API_FAILURE:"DLV_API_FLR",CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING:"DLV_MAND_PARM_MIS"},IMPRESSION:{CAMPAIGN_IMPRESSION_URL_CHANGED:"IMP_URL_CHG",CAMPAIGN_IMPRESSION_GLOBAL_DELAY:"IMP_GBL_DEL",CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN:"IMP_MAX_TIM_SHW",CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE:"IMP_ANTR_CMP_VISB",CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY:"IMP_CNCL_BFR_DEL",IMPRESSION_STAGE_ALL_CAMPAIGNS_FREQUENCY_CAPPING_LIMIT_REACHED:"IMP_FC_A_C",IMPRESSION_STAGE_EXIT_INTENT_FREQUENCY_CAPPING_LIMIT_REACHED:"IMP_FC_E_I",IMPRESSION_STAGE_PAGE_LOAD_FREQUENCY_CAPPING_LIMIT_REACHED:"IMP_FC_P_L",IMPRESSION_STAGE_CUSTOM_EVENT_FREQUENCY_CAPPING_LIMIT_REACHED:"IMP_FC_C_E",IMPRESSION_STAGE_ALL_TAGS_FREQUENCY_CAPPING_FAILED:"IMP_FC_ALL_T",IMPRESSION_STAGE_ANY_TAGS_FREQUENCY_CAPPING_FAILED:"IMP_FC_ANY_T"},EVALUATION:{CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED:"EVL_PATH_TIME_EXP",CAMPAIGN_EVALUATION_USER_NOT_ON_APP:"EVL_USER_NOT_ON_APP"}},Ra=9e5,Ma="moeOnsite",La="E001",ka=1500,xa=10,Ua="moe-inapp-click",Ba="moe-inapp-close",Fa='data-editor-type="MOE_EDITOR"',Ha='data-template-type="SIDE_BANNER"',Va="moe-osm-pusher",Wa={SCROLL_DOWN_THRESHOLD:50,SCROLL_UP_THRESHOLD:5,SCROLL_INTERVAL:1e3},Ga="default",Ka="allCampaigns",qa="customEvent",$a="allTags",Ya="anyTags",ja="pageLoad",za="exitIntent",Ja="a_c",Qa="c_e",Xa="all_t",Za="any_t",er="p_l",tr="e_i",nr={all_t:0,any_t:0,a_c:0,p_l:0,e_i:0,c_e:0},ir={[Ka]:"allCampaigns",[qa]:"customEvent",[$a]:"allTags",[Ya]:"anyTags",[ja]:"pageLoad",[za]:"exitIntent"},ar={impression:{[Ka]:Na.IMPRESSION.IMPRESSION_STAGE_ALL_CAMPAIGNS_FREQUENCY_CAPPING_LIMIT_REACHED,[za]:Na.IMPRESSION.IMPRESSION_STAGE_EXIT_INTENT_FREQUENCY_CAPPING_LIMIT_REACHED,[ja]:Na.IMPRESSION.IMPRESSION_STAGE_PAGE_LOAD_FREQUENCY_CAPPING_LIMIT_REACHED,[qa]:Na.IMPRESSION.IMPRESSION_STAGE_CUSTOM_EVENT_FREQUENCY_CAPPING_LIMIT_REACHED,[$a]:Na.IMPRESSION.IMPRESSION_STAGE_ALL_TAGS_FREQUENCY_CAPPING_FAILED,[Ya]:Na.IMPRESSION.IMPRESSION_STAGE_ANY_TAGS_FREQUENCY_CAPPING_FAILED},priority:{[Ka]:Na.PRIORITIZED.PRIORITY_STAGE_ALL_CAMPAIGNS_FREQUENCY_CAPPING_LIMIT_REACHED,[za]:Na.PRIORITIZED.PRIORITY_STAGE_EXIT_INTENT_FREQUENCY_CAPPING_LIMIT_REACHED,[ja]:Na.PRIORITIZED.PRIORITY_STAGE_PAGE_LOAD_FREQUENCY_CAPPING_LIMIT_REACHED,[qa]:Na.PRIORITIZED.PRIORITY_STAGE_CUSTOM_EVENT_FREQUENCY_CAPPING_LIMIT_REACHED,[$a]:Na.PRIORITIZED.PRIORITY_STAGE_ALL_TAGS_FREQUENCY_CAPPING_FAILED,[Ya]:Na.PRIORITIZED.PRIORITY_STAGE_ANY_TAGS_FREQUENCY_CAPPING_FAILED}},rr={API:Ca,STORES:Oa,DELIVERY_FUNNEL:Na,FREQUENCY_CAPPING:{STORAGE_KEYS:{FREQUENCY_CAPPING_SETTINGS:"frequencyCappingSettings",DEVICE_FREQUENCY_DATA:"deviceFrequencyData",SESSION_FREQUENCY_DATA:"sessionFrequencyData"},EVENT_SPECIFIC_TYPES:[qa,ja,za],ALL_EVENT_TYPES:[Ka,qa,$a,Ya,ja,za],MAX_DAYS_PERIOD:7},OSM_MODULE:Ma};class sr{static baseLogTag="MOE_ONSITE_STORES";static ready;static serviceMetaStore;static campaingsMetaStore;static campaingsTagsStore;static campaingsStatsStore;static exitIntentCampaignStore;static pendingSecondaryEvents;static pendingTimerCampaigns;static triggeringPrimaryEvents;static async initialize(){if(null==sr.ready){sr.serviceMetaStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.SERVICE_META.NAME}),sr.campaingsMetaStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.CAMPAIGNS_META.NAME}),sr.pendingSecondaryEvents=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.PENDING_SECONDARY_EVENTS.NAME}),sr.pendingTimerCampaigns=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.PENDING_TIMER_CAMPAIGNS.NAME}),sr.triggeringPrimaryEvents=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.TRIGGERING_PRIMARY_EVENTS.NAME}),sr.campaingsTagsStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.CAMPAIGNS_TAGS.NAME}),sr.campaingsStatsStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.CAMPAIGNS_STATS.NAME}),sr.exitIntentCampaignStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.EXIT_INTENT_CAMPAIGN_STORE.NAME});const e=[sr.serviceMetaStore.ready(),sr.campaingsMetaStore.ready(),sr.pendingSecondaryEvents.ready(),sr.pendingTimerCampaigns.ready(),sr.triggeringPrimaryEvents.ready(),sr.campaingsTagsStore.ready(),sr.campaingsStatsStore.ready(),sr.exitIntentCampaignStore.ready()];sr.ready=Promise.all(e)}return sr.ready}static async clear(e=!1){const t=sr.baseLogTag+".clear";try{await sr.initialize(),await Promise.all([sr.campaingsMetaStore.clear(),sr.campaingsTagsStore.clear(),sr.exitIntentCampaignStore.clear(),sr.triggeringPrimaryEvents.clear()]),e&&await Promise.all([sr.serviceMetaStore.clear(),sr.campaingsStatsStore.clear(),sr.pendingSecondaryEvents.clear(),sr.pendingTimerCampaigns.clear()]);const t=[sr.campaingsMetaStore.ready(),sr.campaingsTagsStore.ready(),sr.exitIntentCampaignStore.ready(),sr.triggeringPrimaryEvents.ready(),e?sr.campaingsStatsStore.ready():Promise.resolve()];e&&t.push(sr.serviceMetaStore.ready(),sr.campaingsStatsStore.ready(),sr.pendingSecondaryEvents.ready(),sr.pendingTimerCampaigns.ready()),sr.ready=Promise.all(t)}catch(e){$e.error(1,t,"Error clearing onsite stores:",e)}return sr.ready}static async sdkOptOut(){await Promise.all([sr.pendingSecondaryEvents.clear(),sr.pendingTimerCampaigns.clear(),sr.triggeringPrimaryEvents.clear()])}}class or{max;unit;period;tags;constructor(e){this.max=Ve(e,"max",0),this.unit=Ve(e,"unit","session"),this.period=Ve(e,"period",0),e?.tags&&(this.tags=Ve(e,"tags",null))}}class cr{allCampaigns;customEvent;allTags;anyTags;pageLoad;exitIntent;constructor(e){this.allCampaigns=new or(Ve(e,Ja,void 0)),this.customEvent=new or(Ve(e,Qa,void 0)),this.allTags=new or(Ve(e,Xa,void 0)),this.anyTags=new or(Ve(e,Za,void 0)),this.pageLoad=new or(Ve(e,er,void 0)),this.exitIntent=new or(Ve(e,tr,void 0))}}class lr{allTags;anyTags;allCampaigns;pageLoad;exitIntent;customEvent;constructor(e){this.allTags=Ve(e,Xa,0),this.anyTags=Ve(e,Za,0),this.allCampaigns=Ve(e,Ja,0),this.pageLoad=Ve(e,er,0),this.exitIntent=Ve(e,tr,0),this.customEvent=Ve(e,Qa,0)}}class dr{isValid;failedRules;passedRules;constructor(e){this.isValid=e.isValid,this.failedRules=e.failedRules,this.passedRules=e.passedRules}}function gr(e){return{[Xa]:e.allTags,[Za]:e.anyTags,[Ja]:e.allCampaigns,[er]:e.pageLoad,[tr]:e.exitIntent,[Qa]:e.customEvent}}class ur{static baseLogTag="FrequencyCappingHelper";static createDefaultDeviceFrequencyData(){return new lr(nr)}static getRuleByEventType(e,t){const n=ir[t];return n?e[n]:void 0}static filterOutHourLevelRules(e){const t={},n=[{settingKey:"a_c",rule:e.allCampaigns},{settingKey:"c_e",rule:e.customEvent},{settingKey:"all_t",rule:e.allTags},{settingKey:"any_t",rule:e.anyTags},{settingKey:"p_l",rule:e.pageLoad},{settingKey:"e_i",rule:e.exitIntent}];for(const{settingKey:e,rule:i}of n)"hour"!==i.unit&&(t[e]={max:i.max,unit:i.unit,period:i.period,tags:i.tags});return new cr(t)}static addDeviceFrequencyData(e,t){t&&(e.allTags+=t.allTags||0,e.anyTags+=t.anyTags||0,e.allCampaigns+=t.allCampaigns||0,e.pageLoad+=t.pageLoad||0,e.exitIntent+=t.exitIntent||0,e.customEvent+=t.customEvent||0)}static validateAndResetLHData(e){return e.LH?e.LH:this.createDefaultDeviceFrequencyData()}static async validateAndTrackSession(){const e=ur.baseLogTag+".validateAndTrackSession";try{const e=He(gn.get(v),y,null),t=await sr.serviceMetaStore.getItem(rr.STORES.SERVICE_META.KEYS.SESSION_KEY);return t?e===t||(e===t||(await sr.serviceMetaStore.setItem(rr.STORES.SERVICE_META.KEYS.SESSION_KEY,e),await this.resetSessionFrequencyData(),!1)):(e&&await sr.serviceMetaStore.setItem(rr.STORES.SERVICE_META.KEYS.SESSION_KEY,e),!0)}catch(t){return $e.error(2,e,"Session validation and tracking failed",t),!1}}static async resetSessionFrequencyData(){const e=this.createDefaultDeviceFrequencyData();await sr.serviceMetaStore.setItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.SESSION_FREQUENCY_DATA,e)}static async getSessionFrequencyData(){const e=await sr.serviceMetaStore.getItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.SESSION_FREQUENCY_DATA);return e||this.createDefaultDeviceFrequencyData()}static async saveSessionFrequencyData(e){await sr.serviceMetaStore.setItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.SESSION_FREQUENCY_DATA,e)}static getValueByEventType(e,t){switch(t){case $a:return e.allTags;case Ya:return e.anyTags;case Ka:return e.allCampaigns;case ja:return e.pageLoad;case za:return e.exitIntent;case qa:return e.customEvent;default:return 0}}static incrementValueByEventType(e,t){switch(t){case $a:e.allTags+=1;break;case Ya:e.anyTags+=1;break;case Ka:e.allCampaigns+=1;break;case ja:e.pageLoad+=1;break;case za:e.exitIntent+=1;break;case qa:e.customEvent+=1}}static incrementFrequencyCounter(e,t,n){this.incrementValueByEventType(t,e),this.incrementValueByEventType(n,e)}static getCurrentDeviceId(){return He(gn.get(be.USER_DATA),"deviceUuid",Ga)||Ga}static ensureDeviceEntry(e,t){if(!e[t]){const n=Mi(new Date);e[t]={LH:this.createDefaultDeviceFrequencyData(),[n]:this.createDefaultDeviceFrequencyData()}}}static ensureDateEntry(e,t,n){e[t][n]||(e[t][n]=this.createDefaultDeviceFrequencyData())}static async prepareFrequencyDataUpdate(e){const t=this.getCurrentDeviceId(),n=await e();this.ensureDeviceEntry(n,t);const i=Mi(new Date);return this.ensureDateEntry(n,t,i),{updatedLHData:n[t].LH,updatedDateData:n[t][i],frequencyData:n,deviceId:t,dateKey:i}}static async saveFrequencyDataUpdate(e,t,n,i,a,r){const s=ur.baseLogTag+".saveFrequencyDataUpdate";this.ensureDeviceEntry(e,t),e[t].LH=n,e[t][a]=i,await r(rr.FREQUENCY_CAPPING.STORAGE_KEYS.DEVICE_FREQUENCY_DATA,e),$e.log(2,s,`Frequency data saved for device ${t}, date: ${a}`)}static createValidationResult(e,t){return{isValid:e,shouldIncrementCounter:t??e}}static async validateRule(e,t,n,i,a){const r={[Ka]:async()=>{const e=await this.validateAllCampaignsRule(t,n);return this.createValidationResult(e)},[qa]:async()=>{const e=await this.validateCustomEventRule(t,n,a);return this.createValidationResult(e)},[ja]:async()=>{const e=await this.validatePageLoadRule(t,n,a);return this.createValidationResult(e)},[za]:async()=>{const e=await this.validateExitIntentRule(t,n,a);return this.createValidationResult(e)},[$a]:()=>this.validateAllTagsRule(t,i,n),[Ya]:()=>this.validateAnyTagsRule(t,i,n)}[e];return r?await r():this.createValidationResult(!0,!1)}static async validateAllCampaignsRule(e,t){const n=await this.getCombinedDataForRule(e,t);return this.getValueByEventType(n,Ka)<e.max}static async validateEventSpecificRule(e,t,n,i){if(n!==i)return!0;const a=await this.getCombinedDataForRule(e,t);return this.getValueByEventType(a,i)<e.max}static async validateCustomEventRule(e,t,n){return this.validateEventSpecificRule(e,t,n,qa)}static async validatePageLoadRule(e,t,n){return this.validateEventSpecificRule(e,t,n,ja)}static async validateExitIntentRule(e,t,n){return this.validateEventSpecificRule(e,t,n,za)}static async validateTagsRule(e,t,n,i,a){if(!e.tags||!t.tags||0===t.tags.length)return{isValid:!0,shouldIncrementCounter:!1};if(!a(e.tags,t.tags))return{isValid:!0,shouldIncrementCounter:!1};const r=await this.getCombinedDataForRule(e,n),s=this.getValueByEventType(r,i)<e.max;return{isValid:s,shouldIncrementCounter:s}}static async validateAllTagsRule(e,t,n){return this.validateTagsRule(e,t,n,$a,(e,t)=>e.every(e=>t.includes(e)))}static async validateAnyTagsRule(e,t,n){return this.validateTagsRule(e,t,n,Ya,(e,t)=>e.some(e=>t.includes(e)))}static getAllDevicesLHData(e){if(!e||"object"!=typeof e)return this.createDefaultDeviceFrequencyData();const t=this.createDefaultDeviceFrequencyData();return Object.values(e).forEach(e=>{if(e&&"object"==typeof e){const n=this.validateAndResetLHData(e);this.addDeviceFrequencyData(t,n)}}),t}static combineFrequencyDataForLastNDays(e,t){if(!e||"object"!=typeof e||t<=0)return this.createDefaultDeviceFrequencyData();const n=this.createDefaultDeviceFrequencyData(),i=new Date,a=Math.min(t,7);for(let t=0;t<a;t++){const a=new Date(i);a.setDate(a.getDate()-t);const r=Mi(a);Object.values(e).forEach(e=>{e&&"object"==typeof e&&e[r]&&this.addDeviceFrequencyData(n,e[r])})}return n}static async getCombinedDataForRule(e,t){switch(e.unit){case"session":return await this.getSessionFrequencyData();case"hour":return this.getAllDevicesLHData(t);case"day":const n=Math.min(e.period,7);return this.combineFrequencyDataForLastNDays(t,n);default:return this.createDefaultDeviceFrequencyData()}}static getStatName(e){if(!e||0===e.length)return null;const t=e[0];return ar.impression[t]??null}static getPriorityStatName(e){if(!e||0===e.length)return null;const t=e[0];return ar.priority[t]??null}static async validateRules(e,t,n,i){const a=[],r=[];let s=!0;const o=[...rr.FREQUENCY_CAPPING.ALL_EVENT_TYPES];for(const c of o){const o=this.getRuleByEventType(e,c);if(!o||o.max<=0)continue;const l=rr.FREQUENCY_CAPPING.EVENT_SPECIFIC_TYPES.includes(c);let d;if(d=l&&c===n||t.tags&&t.tags.length>0?await this.validateRule(c,o,i,t,n):{isValid:!0,shouldIncrementCounter:!1},!d.isValid){r.push(c),s=!1;break}l&&c!==n||d.shouldIncrementCounter&&a.push(c)}return new dr({isValid:s,failedRules:r.length>0?r:void 0,passedRules:a})}static async saveAllDeviceFrequencyData(e,t){if(!e||"object"!=typeof e)throw new Error("Invalid frequency data provided");try{await t(rr.FREQUENCY_CAPPING.STORAGE_KEYS.DEVICE_FREQUENCY_DATA,e)}catch(e){throw new Error(`Failed to save all device frequency data: ${e}`)}}static async processResponse(e,t){const n=this.baseLogTag+".processResponse";if(e&&"object"==typeof e&&e.frequency_data)try{const n={};Object.keys(e.frequency_data).forEach(t=>{const i=e.frequency_data[t];n[t]={LH:new lr(i.LH||{})},Object.keys(i).forEach(e=>{"LH"!==e&&(n[t][e]=new lr(i[e]))})}),await this.saveAllDeviceFrequencyData(n,t)}catch(e){$e.error(2,n,"Failed to save frequency data from API response",e)}}static trackFailedValidationStats(e,t,n,i){const a=ur.baseLogTag+".trackFailedValidationStats";if(!t)return;const r="priority"===i?this.getPriorityStatName(t):this.getStatName(t);r?n(e,r):$e.log(2,a,`No ${i} stat name found for failed rules: ${t?.join(", ")}`)}static async selfhandledImpressionValidation(e,t,n,i,a){const r=ur.baseLogTag+".selfhandledImpressionValidation",s=[];for(const o of e){const e=await this.validateRules(t,o,n,i);e.isValid?s.push(o):($e.log(2,r,`Campaign ${o.campaignId} blocked by frequency capping rule: ${e.failedRules?.join(", ")}`),this.trackFailedValidationStats(o,e.failedRules,a,"impression"))}return s}static async selfhandledPriorityValidation(e,t,n,i,a){const r=ur.baseLogTag+".selfhandledPriorityValidation",s=[],o=this.filterOutHourLevelRules(t);for(const t of e){const e=await this.validateRules(o,t,n,i);e.isValid?s.push(t):($e.log(2,r,`Campaign ${t.campaignId} blocked by priority frequency capping rule: ${e.failedRules?.join(", ")}`),this.trackFailedValidationStats(t,e.failedRules,a,"priority"))}return s}}class pr{static getEventTypeFromEvent(e){if(!e)return ja;switch(e.name){case q:return ja;case ae:case oe:return za;default:return qa}}static getEventTypeFromCampaign(e){if(!e||!e.triggerData)return qa;try{if(e.triggerData.primary_condition){const t=e.triggerData.primary_condition;if(this.hasEventInCondition(t,q))return ja;if(this.hasEventInCondition(t,ae)||this.hasEventInCondition(t,oe))return za}if(e.triggerData.secondary_condition){const t=e.triggerData.secondary_condition;if(this.hasEventInCondition(t,q))return ja;if(this.hasEventInCondition(t,ae)||this.hasEventInCondition(t,oe))return za}}catch(e){$e.error(2,"EventTypeHelper.getEventTypeFromCampaign","Error determining event type from campaign:",e)}return qa}static hasEventInCondition(e,t){try{return!!(e&&e.included_filters&&e.included_filters.filters&&Array.isArray(e.included_filters.filters))&&e.included_filters.filters.some(e=>e&&e.action_name===t)}catch(e){return $e.error(2,"EventTypeHelper.hasEventInCondition","Error checking event in condition:",e),!1}}}class mr{static baseLogTag="FrequencyCapping";static async saveSettings(e){if(!e||"object"!=typeof e||0===Object.keys(e).length)return;const t=e instanceof cr?e:new cr(e);await sr.serviceMetaStore.setItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.FREQUENCY_CAPPING_SETTINGS,t);await sr.serviceMetaStore.getItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.SESSION_FREQUENCY_DATA)||await ur.resetSessionFrequencyData()}static async getSettings(){const e=await sr.serviceMetaStore.getItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.FREQUENCY_CAPPING_SETTINGS);return e||null}static async getDeviceFrequencyData(){const e=await sr.serviceMetaStore.getItem(rr.FREQUENCY_CAPPING.STORAGE_KEYS.DEVICE_FREQUENCY_DATA);return e||{}}static isEventTypePresentInSettings(e,t){const n=ur.getRuleByEventType(e,t);return void 0!==n&&n.max>0}static filterEventsPresentInSettings(e,t){return t.filter(t=>this.isEventTypePresentInSettings(e,t))}static async validateAndUpdateFrequencyData(e,t,n,i=!1){const a=mr.baseLogTag+".validateAndUpdateFrequencyData";try{const r=await this.getSettings();if(!r)return{isValid:!0,passedRules:[]};const s=await this.getDeviceFrequencyData(),o=await ur.validateRules(r,e,t,s);o.isValid||$e.log(2,a,`Campaign ${e.campaignId} blocked by rule: ${o.failedRules?.join(", ")}`);const c=e.delivery?.fcMeta;if(c&&He(c,"ignoreFcCount",!1)&&n)return $e.log(2,a,`Skipping frequency data update for campaign ${e.campaignId} as ignoreFcCount flag is set`),{isValid:o.isValid,failedRules:o.failedRules,passedRules:o.passedRules};if((o.isValid||i)&&n){let e;if(i){const n=new Set([t,Ka,...o.passedRules,...o.failedRules||[]]);e=Array.from(n)}else e=o.passedRules;e=this.filterEventsPresentInSettings(r,e),e.length>0&&await this.updateFrequencyDataForPassedRules(e,n)}return{isValid:o.isValid,failedRules:o.failedRules,passedRules:o.passedRules}}catch(e){return $e.error(2,a,"Error during validation",e),{isValid:!1,passedRules:[]}}}static async updateFrequencyDataForPassedRules(e,t){const n=await this.getSettings();if(!n)return;const i=this.filterEventsPresentInSettings(n,e);if(0===i.length)return;const a=[],r=[];for(const e of i){const t=ur.getRuleByEventType(n,e);t&&"session"===t.unit?a.push(e):r.push(e)}if(a.length>0){const e=await ur.getSessionFrequencyData();for(const t of a)ur.incrementValueByEventType(e,t);await ur.saveSessionFrequencyData(e)}if(r.length>0){const{updatedLHData:e,updatedDateData:n,frequencyData:i,deviceId:a,dateKey:s}=await ur.prepareFrequencyDataUpdate(()=>this.getDeviceFrequencyData());for(const t of r)ur.incrementFrequencyCounter(t,e,n);if(await ur.saveFrequencyDataUpdate(i,a,e,n,s,(e,t)=>sr.serviceMetaStore.setItem(e,t)),t)try{const i={LH:e,[s]:n};await t.updateDeviceFrequencyData(i)}catch(e){$e.error(2,"FrequencyCapping.updateFrequencyDataForPassedRules","Failed to sync frequency data with server",e)}}}static async campaignImpressionValidation(e,t,n){const i=mr.baseLogTag+".campaignImpressionValidation";try{const a=await this.getSettings(),r=e.delivery?.fcMeta;if(!a||r&&r.ignoreFc)return $e.log(2,i,`Skipping FC validation for campaign: ${e.campaignId} as FC setting is not available or ignoreFc flag is set true`),!0;const s=await this.validateAndUpdateFrequencyData(e,t);return!s.isValid&&n&&ur.trackFailedValidationStats(e,s.failedRules,(e,t)=>n.setStats(e,t),"impression"),s.isValid}catch(e){return $e.error(2,i,"Error in frequency capping validation",e),!0}}static async processResponse(e){await ur.processResponse(e,(e,t)=>sr.serviceMetaStore.setItem(e,t))}static async handlePriorityValidation(e,t,n){const i=mr.baseLogTag+".handlePriorityValidation";try{const a=await this.getSettings();if(!a)return!0;const r=e.delivery?.fcMeta;if(r&&r.ignoreFc&&r.ignoreFcCount)return $e.log(2,i,"Skipping priority frequency capping validation due to ignoreFc and ignoreFcCount flags"),!0;const s=ur.filterOutHourLevelRules(a),o=await this.getDeviceFrequencyData(),c=await ur.validateRules(s,e,t,o);return c.isValid?($e.log(2,i,`Priority validation passed for rules: ${c.passedRules.join(", ")}`),!0):($e.log(2,i,`Priority validation failed for rule: ${c.failedRules?.join(", ")}`),ur.trackFailedValidationStats(e,c.failedRules,(e,t)=>n.setStats(e,t),"priority"),!1)}catch(e){return $e.error(2,i,"Error during priority frequency capping validation",e),!0}}static async campaignPriorityValidation(e,t,n,i){const a=mr.baseLogTag+".campaignPriorityValidation",r=await this.getSettings(),s=e.delivery.fcMeta;if(!r||s&&s.ignoreFc)return $e.log(2,a,`Skipping FC validation for campaign: ${e.campaignId} as FC setting is not available or ignoreFc flag is set true`),!0;let o;if(n)o=n;else{if(!t)return $e.log(2,a,`Unable to determine event type for campaign: ${e.campaignId}`),!1;o=pr.getEventTypeFromEvent(t)}return!!await this.handlePriorityValidation(e,o,i)||($e.log(2,mr.baseLogTag+".campaignPriorityValidation",`Priority frequency capping validation failed for campaign: ${e.campaignId}`),!1)}}const hr=(e,t,n)=>null==e.campaignId?()=>{}:()=>{sr.campaingsStatsStore.getItem(e.campaignId).then(t=>{const n=t?{...t,clicks:He(t,"clicks",0)+1}:{clicks:1};sr.campaingsStatsStore.setItem(e.campaignId,n)});const i=n||{};return vr().track_event(Pa[t].CLICK,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Pa[t].TYPE,...i,...e.campaignContext})};const fr=(e,t,n=!1,i)=>null==e.campaignId?()=>{}:(function(e){e.templateType!==as.SELF_HANDLED&&(Dr(e,ae)||Dr(e,re))&&(qs.onScrollOrExitIntentCampaigns[e.campaignId]=!0)}(e),()=>{if(Er(e.campaignId),function(e,t){const n="helpers.trackFrequencyCappingImpression";if(!mr?.getSettings)return;if(t){const t=e.delivery?.fcMeta;if(t&&He(t,"ignoreFcCount",!1))return void $e.log(2,n,`Skipping frequency capping tracking for campaign ${e.campaignId} as ignoreFcCount flag is set`)}const i=mr.getSettings();i&&"function"==typeof i.then&&i.then(i=>{if(!i)return void $e.log(2,n,"Frequency capping not enabled, skipping update for campaign impression");const a=pr.getEventTypeFromCampaign(e),r={campaignId:e.campaignId,tags:e.tags||[],delivery:e.delivery};return mr.validateAndUpdateFrequencyData(r,a,t,!0).then(t=>{$e.log(2,n,`Frequency data tracked for campaign ${e.campaignId}. Validation: ${t.isValid?"passed":`failed (${t.failedRules?.join(", ")})`}`)}).catch(t=>{$e.error(2,n,`Failed to track frequency capping data for campaign ${e.campaignId}:`,t)})}).catch(t=>{$e.error(2,n,`Failed to get frequency capping settings for campaign ${e.campaignId}:`,t)})}(e,i),!n)return vr().track_event(Pa[t].IMPRESSION,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Pa[t].TYPE,templateType:e.templateType,...e.campaignContext})}),Er=e=>{sr.initialize().then(()=>{sr.campaingsStatsStore.getItem(e).then(t=>{const n=t?{...t,impressions:He(t,"impressions",0)+1,lastImpression:new Date}:{impressions:1,lastImpression:new Date};sr.campaingsStatsStore.setItem(e,n)})})},Sr=(e,t,n)=>{const i=Pa[t],a=n&&"AUTO_DISMIS"in i?i.AUTO_DISMIS:i.DISMISS;vr().track_event(a,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:i.TYPE,...e.campaignContext})},_r=(e,t)=>{vr().track_event(Pa[t].DELIVERED,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Pa[t].TYPE,...e.campaignContext})},vr=()=>{const e=window.moengage_object||"Moengage";return window[e]};class yr{static baseLogTag="CampaignUtils";static isValid(e,t){return!yr.isCampaignExpired(e)&&yr.isCampaignActive(e)&&yr.isUserInCampaignSegment(e)&&yr.isCampaignWithinFC(e,t)}static isCampaignExpired(e){return(new Date).getTime()>new Date(e.expiryTime).getTime()}static isValidMessagingCampaign(e,t,n,i,a){return yr.canCampaignBeRenderedOverExisting(e,a.length)&&yr.hasCampaignClearedSelfDelay(e,t)&&yr.hasCampaignClearedGlobalDelay(e,n,i)}static isCampaignActive(e){const t=yr.baseLogTag+".isValid";return e.status===ns.ACTIVE||($e.warn(1,t,`Campaign ${e.campaignId} : Status is ${e.status}`),!1)}static isUserInCampaignSegment(e){const t=yr.baseLogTag+".isValid";return!!e.userInSegment||($e.warn(1,t,`Campaign ${e.campaignId} : User is not in segment`),!1)}static isCampaignWithinFC(e,t){const n=yr.baseLogTag+".isValid";if([as.SELF_HANDLED].indexOf(e.templateType)<0){const i=He(e,"delivery.fcMeta.count",0);if(i>0){const a=He(t,"impressions",0);if(null!=t)return!(a>=i)||($e.warn(1,n,`Campaign ${e.campaignId} : FC reached. ${t.impressions} times shown`),!1)}}return!0}static hasCampaignClearedGlobalDelay(e,t,n){const i=yr.baseLogTag+".isValid",a=He(e,"delivery.fcMeta.ignoreGlobalDelay",!1);try{if(!a){const a=new Date;if(n){const r=(a.getTime()-new Date(n).getTime())/1e3;if(t&&r<=t)return $e.remoteLogTracking(1,"info",i,`Can't render ${e.campaignId} as last global campaign was rendered ${r} seconds ago.`),!1}}}catch(e){return $e.error(1,i,"Error checking global delay:",e),!1}return!0}static hasCampaignClearedSelfDelay(e,t){const n=`${yr.baseLogTag}.hasCampaignClearedSelfDelay`,i=He(e,"delivery.fcMeta.delay",0);try{if(i>0&&null!=t&&t.lastImpression){const i=t.lastImpression,a=((new Date).getTime()-new Date(i).getTime())/1e3;if(a<=He(e,"delivery.fcMeta.delay",0))return $e.warn(1,n,`Can't render ${e.campaignId} as it was rendered ${a} seconds ago.`),!1}}catch(t){return $e.error(1,n,`Can't check self delay for ${e.campaignId}`,t),!1}return!0}static doCampaignPayloadHasMandatoryParams(e){const{payload:t,payloadType:n,htmlJsonPayload:i}=e;return!(!t&&!i||!n)}static canCampaignBeRenderedOverExisting(e,t){const n=`${yr.baseLogTag}.canCampaignBeRenderedOverExisting`;return!(t>0&&!e.display.config.showOverOtherCampaigns)||($e.warn(1,n,`Can not show ${e.campaignId} over other existing campaigns`),!1)}static comparator(e,t){return t.delivery.priority>e.delivery.priority?1:t.delivery.priority<e.delivery.priority?-1:t.updatedTime>e.updatedTime?1:-1}}const Tr=async e=>{const t=e.map(e=>sr.campaingsStatsStore.getItem(e.campaignId));let n=[];try{n=await Promise.all(t);return e.filter((e,t)=>yr.isValid(e,n[t])).sort(yr.comparator)}catch(e){return $e.error(1,"filterAndSortCampaigns","Error filtering and sorting campaigns: ",e),[]}};class br{static REMOVE_TRAIL_CHARS=/[^\w\s]+$/gi}const Ir=e=>{e.primaryEventsHash?.MOE_PAGE_SCROLL?.length&&window.removeEventListener("scroll",e.getScrollListenerCallback())},Ar=e=>{if(!e)return;Object.keys(e.campaignRenderMap).forEach(t=>{document.getElementById(`moe-onsite-campaign-${t}`)&&document.getElementById(`moe-onsite-campaign-${t}`).remove(),e.campaignRenderMap[t].isActive()&&e.dismissInapp(t,!1),clearTimeout(e.campaignRenderMap[t]?.delayTimer),delete e.campaignRenderMap[t],e.campaignRenderOrder=e.campaignRenderOrder.filter(e=>e!==t)})},wr=e=>{setTimeout(()=>{e&&(Fn()?e.windowEventManager.isPopStateEventBound&&(e.windowEventManager.setHistoryState(),e.windowEventManager.isExitIntentShown=!1,e.windowEventManager.scrollExitIntentInterval=null):document.removeEventListener("mouseout",e.windowEventManager.exitIntentListener))},0)},Dr=(e,t)=>{const n=He(e,"triggerData.primary_condition.included_filters",null);return n?.filter_operator===is.OR&&n?.filters.findIndex(e=>e.action_name===t)>-1},Cr=async e=>{const t=await sr.exitIntentCampaignStore.getItem(e.campaignId);if(t)return t.error?t:(e.onsitePayload=t,$e.log(1,"getPrefetchedCampaign",`Prefetched exit intent campaign found: ${e.campaignId}`),e)},Or=async e=>{try{return await sr.campaingsMetaStore.getItem(e)}catch(e){return $e.error(2,"getCampaignById","Error getting campaign from store: ",e),null}},Pr=()=>new Promise(e=>{setTimeout(async()=>{const t=[];await sr.campaingsMetaStore.iterate(e=>{t.push(e)}),e(t)},0)}),Nr=e=>He(e,"triggerData.secondary_condition.included_filters.filters")?.length,Rr=e=>`moe-onsite-campaign-${e}`;function Mr(e){if(e.detail.name===N.EVENT_NAMES.PAGE_CHANGED){window.Moengage.pageChangeHandlerCallingTime=(new Date).getTime(),window.MoeFocusHandler&&window.MoeFocusHandler(),(()=>{if(vr()?.onsite){const{onsite:e}=vr(),{triggerManager:t,displayManager:n,sendDelayCampaignStats:i,funnelManager:a}=e;n&&(i(n,a),Ar(n)),t&&(Ir(t),wr(t)),qs.onScrollOrExitIntentCampaigns={},Ti.resetListeners(),e.initializationPomise=null,e.selfHandledWebpTriggerListeners={},e.initialize&&e.initialize()}})(),window.Moengage.shouldClearPrevEvents=(new Date).getTime();const{triggerManager:e}=vr()?.onsite;if(e)try{e.clearPrevEvents&&e.clearPrevEvents()}catch(e){$e.error(2,"handlePageChange","Error clearing previous events",e)}}}class Lr{dataType;availableOperations;event;filter;regex;constructor(e,t,n,i){this.dataType=e,this.availableOperations=t,this.event=n,this.filter=i}validate(){return!(this.availableOperations.indexOf(this.filter.operator)<0)}checkEq(){let e=!1;return this.event.attributes.forEach(t=>{let n=t.value,i=this.filter.value;this.dataType===kr.STRING&&typeof n===kr.STRING&&(n=this.removeSpecialChars(n),i=this.removeSpecialChars(i)),t.key===this.filter.name&&(this.dataType!==kr.STRING||this.filter.case_sensitive?n===i&&(e=!0):n.toLowerCase()===i.toLowerCase()&&(e=!0))}),e}checkExists(){let e=!1;return this.event.attributes.forEach(t=>{t.key===this.filter.name&&(e=!0)}),e}removeSpecialChars(e){return e.replace(br.REMOVE_TRAIL_CHARS,"")}}var kr,xr;!function(e){e.BOOL="bool",e.STRING="string",e.DATE="datetime",e.NUMBER="double",e.LONG="long",e.ARRAY_BOOL="array_bool",e.ARRAY_NUMBER="array_double",e.ARRAY_STRING="array_string",e.ARRAY_DATETIME="array_datetime",e.OBJECT="object"}(kr||(kr={})),function(e){e.ALLOF="all_of",e.ANYOFF="any_of"}(xr||(xr={}));const Ur=["is","exists","contains","startsWith","endsWith","in","containsInTheFollowing","startsWithInTheFollowing","endsWithInTheFollowing"];class Br extends Lr{static baseLogTag="StringDataType";constructor(e,t){super(kr.STRING,Ur,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n&&Di(n.value))switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"contains":case"containsInTheFollowing":e=this.checkContains(n);break;case"startsWith":case"startsWithInTheFollowing":e=this.checkStartsWith(n);break;case"endsWith":case"endsWithInTheFollowing":e=this.checkEndsWith(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkContains(e){const t=t=>this.filter.case_sensitive?e.value.indexOf(t)>=0:e.value.toLowerCase().indexOf(t.toLowerCase())>=0;return Array.isArray(this.filter.value)?this.filter.array_filter_type===xr.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkStartsWith(e){const t=t=>{const n=(e,t)=>e.substr(0,t.length)===t;return this.filter.case_sensitive?n(e.value,t):n(e.value.toLowerCase(),t.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===xr.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkEndsWith(e){const t=t=>{const n=(e,t,n)=>((void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t);if(this.filter.case_sensitive)return n(e.value,t);const i=this.removeSpecialChars(e.value),a=this.removeSpecialChars(t);return n(i.toLowerCase(),a.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===xr.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkIn(e){let t=!1;if(Array.isArray(this.filter.value))for(let n=this.filter.value.length-1;n>=0;n--)if(this.filter.case_sensitive){if(this.filter.value[n]===e.value){t=!0;break}}else if(this.filter.value[n].toLowerCase()===e.value.toLowerCase()){t=!0;break}return t}checkInTheFollowing(e){return this.filter.value.map(t=>e(t))}}const Fr=["is","exists"];class Hr extends Lr{static baseLogTag="BooleanDataType";constructor(e,t){super(kr.BOOL,Fr,e,t)}evaluate(){let e=!1;switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists()}return this.filter.negate?!e:e}}const Vr=["is","exists","greaterThan","lessThan","between","in"];class Wr extends Lr{static baseLogTag="NumberDataType";constructor(e,t){super(kr.NUMBER,Vr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n&&"number"==typeof n.value)switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"greaterThan":e=this.checkGreaterThan(n);break;case"lessThan":e=this.checkLessThan(n);break;case"between":e=this.checkBetween(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkGreaterThan(e){return e.value>this.filter.value}checkLessThan(e){return e.value<this.filter.value}checkBetween(e){return this.filter.value2?this.filter.value&&this.filter.value2&&this.filter.value<=e.value&&e.value<this.filter.value2:this.filter.value&&this.filter.value1&&this.filter.value<=e.value&&e.value<this.filter.value1}checkIn(e){return Array.isArray(this.filter.value)&&this.filter.value.indexOf(e.value)>=0}}const Gr=["exists","on","between","before","after","inTheLast","inTheNext","today"];class Kr extends Lr{static baseLogTag="DateTimeDataType";constructor(e,t){!Ci(t.value)&&Di(t.value)&&(t.value=new Date(t.value.split("Z").join(""))),!Ci(t.value2)&&Di(t.value2)&&null!=t.value2&&(t.value2=new Date(t.value2.split("Z").join(""))),!Ci(t.value1)&&Di(t.value1)&&null!=t.value1&&(t.value1=new Date(t.value1.split("Z").join(""))),super(kr.DATE,Gr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n)switch(n.value.setHours(0,0,0,0),this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"on":e=this.checkOn(n);break;case"between":e=this.checkBetween(n);break;case"before":e=this.checkBefore(n);break;case"after":e=this.checkAfter(n);break;case"inTheLast":e=this.checkLastX(n);break;case"inTheNext":e=this.checkNextX(n);break;case"today":e=this.checkToday(n)}return this.filter.negate?!e:e}checkOn(e){return e.value.setHours(0,0,0,0)===this.filter.value.setHours(0,0,0,0)}checkBetween(e){return this.filter.value2?this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value2.getTime():this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value1.getTime()}checkBefore(e){const{filter:{value:t}}=this;return typeof t===V?((new Date).setHours(0,0,0,0)-e.value.setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)<t.setHours(0,0,0,0)}checkAfter(e){const{filter:{value:t}}=this;return typeof t===V?(e.value.setHours(0,0,0,0)-(new Date).setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)>t.setHours(0,0,0,0)}checkLastX(e){const t=(new Date).setHours(0,0,0,0),n=e.value.setHours(0,0,0,0);return t-n>0&&(t-n)/864e5<=this.filter.value}checkNextX(e){const t=(new Date).setHours(0,0,0,0),n=e.value.setHours(0,0,0,0);return n-t>0&&(n-t)/864e5<=this.filter.value}checkToday(e){return e.value.setHours(0,0,0,0)===(new Date).setHours(0,0,0,0)}}const qr=["is","exists","contains","startsWith","endsWith","in","lessThan","greaterThan","between","inTheLast","inTheNext","after","before","on","today"];class $r extends Lr{constructor(e,t){super(t.data_type,qr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;return null!=n&&Oi(n.value)&&(e=this.filter.array_filter_type&&this.filter.array_filter_type===xr.ANYOFF?this.checkAnyOf(n):this.checkAllOf(n)),e}checkAllOf(e){return e.value.every(t=>this.getFilterResult(t,e))}checkAnyOf(e){return e.value.some(t=>this.getFilterResult(t,e))}getFilterResult(e,t){let n=!1;const i=this.createCustomEvent(t.key,e),a=this.getDataType(i);return a.validate()&&(n=a.evaluate()),n}createCustomEvent(e,t){const n=new ti(e,t);return new qi(this.event.name,[n])}getDataType(e){let t;switch(this.filter.data_type){case kr.ARRAY_BOOL:t=new Hr(e,this.filter);break;case kr.ARRAY_DATETIME:t=new Kr(e,this.filter);break;case kr.ARRAY_NUMBER:t=new Wr(e,this.filter);break;case kr.ARRAY_STRING:t=new Br(e,this.filter)}return t}}class Yr{event;filter;constructor(e,t){this.event=e,this.filter=t}evaluate(){let e;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(!n)return!1;const i=this.filter.filters.map(e=>{if("exists"===e.operator){const t=e?.name in n?.value;return e.negate?!t:t}if(!(e?.name in n?.value))return!1;const t=new ti(e.name,n.value[e.name]),i=new qi(e.name,[t]);return jr.doesEventMatchFilters(i,e)}),a=this.filter.filter_operator;e=i?.[0]||!1;for(let t=1;t<i.length;t++)if(a===is.AND){if(e=e&&i[t],!1===e)break}else if(a===is.OR&&(e=e||i[t],!0===e))break;return e}}class jr{static baseLogTag="TriggerEvaluator";static doesEventMatchFilters(e,t){jr.baseLogTag;let n=!1,i=null;switch(t.data_type){case kr.BOOL:i=new Hr(e,t),i.validate()&&(n=i.evaluate());break;case kr.STRING:i=new Br(e,t),i.validate()&&(n=i.evaluate());break;case kr.NUMBER:case kr.LONG:i=new Wr(e,t),i.validate()&&(n=i.evaluate());break;case kr.DATE:i=new Kr(e,t),i.validate()&&(n=i.evaluate());break;case kr.OBJECT:i=new Yr(e,t),n=i.evaluate();break;case kr.ARRAY_STRING:case kr.ARRAY_DATETIME:case kr.ARRAY_BOOL:case kr.ARRAY_NUMBER:i=new $r(e,t),i.validate()&&(n=i.evaluate())}return n}static doesValueMatchFilter(e,t){const n=new ti(t.name,e),i=new qi("Sample event",[n]);return jr.doesEventMatchFilters(i,t)}}class zr{static baseLogTag="OnsiteCampaignMeta";campaignId;campaignName;templateType;status;tag;tags;delivery;expiryTime;updatedTime;userInSegment;triggerData;display;onsitePayload;stats;campaignContext;editorVersion;constructor(e){const t=zr.baseLogTag+".constructor";this.campaignId=He(e,"campaign_id",null),this.campaignName=He(e,"campaign_name",null),this.templateType=He(e,"template_type",null),this.campaignContext=He(e,"campaign_context",null);const n=He(e,"status",null),i=[ns.ACTIVE,ns.EXPIRED,ns.PAUSED];i.indexOf(n)<0?this.status=ns.ACTIVE:this.status=i[i.indexOf(n)],this.tag=He(e,"tag",null),this.tags=He(e,"tags",[]),this.triggerData=null,Jr.validate(He(e,"trigger"))?this.triggerData=new Jr(He(e,"trigger")):$e.log(2,t,"Rejecting trigger data for :",e),this.expiryTime=pi(He(e,"expiry_time")+"Z"),this.updatedTime=pi(He(e,"updated_time")+"Z"),this.delivery=new rs(He(e,"delivery")),this.userInSegment=He(e,"user_in_segment",!0),this.display=null;const a=He(e,"display",null),r=He(e,"display_filter",null);this.templateType!==as.SELF_HANDLED&&(null!=r?this.display=new cs({rules:{uri_filters:r}},this.templateType):null!=a&&(this.display=new cs(a,this.templateType))),this.stats={},this.onsitePayload=null,this.editorVersion=He(e,"editor_version",null)}static isValidMetaJSON(e){zr.baseLogTag;let t=!0;const n=["campaign_id","campaign_name","template_type","status","expiry_time","updated_time","delivery","user_in_segment"];for(let i=0;i<n.length;i++)if(null==e[n[i]]){t=!1;break}return t}static getTriggerEvent(e,t,n){const i=He(t,`triggerData.${n}_condition.included_filters`,null);return i?.filters.filter(t=>t.action_name===e||t.action_name===ae&&"MOE_EXIT"===e)}static areFiltersAbsent(e){return!(!e?.action_name||e?.attributes?.filters)}static getFilters(e){return e?.action_name&&e?.attributes?.filters||null}static getFilterOperator(e){return e?.action_name&&e?.attributes?.filterOperator||is.AND}static isTriggered(e,t,n,i){let a=!0;if(t?.length>0){let r;r=i||zr.getFilterOperator(n);const s=t.map(t=>jr.doesEventMatchFilters(e,t));a=s[0]||!1;for(let e=1;e<s.length;e++)if(r===is.AND){if(a=a&&s[e],!1===a)break}else if(r===is.OR&&(a=a||s[e],!0===a))break}return a}static getFilterResult(e,t){return this.didPrimaryEventFilterTrigger(e,t)&&this.getURLFilterResult(t)}static didPrimaryEventFilterTrigger(e,t){const n=this.getTriggerEvent(e.name,t,"primary")||[];for(let t=0;t<n.length;t++){const i=n[t],a=zr.getFilters(i);if(zr.areFiltersAbsent(i)||zr.isTriggered(e,a,i))return!0}return!1}static getURLFilterResult(e){const t=new qi(se,[]),n=zr.getTriggerEvent(t.name,e,"url");if(n){const e=n.find(e=>e.action_name===se),i=zr.getFilters(e);return zr.isTriggered(t,i,e)}return!0}}class Jr{cs_id;_id;references;trigger_delay;trigger_wait_time;primary_condition;secondary_condition;url_condition;description;constructor(e){this.cs_id=e.cs_id,this._id=e._id,this.references=e.references,this.trigger_wait_time=e.trigger_wait_time||null,Xr.validate(e.primary_condition)?this.primary_condition=new Xr(e.primary_condition):this.primary_condition=null,Xr.validate(e.secondary_condition)?this.secondary_condition=new Xr(e.secondary_condition):this.secondary_condition=null,Xr.validate(e.url_condition)?this.url_condition=new Xr(e.url_condition):this.url_condition=null,this.description=e.description,null!=e.trigger_delay?this.trigger_delay=new Qr(e.trigger_delay):this.trigger_delay=null}static validate(e){let t=!1;return["primary_condition"].forEach(n=>{null!=He(e,n,null)&&(t=!0)}),t}}class Qr{delay;unit;delay_type;attribute;delayInSeconds;constructor(e){if(this.delay=He(e,"delay",0),this.unit=He(e,"unit","seconds"),this.delay_type=He(e,"delay_type",""),this.attribute=He(e,"attribute",""),He(e,"delay",null)&&He(e,"unit",null)){let e=this.delay;"minutes"!==this.unit&&"hours"!==this.unit&&"days"!==this.unit||(e*=60),"hours"!==this.unit&&"days"!==this.unit||(e*=60),"days"===this.unit&&(e*=24),this.delayInSeconds=e}else this.delayInSeconds=0}}class Xr{included_filters;excluded_filters;constructor(e){this.included_filters=new Zr(He(e,"included_filters",null)),this.excluded_filters=new Zr(He(e,"excluded_filters",null))}static validate(e){if(e){const t=e.included_filters;if(t&&Array.isArray(t.filters)&&t.filters.length&&null!=t.filter_operator)return!0}return!1}}class Zr{filter_operator;filters;constructor(e){this.filter_operator=He(e,"filter_operator",is.AND),this.filters=He(e,"filters",[])?.map(e=>new es(e))}}class es{action_name;executed;attributes;filter_type;filters;constructor(e){const t=He(e,"action_name",null);"string"==typeof t&&(t.includes("")?this.action_name=ui(t):this.action_name=t);const n=He(e,"executed",null);"boolean"==typeof n&&(this.executed=n),this.filter_type=He(e,"filter_type",null);const i=He(e,"attributes",null);ts.validateJson(i)&&(this.attributes=new ts(i)),"nested_filters"===this.filter_type&&(this.filters=new Zr(e))}}class ts{filterOperator;filters=[];constructor(e){this.filterOperator=He(e,"filter_operator",is.AND),this.filters=He(e,"filters",[]),this.filters.length&&this.filters.forEach(e=>{e?.name?.includes("")&&(e.name=ui(e.name))})}static validateJson(e){if(null==e)return!1;const t=["filters"];for(let n=0;n<t.length;n++)if(null==e[t[n]])return!1;return!0}}var ns,is,as;!function(e){e.ACTIVE="ACTIVE",e.PAUSED="PAUSED",e.EXPIRED="EXPIRED"}(ns||(ns={})),function(e){e.AND="and",e.OR="or"}(is||(is={}));class rs{priority;dismissInterval;fcMeta;constructor(e){this.priority=He(e,"priority",0),this.dismissInterval=He(e,"dismiss_interval",0),this.fcMeta=new ss(He(e,"fc_meta",null))}}class ss{count=0;delay=0;ignoreGlobalDelay;ignoreFc;ignoreFcCount;constructor(e){null!=e&&(this.count=He(e,"count",0),this.delay=He(e,"delay",0),this.ignoreGlobalDelay=He(e,"ignore_global_delay",!1),this.ignoreFc=He(e,"ignore_fc",!1),this.ignoreFc?this.ignoreFcCount=He(e,"ignore_fc_count",!1):this.ignoreFcCount=!1)}}class os{aggregations=[];filter_operator;filters=[];constructor(e){this.aggregations=He(e,"aggregations",[]),this.filter_operator=He(e,"filter_operator",is.AND),this.filters=He(e,"filters",[])}}class cs{config;rules;constructor(e,t){this.config={blocking:He(e,"config.blocking",cs.getDefaultValue("blocking",t)),pushPage:He(e,"config.push_page",cs.getDefaultValue("push_page",t)),sticky:He(e,"config.sticky",cs.getDefaultValue("sticky",t)),scrollable:He(e,"config.scrollable",cs.getDefaultValue("scrollable",t)),showOverOtherCampaigns:He(e,"config.show_over_campaigns",cs.getDefaultValue("show_over_campaigns",t))},this.rules={uriFilters:new os(He(e,"rules.uri_filters",{}))}}static getDefaultValue(e,t){return{blocking:{POP_UP:!0,BANNER:!1},push_page:{POP_UP:!1,BANNER:!0},sticky:{POP_UP:!1,BANNER:!0},scrollable:{POP_UP:!1,BANNER:!0},show_over_campaigns:{POP_UP:!1,BANNER:!1}}[e][t]}}!function(e){e.SELF_HANDLED="SELF_HANDLED",e.SELF_HANDLED_OSM="SELF_HANDLED_OSM",e.POP_UP="POP_UP",e.BANNER="BANNER"}(as||(as={}));class ls{templateType;payloadType;payload;position;updatedTime;editorVersion;campaignContext;htmlJsonPayload;frequency_data;constructor(e){this.templateType=He(e,"template_type",null),this.payloadType=He(e,"payload_type",null),this.payload=He(e,"payload",null),this.position=He(e,"position",null),this.campaignContext=He(e,"campaign_context",null),this.editorVersion=He(e,"editor_version",null),this.htmlJsonPayload=JSON.parse(hi(He(e,"html_json_payload",null))),this.updatedTime=pi(He(e,"updated_time")+"Z"),this.frequency_data=He(e,"frequency_data",null)}}class ds{static baseLogTag="OnsiteApi";appId;store;host;constructor(e){this.appId=e.appId,this.store=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Oa.DATABASE_NAME,storeName:Oa.SERVICE_META.NAME}),this.host=e.baseDomainName}getUserSessionAttributes(){const e=function(){const e=new Date;return{day:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()],hours:String(e.getHours()).padStart(2,"0")}}(),t=new Pi;return{...kn(window.location.href),USER_TYPE:t.getNumberOfSessions()>1?"Returning":"New",DAY_OF_THE_WEEK:e.day,TIME_OF_THE_DAY:e.hours}}async getCampaignsMeta(){const e=ds.baseLogTag+".getCampaignsMeta";try{const t=await this.getRequestOptions(),n=await this.store.getItem(Oa.SERVICE_META.KEYS.LAST_META_CALL_TIME),i=await Un.post(this.host+Ca.META,{...t,postData:{...t.postData,campaign_ids:[],user_session_attributes:this.getUserSessionAttributes()},last_fetch_time:n&&"object"==typeof n?n.toISOString():n});this.store.setItem(Oa.SERVICE_META.KEYS.LAST_META_CALL_TIME,new Date),this.store.setItem(Oa.SERVICE_META.KEYS.UNIQUE_ID,t.queryParams.unique_id);const a=JSON.parse(i.responseText),r=[];if(a.campaigns.forEach(e=>{zr.isValidMetaJSON(e)&&r.push(new zr(e))}),a.fc_settings)try{await mr.saveSettings(a.fc_settings)}catch(t){$e.error(2,e,"Failed to save frequency capping settings",t)}return{campaignsMeta:r,globalDelayBetweenInapps:He(a,"min_delay_btw_inapps",0),fcSettings:a.fc_settings}}catch(t){throw $e.error(1,e,"Error getting meta for inapp: ",t),new Error("Could not get meta payload")}}async getCampaignPayload(e,t){const n=ds.baseLogTag+".getCampaignPayload";let i;try{const n={contexts:["string"],campaign_context:e.campaignContext,user_session_attributes:this.getUserSessionAttributes()};if(t){const a={};for(let e=0;e<t.attributes.length;e++)a[t.attributes[e].key]=t.attributes[e].value;n.event={name:t.name,attributes:a,time:(new Date).toISOString()},i=await Un.post(this.host+Ca.CAMPAIGN_PAYLOAD+e.campaignId,await this.getRequestOptions(n))}else i=await Un.post(this.host+Ca.CAMPAIGN_PAYLOAD+e.campaignId,await this.getRequestOptions(n));return i=JSON.parse(i.responseText),i.code===La&&(i={payload:i}),new ls(i)}catch(t){if($e.error(1,n,"Error geting payload",t),t.code&&(409===t.code||400===t.code)&&t.reason)return{error:!0,reason:JSON.parse(t.reason).description||""};throw new Error("Could not get payload for "+e.campaignId)}}async getCampaignsPayload(e,t){const n=ds.baseLogTag+".getCampaignsPayload";let i;try{if(t){const n={};for(let e=0;e<t.attributes.length;e++)n[t.attributes[e].key]=t.attributes[e].value;const a={event:{name:t.name,attributes:n,time:(new Date).toISOString()},contexts:["string"],campaign_ids:e};i=await Un.post(this.host+Ca.CAMPAIGNS_PAYLOAD,this.getRequestOptions(a))}else i=await Un.post(this.host+Ca.CAMPAIGNS_PAYLOAD,this.getRequestOptions());const n=[];return JSON.parse(i.responseText).forEach(e=>{n.push(new ls(e))}),n}catch(t){throw $e.error(1,n,"Error geting payload",t),new Error("Could not get payload for "+e)}}async getDraftCampaign(e){const t=ds.baseLogTag+".getDraftCampaign";try{const t=await this.getRequestOptions();t.queryParams=Object.assign({},t.queryParams,{locale:e.locale,variation:e.variation});const n=await Un.post(this.host+Ca.DRAFT_CAMPAIGN_PAYLOAD+e.draftId,t),i=JSON.parse(n.responseText);return"JSON"===i.payload_type&&(i.payload=JSON.parse(i.payload)),new ls(i)}catch(e){return $e.error(1,t,"Error geting test campaign payload",e),null}}getRequestOptions(e={}){const t=Ge();return Xn().then(async()=>{const n=await mi();if(!n.uniqueId)throw new Error("uniqueId not found in localStorage.");const i=Fn()?"mweb":"web",a=Vn();return{headers:{"Content-Type":"application/json","MOE-APPKEY":this.appId},queryParams:{sdk_ver:t.getSdkVersion(),unique_id:n?.uniqueId,os:i,...a},postData:{...e,identifiers:n.identifiers}}}).catch(e=>{throw new Error("Error in getting Web SDK Settings. This might indicate that the App is blocked.")})}async updateDeviceFrequencyData(e){const t=ds.baseLogTag+".updateDeviceFrequencyData";try{const n=await mr.getDeviceFrequencyData(),i=ur.getCurrentDeviceId();if(!i)return void $e.error(2,t,"Device ID not found");const a=e||n[i];if(!a)return void $e.error(2,t,`Device frequency data not found for device: ${i}`);const r={LH:gr(a.LH)};Object.keys(a).forEach(e=>{"LH"!==e&&(r[e]=gr(a[e]))});const s=await this.getRequestOptions(),o=await Un.post(this.host+Ca.FC_USER_ACTIVITY,{...s,postData:{...s.postData,frequency_data:{[i]:r}}});if(!o||!o.responseText)return void $e.error(2,t,"Invalid API response");const c=JSON.parse(o.responseText);c.frequency_data&&await mr.processResponse(c)}catch(e){throw $e.error(2,t,"Failed to update device frequency data",e),new Error("Could not update device frequency data")}}callStatsAPI(e,t){const n=ds.baseLogTag+".callStatsAPI";this.getRequestOptions().then(t=>{let i=this.host+Ca.STATS;t.queryParams.app_id=t.headers["MOE-APPKEY"],delete t.queryParams.uid,i=xn(i,t.queryParams),$e.log(1,n,"[sendBeacon] payload: "+JSON.stringify(e));const a=new Blob([JSON.stringify(e)],{type:"text/plain;charset=UTF-8"});navigator.sendBeacon(i,a)})}}class gs{static baseLogTag="WindowEventManager";isExitIntentShown=!1;isPopStateEventBound=!1;scrollExitIntentInterval;exitIntentListener;onScroll(e){const t=gs.baseLogTag+".onScroll";null==e&&(e=()=>{});const n=gs.throttle(()=>{$e.remoteLogTracking(1,"info",t,"Scrolled percent:",gs.getScrollPercent()),e(gs.getScrollPercent())},ka);return e(gs.getScrollPercent()),window.addEventListener("scroll",n),n}onMobileTabChange(e){const t=gs.baseLogTag+".onMobileTabChange";document.addEventListener("visibilitychange",()=>{this.isExitIntentShown||"hidden"!==document.visibilityState||($e.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0)})}onMobileBackHit(e){const t=gs.baseLogTag+".onMobileBackHit";setTimeout(()=>{this.isPopStateEventBound=!0,window.addEventListener("popstate",n=>{!this.isExitIntentShown&&n.state&&"exit_intent"===n.state.moeIntent&&($e.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e("onBackClick"),this.isExitIntentShown=!0)})},1e3),this.setHistoryState()}setHistoryState(){window.history.state&&"no_intent"===window.history.state.moeIntent||(window.history.replaceState({...window.history.state,moeIntent:"exit_intent"},""),window.history.pushState({...window.history.state,moeIntent:"no_intent"},""))}onMobileScrollAndExit(e){const t=gs.baseLogTag+".onMobileScrollAndExit",n=document.documentElement.offsetHeight;let i=gs.getScrollY(),a=!1;n>0&&(this.scrollExitIntentInterval=window.setInterval(()=>{let r=i-gs.getScrollY();r<0&&(r=0,i=gs.getScrollY()),a=gs.getScrollPercent()>Wa.SCROLL_DOWN_THRESHOLD;a&&r/n>Wa.SCROLL_UP_THRESHOLD/100&&(clearInterval(this.scrollExitIntentInterval),this.scrollExitIntentInterval=null,this.isExitIntentShown||($e.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0))},Wa.SCROLL_INTERVAL))}mobileExitIntent(e){this.onMobileScrollAndExit(e),this.onMobileBackHit(e),this.onMobileTabChange(e)}onExit(e){const t=gs.baseLogTag+".onExit";Fn()?this.mobileExitIntent(e):(this.exitIntentListener=async n=>{const i=window.innerWidth,a=window.innerHeight;(n.clientY<0||n.clientX<0||n.clientY>=a||n.clientX>=i)&&($e.log(1,t,"TRIGGERED: EXIT INTENT"),e())},document.addEventListener("mouseout",this.exitIntentListener,!1))}static getScrollPercent(){const e=window,t=document,n=t.documentElement,i=t.getElementsByTagName("body")[0],a=e.innerHeight||n.clientHeight||i.clientHeight,r=document.body,s=document.documentElement,o=Math.max(r.scrollHeight,r.offsetHeight,s.clientHeight,s.scrollHeight,s.offsetHeight);return o>a?100*gs.getScrollY()/(o-a):100}static getScrollY(){let e=0;return"number"==typeof window.pageYOffset?e=window.pageYOffset:document.body&&document.body.scrollTop&&(e=document.body.scrollTop),e}static throttle(e,t){let n;return(...i)=>{n||(n=window.setTimeout(()=>{n=null,e.apply(null,i)},t))}}static setOnlineEventListner(e){window.addEventListener("online",e,{once:!0})}}class us{static async getPendingSecondaryEventCampaign(e){return await sr.pendingSecondaryEvents.getItem(e)}static async setPendingSecondaryEventCampaign(e,t){await sr.pendingSecondaryEvents.setItem(e,t)}static async removePendingSecondaryEventCampaign(e){await sr.pendingSecondaryEvents.removeItem(e)}static async getPendingSecondaryEventKeys(){return await sr.pendingSecondaryEvents.keys()}static async getPendingTimerCampaign(e){return await sr.pendingTimerCampaigns.getItem(e)}static async setPendingTimerCampaign(e,t){await sr.pendingTimerCampaigns.setItem(e,t)}static async removePendingTimerCampaign(e){await sr.pendingTimerCampaigns.removeItem(e)}static async getPendingTimerKeys(){return await sr.pendingTimerCampaigns.keys()}static async getTriggeringPrimaryEvent(e){return await sr.triggeringPrimaryEvents.getItem(e)}static async setTriggeringPrimaryEvent(e,t){await sr.triggeringPrimaryEvents.setItem(e,t)}static async removeTriggeringPrimaryEvent(e){await sr.triggeringPrimaryEvents.removeItem(e)}static async getTriggeringPrimaryEventKeys(){return await sr.triggeringPrimaryEvents.keys()}static async removeCampaignFromStores(e){await us.removePendingSecondaryEventCampaign(e),await us.removePendingTimerCampaign(e)}}class ps{static baseLogTag="CampaignTimerManager";static listener=null;static deliveryStats=null;static closeProximityTimerCampaigns=[];static closeProximityCampaignsTimeout=null;static setListener(e){this.listener=e}static destroy(){this.listener=null,this.deliveryStats=null}static setDeliveryStats(e){this.deliveryStats=e}static async createNewTimers(){const e=`${this.baseLogTag}.createNewTimers`,t=await us.getPendingTimerKeys();for(let n=0;n<t.length;n++){const i=t[n],a=await us.getPendingTimerCampaign(i),r=a.timer-(Date.now()-a.startTime);$e.log(1,e,`Creating new setTimeout with time: ${r} ms for the campaign: ${i}`),await this.createPendingTimerCampaign(i,r)}}static async deletePendingTimer(e){const t=`${this.baseLogTag}.deletePendingTimer`,n=await us.getPendingTimerCampaign(e);n?.timerId&&($e.log(1,t,`There was an existing setTimeout associated to the campaign: ${e}. Clearing it`),clearTimeout(n.timerId))}static async deleteAllPendingTimers(){const e=`${this.baseLogTag}.deleteAllPendingTimers`;$e.log(1,e,"Clearing all setTimeout's associated to different campaign(s)");const t=await us.getPendingTimerKeys();for(let e=0;e<t.length;e++){const n=t[e],i=await us.getPendingTimerCampaign(n);clearTimeout(i.timerId)}}static async createPendingTimerCampaign(e,t){await this.deletePendingTimer(e);const n=setTimeout(async()=>{await this.checkAndInvokeListener(e),await us.removeCampaignFromStores(e)},t),i={startTime:Date.now(),timerId:n,timer:t};await us.setPendingTimerCampaign(e,i)}static async checkAndInvokeListener(e){const t=`${this.baseLogTag}.checkAndInvokeListener`,n=await Or(e);n?.campaignId&&(await this.isSatisfyingEventsArray(e)?zr.getURLFilterResult(n)&&($e.log(1,t,`Campaign ${e} satisfies the secondary_condition and the url_condition after timer has elapsed`),this.closeProximityTimerCampaigns.push(n),this.closeProximityCampaignsTimeout||(this.closeProximityCampaignsTimeout=setTimeout(()=>{this.listener(this.closeProximityTimerCampaigns),this.closeProximityTimerCampaigns=[],this.closeProximityCampaignsTimeout=null},500))):($e.warn(1,t,`Campaign: ${e} does not satisfy secondary_condition after its timer has elapsed. Removing its entry from secondary stores`),this.deliveryStats.setStats(n,Na.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Na.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED),this.deliveryStats.sendDeliveryStats([n])))}static checkIfPendingAction(e,t){return t===is.AND&&!e.events.some(e=>1===e.filters.length&&!e.filters[0].executed)}static async isSatisfyingEventsArray(e){const t=await us.getPendingSecondaryEventCampaign(e);if(t?.events){if(!t.events.length)return!0;const e=t.operator;for(let n=0;n<t.events.length;n++){const i=t.events[n],a=i.operator;let r=!1,s=!1;for(let e=0;e<i.filters.length;e++){if(i.filters[e].executed){if(this.checkIfPendingAction(t,a))return!1;r=!0}else s=!0}if(e===is.AND&&a===is.OR&&r&&!s)return!1}return!0}return!1}static async logDeliveryFunnelForExpiredTimerCampaigns(){const e=`${this.baseLogTag}.logDeliveryFunnelForExpiredTimerCampaigns`,t=await us.getPendingTimerKeys(),n=Date.now(),i=[];for(let a=0;a<t.length;a++){const r=t[a],s=await us.getPendingTimerCampaign(r);if(n-s.startTime>=s.timer&&await this.isSatisfyingEventsArray(r)){const t=await Or(r);t?.campaignId&&($e.warn(1,e,`Campaign: ${r} contained 'has not executed' event(s) and had satisfied secondary_condition, but the website was closed when the timer elapsed`),i.push(t),await this.deleteTimerAndRemoveFromStores(r))}}this.sendUserNotOnAppStat(i)}static sendUserNotOnAppStat(e){for(let t=0;t<e.length;t++){const n=e[t];this.deliveryStats.setStats(n,Na.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Na.EVALUATION.CAMPAIGN_EVALUATION_USER_NOT_ON_APP)}this.deliveryStats?.sendDeliveryStats(e)}static async deleteTimerAndRemoveFromStores(e){await this.deletePendingTimer(e),await us.removeCampaignFromStores(e)}}class ms{static baseLogTag="SecondaryEventsManager";static deliveryStats=null;static setDeliveryStats(e){this.deliveryStats=e}static destroy(){this.deliveryStats=null}static async createPendingSecondaryEvents(e,t){const n=`${this.baseLogTag}.createPendingSecondaryEvents`;for(let i=0;i<e.length;i++){const a=e[i];if(Nr(a)){const{campaignEntry:e,isCampaignTimerSet:i}=this.constructCampaignEntry(a);await us.setTriggeringPrimaryEvent(a.campaignId,t),await us.setPendingSecondaryEventCampaign(a.campaignId,e),i&&($e.log(1,n,`The campaign: ${a.campaignId} has at least one 'has not executed' secondary event. Starting timer for this campaign. Time remaining: ${e.time_left} ms`),await ps.createPendingTimerCampaign(a.campaignId,e.time_left))}}}static constructCampaignEntry(e){const t=e.triggerData.secondary_condition.included_filters,n={operator:t.filter_operator,events:[]};let i=!1;return t.filters.forEach(e=>{if("nested_filters"===e.filter_type){const t={operator:e.filters.filter_operator,filters:[]};e.filters.filters.forEach(e=>{t.filters.push(e),!1===e.executed&&(i=!0)}),n.events.push(t)}else{const t={operator:n.operator===is.AND?is.OR:is.AND,filters:[e]};n.events.push(t),!1===e.executed&&(i=!0)}}),n.updated_time=Date.now(),n.time_left=1e3*e.triggerData.trigger_wait_time.wait_period,{campaignEntry:n,isCampaignTimerSet:i}}static async pruneRemovedCampaigns(){const e=`${this.baseLogTag}.pruneRemovedCampaigns`,t=(await Pr()).map(e=>e.campaignId),n=await us.getPendingSecondaryEventKeys();for(let i=0;i<n.length;i++){const a=n[i];t.includes(a)||($e.warn(1,e,`The campaign: $${a} is not present in the latest meta call. Removing its entry from secondary stores and removing any pending timer`),await ps.deleteTimerAndRemoveFromStores(a))}}static async updateCampaignTimeInSecondaryEventsStore(){const e=`${this.baseLogTag}.updateCampaignTimeInSecondaryEventsStore`,t=await us.getPendingSecondaryEventKeys(),n=[];for(let i=0;i<t.length;i++){const a=t[i],r=await us.getPendingSecondaryEventCampaign(a),s=Date.now();if(r.time_left-=s-r.updated_time,r.updated_time=s,r.time_left<=0){const t=await Or(a);t?.campaignId&&($e.warn(1,e,`Campaign: ${a} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),n.push(t)),await ps.deleteTimerAndRemoveFromStores(a)}else await us.setPendingSecondaryEventCampaign(a,r)}this.sendPathTimeExpiredStat(n)}static async updatePendingSecondaryEventsHistory(e,t){const n=`${this.baseLogTag}.updatePendingSecondaryEventsHistory`,i=[],a=[],r=[],s=Date.now();for(let o=0;o<t.length;o++){const c=t[o],l=await us.getPendingSecondaryEventCampaign(c);if(l){if(l.time_left-=s-l.updated_time,l.updated_time=s,l.time_left<=0){const t=await Or(c);t?.campaignId&&($e.warn(1,n,`Campaign ${c} which is associated to the event: ${e.name} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),r.push(t)),a.push(c);continue}const t=l.operator;for(let r=0;r<l.events.length;r++){const s=l.events[r],o=s.operator;for(let r=0;r<s.filters.length;r++){const d=s.filters[r],g=d.attributes,u=d.executed;e.name===d.action_name&&(g&&zr.isTriggered(e,g.filters,null,g.filterOperator)||!e.attributes||!e.attributes.length)&&(u?o===is.OR?(s.toBeRemoved=!0,t!==is.OR&&(t!==is.AND||l.events.length&&!l.events.every(e=>e.toBeRemoved))||($e.log(1,n,`Campaign: ${c}, triggered by event: ${e.name}, is eligible for further processing`),i.push(c))):o===is.AND&&(d.toBeRemoved=!0,s.filters.every(e=>e.toBeRemoved)&&(s.toBeRemoved=!0,(t===is.OR||t===is.AND&&l.events.every(e=>e.toBeRemoved))&&($e.log(1,n,`Campaign: ${c}, triggered by event: ${e.name}, is eligible for further processing`),i.push(c)))):o===is.OR?(d.toBeRemoved=!0,s.filters.every(e=>e.toBeRemoved)&&(t===is.AND||t===is.OR&&1===l.events.length?($e.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${c}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(c)):s.toBeRemoved=!0)):o===is.AND&&(s.toBeRemoved=!0,1===l.events.length&&l.events[0].toBeRemoved&&t===is.OR&&($e.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${c}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(c))))}}a.includes(c)||i.includes(c)||await this.updatePendingSecondaryEvents(c,l)}}return this.sendPathTimeExpiredStat(r),await this.clearCampaignsData(a),await this.clearCampaignsData(i),i}static sendPathTimeExpiredStat(e){for(let t=0;t<e.length;t++){const n=e[t];this.deliveryStats.setStats(n,Na.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Na.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED)}this.deliveryStats.sendDeliveryStats(e)}static async updatePendingSecondaryEvents(e,t){t.events=t.events.filter(e=>!e.toBeRemoved);for(let e=0;e<t.events.length;e++){const n=t.events[e];n.filters=n.filters.filter(e=>!e.toBeRemoved)}await us.setPendingSecondaryEventCampaign(e,t)}static async clearCampaignsData(e){for(let t=0;t<e.length;t++)await ps.deleteTimerAndRemoveFromStores(e[t])}static async removeStaleTriggeringPrimaryEventCampaigns(){const e=`${this.baseLogTag}.removeStaleTriggeringPrimaryEventCampaigns`,t=await us.getTriggeringPrimaryEventKeys(),n=await us.getPendingSecondaryEventKeys();t.forEach(async t=>{n.includes(t)||($e.warn(1,e,`Campaign: ${t} does not exist in pendingSecondaryEvents store but exists in triggeringPrimaryEvents store. Removing it from triggeringPrimaryEvents store`),await us.removeTriggeringPrimaryEvent(t))})}}class hs{static baseLogTag="OnsiteTriggerManager";primaryEventsHash={};secondaryEventsHash={};messagingCampaigns=[];scrollCampaigns=[];scrollCampaignTriggered=!1;exitIntentCampaigns=[];exitCampaignTriggered=!1;listener=null;historyManager=window[he];scrollListenerCallback;windowEventManager;constructor(e){this.messagingCampaigns=e,this.windowEventManager=new gs}onTrigger(e){this.listener=e}async handlePrimaryEvent(e){const t=`${hs.baseLogTag}.handlePrimaryEvent`,n=this.primaryEventsHash[e.name],i=[],a=[];for(let e=0;e<n.length;e++){const t=n[e],r=await Or(t);Nr(r)?i.push(r):He(r,"triggerData.primary_condition.included_filters.filter_operator")===is.OR&&a.push(r)}const r=i.filter(t=>zr.didPrimaryEventFilterTrigger(e,t));r.length&&await ms.createPendingSecondaryEvents(r,e);const s=a.filter(t=>zr.getFilterResult(e,t));s.length&&($e.log(1,t,`Campaigns triggered for event ${e.name}: ${s.length}`),this.trigger(s,e))}async handleSecondaryEvent(e){const t=`${hs.baseLogTag}.handleSecondaryEvent`,n=await ms.updatePendingSecondaryEventsHistory(e,this.secondaryEventsHash[e.name]);let i=[];for(let e=0;e<n.length;e++)i.push(await Or(n[e]));i=i.filter(e=>zr.getURLFilterResult(e)),i.length&&($e.log(1,t,`Campaigns triggered by secondary event "${e.name}": ${i.length}`),this.trigger(i))}onEvent=async e=>{const t=hs.baseLogTag+".onEvent";try{null!=this.primaryEventsHash[e.name]&&await this.handlePrimaryEvent(e),null!=this.secondaryEventsHash[e.name]&&await this.handleSecondaryEvent(e)}catch(e){$e.error(1,t,"Error occurred during check event trigger campaigns: ",e)}};onScroll=async e=>{const t=hs.baseLogTag+".onScroll";try{if(this.scrollCampaigns&&this.scrollCampaigns.length>0&&!this.scrollCampaignTriggered){const n=await this.getCampaignsFromHash(re),i=await Tr(n);i?.map(async n=>{const i=n?.triggerData?.primary_condition?.included_filters?.filters[0]?.attributes?.filters[0];if(i){const a=new ti(i.name,i.value),r=await qi.createEvent(re,[a]);zr.getFilterResult(r,n)&&e>i.value&&!this.scrollCampaignTriggered&&(this.scrollCampaignTriggered=!0,window.removeEventListener("scroll",this.scrollListenerCallback),$e.log(1,t,"Triggered Scroll campaign"),this.trigger([n],r))}})}}catch(e){$e.error(1,t,"Error occurred in triggering scroll campaigns ",e)}};onExit=async e=>{const t=hs.baseLogTag+".onExit";try{if(this.exitIntentCampaigns.length>0&&!this.exitCampaignTriggered){const n=await qi.createEvent(oe,[]),i=(await this.getCampaignsFromHash(ae)).filter(e=>zr.getFilterResult(n,e));i.length?($e.log(1,t,"Triggered Exit Intent campaign: ",i),this.trigger(i,n)):("onBackClick"===e&&window.history.back(),$e.log(1,t,"No Exit Intent campaign is eligible."))}}catch(e){$e.error(1,t,"Error occurred in triggering exit intent campaigns ",e)}};async getCampaignsFromHash(e){const t=[],n=this.primaryEventsHash[e];if(n?.length)for(let e=0;e<n.length;e++)t.push(await Or(n[e]));return t}addEntryInEventsHash(e,t,n){null==e[t]&&(e[t]=[]),e[t].push(n)}createPrimaryEventsHash(e){const t=He(e,"triggerData.primary_condition.included_filters.filters",[]);t&&t.forEach(t=>{this.addEntryInEventsHash(this.primaryEventsHash,t.action_name,e.campaignId)})}createSecondaryEventsHash(e){const t=He(e,"triggerData.secondary_condition.included_filters.filters",[]);t?.forEach(t=>{"nested_filters"===t.filter_type?t.filters.filters.forEach(t=>{this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)}):this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)})}async startWatching(){if(this.messagingCampaigns.forEach(e=>{this.createPrimaryEventsHash(e),this.createSecondaryEventsHash(e)}),this.historyManager){this.historyManager.getHistory().forEach(this.onEvent),this.historyManager.addEventListener(this.onEvent)}this.scrollCampaignTriggered=!1,this.scrollCampaigns=this.messagingCampaigns.filter(e=>Dr(e,re)),this.scrollCampaigns.length>0&&(this.scrollListenerCallback=this.windowEventManager.onScroll(this.onScroll)),this.exitCampaignTriggered=!1,this.exitIntentCampaigns=this.messagingCampaigns.filter(e=>Dr(e,ae)),this.exitIntentCampaigns.length>0&&this.windowEventManager.onExit(this.onExit)}setScrollListenerCallback(e){this.scrollListenerCallback=e}getScrollListenerCallback(){return this.scrollListenerCallback}getWindowEventManager(){return this.windowEventManager}trigger(e,t){null!=this.listener&&this.listener(e,t)}destroy(){this.listener=null}}class fs{campaignMeta;data;waitForDelay=null;delayTimer=null;iframe=null;onFrameLoad=new Gn;active=!1;dismissInterval=null;isJSONPayloadApproach=!1;osmDivRendering=null;osmDivSelector=null;campaignRendered=!1;constructor(e,t){this.campaignMeta=e,this.data=t,this.active=!1,this.campaignRendered=!1;const n=He(e,"triggerData.trigger_delay.delayInSeconds",0)||0;this.waitForDelay=new Promise(e=>{this.delayTimer=setTimeout(()=>{this.campaignRendered=!0,e()},1e3*n)})}isActive=()=>this.active;setIsActive(e){this.active=e}}const Es={CENTER:{position:"absolute",top:"50%",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, -50%)"},CENTER_LEFT:{position:"absolute",top:"50%",left:"10px",bottom:"auto",right:"auto",transform:"translate(0,-50%)"},CENTER_RIGHT:{position:"absolute",top:"50%",right:"10px",bottom:"auto",left:"auto",transform:"translate(0,-50%)"},TOP_LEFT:{position:"absolute",top:"10px",left:"10px",bottom:"auto",right:"auto"},TOP_CENTER:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},TOP_RIGHT:{position:"absolute",top:"10px",right:"10px",bottom:"auto",left:"auto"},BOTTOM_LEFT:{position:"absolute",bottom:"10px",left:"10px",top:"auto",right:"auto"},BOTTOM_CENTER:{position:"absolute",left:"50%",bottom:"10px",top:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM_RIGHT:{position:"absolute",bottom:"10px",right:"10px",top:"auto",left:"auto"},TOP:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM:{position:"absolute",bottom:"0",top:"auto",right:"auto",left:"50%",transform:"translate(-50%, 0)"},LEFT:{position:"absolute",left:"0",bottom:"auto",right:"auto",top:"auto"},RIGHT:{position:"absolute",right:"0",bottom:"auto",left:"auto",top:"auto"}},Ss="OsmFunctions",_s=(e,t)=>{const n=document.createElement("script");return n.type="text/javascript",n.text=((e,t)=>`\n    const moeSDK = window.parent.Moengage;\n    let moeOsmCampaignMeta = ${JSON.stringify(e)};\n    const moengage = {\n        trackEvent: function (eventName, eventAttr, isNonInteractive) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.track_event(eventName, eventAttr);\n          }\n          return Promise.resolve();\n        },\n        trackClick: function (id) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.clickTracker(OsmCampaignMeta, 'OSM', {\n                widget_id: id,\n              })();\n          }\n          return Promise.resolve();\n        },\n        trackDismiss: function (isAuto = false) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.dismissEvent(OsmCampaignMeta, 'OSM', isAuto);\n          }\n          return Promise.resolve();\n        },\n        setAlias: function (data) {\n          return moeSDK.update_unique_user_id(data);\n        },\n        setUniqueId: function (data) {\n          return moeSDK.add_unique_user_id(data);\n        },\n        identifyUser: function(data) {\n          return moeSDK.identifyUser(data);\n        },\n        destroySession: function () {\n          return moeSDK.destroy_session();\n        },\n        setUserName: function (data) {\n          return moeSDK.add_user_name(data);\n        },\n        setFirstName: function (data) {\n          return moeSDK.add_first_name(data);\n        },\n        setLastName: function (data) {\n          return moeSDK.add_last_name(data);\n        },\n        setEmailId: function (data) {\n          return moeSDK.add_email(data);\n        },\n        setMobileNumber: function (data) {\n          return moeSDK.add_mobile(data);\n        },\n        setGender: function (data) {\n          return moeSDK.add_gender(data);\n        },\n        setBirthDate: function (data) {\n            //iso date format only\n            return moeSDK.add_birthday(data);\n        },\n        setUserAttribute: function (name, value, userAttributeLevel) {\n            if (userAttributeLevel && typeof userAttributeLevel === 'string') {\n              return moeSDK.add_user_attribute(name, value, userAttributeLevel);\n            }\n            return moeSDK.add_user_attribute(name, value);\n        },\n        dismissMessage: function () {\n          setTimeout(() => {\n            moeSDK.onsite.displayManager?.dismissInapp('${t}');\n          }, 100)\n        },\n        showPushOptIn: function (config) {\n          return moeSDK.call_web_push(config);\n        },\n        copyText: function (selector) {\n          return new Promise((res, rej) => {\n            if(!selector) rej();\n            var text = document.querySelector(selector);\n            if(text.textContent) {\n              navigator.clipboard.writeText(text.textContent);\n              res(null);\n            }\n            else {\n              text.select();\n              text.setSelectionRange(0, 99999);\n              navigator.clipboard.writeText(text.value);\n              res(null);\n            }\n          })\n        }\n    }\n    const MoeOsm = moengage;\n    `)(e,t),n.setAttribute("data-moe-script","1"),n},vs=e=>{const t=`${Ss}.getCampaignMeta`;try{return!ys()&&window.Moengage.onsite.displayManager.campaignRenderMap[e].campaignMeta}catch{$e.error(1,t,`Campaign meta not found: ${e}`)}},ys=()=>{const e=`${Ss}.isTestCampaign`;return!!window.Moengage.onsite.displayManager.testCampaign&&($e.log(1,e,"Test campaign element. No data will be sent to BE right now. We'll start tracking events once the campaign is live"),!0)},Ts=()=>($e.log(1,Ss,"Osm Functions for tracking user behaviour"),{trackEvent(e,t,n,i){const a=vs(e);if({}.constructor===n.constructor&&a){const e={campaign_id:a.campaignId,campaign_name:a.campaignName,...a.campaignContext,...n};return window.Moengage.track_event(t,e)}return Promise.resolve()},trackClick(e,t){const n=vs(e);return n?window.Moengage.onsite.displayManager.clickTracker(n,"OSM",{widget_id:t})():Promise.resolve()},trackDismiss(e,t=!1){const n=vs(e);return n?window.Moengage.onsite.displayManager.dismissEvent(n,"OSM",t):Promise.resolve()},setAlias:e=>window.Moengage.update_unique_user_id(e),setUniqueId:e=>window.Moengage.add_unique_user_id(e),identifyUser:e=>window.Moengage.identifyUser(e),destroySession:()=>window.Moengage.destroy_session(),setUserName:e=>window.Moengage.add_user_name(e),setFirstName:e=>window.Moengage.add_first_name(e),setLastName:e=>window.Moengage.add_last_name(e),setEmailId:e=>window.Moengage.add_email(e),setMobileNumber:e=>window.Moengage.add_mobile(e),setGender:e=>window.Moengage.add_gender(e),setBirthDate:e=>window.Moengage.add_birthday(e),setUserAttribute:(e,t,n="PROJECT")=>window.Moengage.add_user_attribute(e,t,n),dismissMessage(e){setTimeout(()=>{window.Moengage.onsite.displayManager?.dismissInapp(`${e}`)},100)},showPushOptIn:e=>window.Moengage.call_web_push(e),copyText:e=>new Promise((t,n)=>{e||n();const i=document.querySelector(e);i.textContent?(navigator.clipboard.writeText(i.textContent),t(null)):(i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value),t(null))})});function bs(e){return`moe-onsite-campaign-${e}`}function Is(){const e=Ge();if(e)return e.accessibilityFocusTrap||(e.accessibilityFocusTrap={lastActiveElement:[],dismissOsmEventHandlers:{},keyboardTrapHandler:null,focusTrapStack:[],focusedElements:[]}),e.accessibilityFocusTrap}function As(e){const t=Is();t&&(t.keyboardTrapHandler=e)}function ws(e,t){"Escape"===t.key&&(window.MoeOsm.trackDismiss(e),window.MoeOsm.dismissMessage(e))}function Ds(e){const t=Is();if(!t)return;t.dismissOsmEventHandlers[e]&&Cs(e);const n=ws.bind(null,e);t.dismissOsmEventHandlers[e]=n,window.addEventListener("keyup",n);const i=bs(e),a=document.getElementById(i);a&&"IFRAME"===a.tagName&&a.contentWindow&&a.contentWindow.addEventListener("keyup",n)}function Cs(e){const t=Is();if(!t)return;const n=t.dismissOsmEventHandlers[e];if(n){window.removeEventListener("keyup",n);const i=bs(e),a=document.getElementById(i);a&&"IFRAME"===a.tagName&&a.contentWindow&&a.contentWindow.removeEventListener("keyup",n),delete t.dismissOsmEventHandlers[e]}}function Os(){const e=Is();if(!e)return;const t=e.lastActiveElement.pop();t?.id===Se?t.contentDocument?.getElementById(_e)?.focus({preventScroll:!0}):t&&"function"==typeof t.focus?t.focus({preventScroll:!0}):document.body.focus({preventScroll:!0})}function Ps(e,t,n=!1){const i=bs(e),a=document.getElementById(i);a&&(Ds(e),function(e){if(e){const t=e.querySelector(".brz-popup2__preview");let n=Ee,i="dialog";t&&(t.hasAttribute("aria-label")&&(n=t.getAttribute("aria-label"),t.removeAttribute("aria-label")),t.hasAttribute("role")&&(i=t.getAttribute("role"))),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",n),e.setAttribute("role",i),e.setAttribute("aria-modal","true")}}(a),"POP_UP"===t?function(e,t=document,n=!1){const i=Is();if(!i)return;const a=Rs(e)||e;if(!a)return;!function(e){const t=Is();if(!t)return;if(!e||!e.parentElement)return;const n=t.focusTrapStack.indexOf(e);-1!==n&&t.focusTrapStack.splice(n,1);t.focusTrapStack.push(e),Ls()}(e);const r=a.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0===r?.length)return void(a.hasAttribute("tabindex")&&"-1"!==a.getAttribute("tabindex")&&a.focus({preventScroll:!0}));const s=r[0],o=r[r.length-1];Ns(a,!0,n);let c=null;const l=n=>{if("Tab"!==n.key)return;let i=!1,a=t.activeElement;if("IFRAME"===e.tagName){const t=e.contentDocument;t&&t.activeElement&&(a=t.activeElement,i=a===t.body||t.body.contains(a))}else i=a===e||e.contains(a);return i?(a&&"moe-focus-trap-end"!==a.id&&(c=a),a&&"moe-focus-trap-end"===a.id?(n.preventDefault(),void(n.shiftKey?(c||o).focus({preventScroll:!0}):s.focus({preventScroll:!0}))):void(n.shiftKey&&a===s?(n.preventDefault(),o.focus({preventScroll:!0})):n.shiftKey||a!==o||(n.preventDefault(),s.focus({preventScroll:!0})))):(n.preventDefault(),void e.focus({preventScroll:!0}))};i.keyboardTrapHandler&&t.removeEventListener("keydown",i.keyboardTrapHandler);i.keyboardTrapHandler=l,As(l),t.addEventListener("keydown",i.keyboardTrapHandler)}(a,document,n):Ns(a,!1,n))}function Ns(e,t=!1,n=!0){if(!e)return;const i=Is();if(!i)return;if(n&&function(e){const t=Is(),n=parseInt(window.getComputedStyle(e).zIndex,10)||0;t.focusedElements=t.focusedElements.filter(e=>document.body.contains(e)),t.focusedElements.forEach(e=>{const t=parseInt(window.getComputedStyle(e).zIndex,10)||0;t>=n&&(e.style.zIndex=(t-1).toString())}),t.focusedElements.push(e)}(e),i.focusTrapStack.length>0&&!t)return void i.lastActiveElement.push(e);const a=e.id===Se,r=Rs(e)||e,s=i.focusTrapStack;if(!s||0===s.length||t)if(document.activeElement&&document.activeElement instanceof HTMLElement&&i.lastActiveElement.push(document.activeElement),a){const t=e.contentDocument,n=t?.getElementById(_e);n&&n.focus({preventScroll:!0})}else r&&(r.setAttribute("tabindex","0"),r.focus({preventScroll:!0}));else r&&i.lastActiveElement.push(e)}function Rs(e){if(!e)return;let t=e;if("IFRAME"===e.tagName){const n=e.contentDocument;t=n?.body?n.body:n?.activeElement?n.activeElement:e}return t}function Ms(e,t=document){const n=Is();if(n&&(function(e){const t=Is();if(!t)return;if(e){const n=t.focusTrapStack.indexOf(e);-1!==n&&t.focusTrapStack.splice(n,1)}else t.focusTrapStack.length=0;Ls()}(e),n.keyboardTrapHandler&&(t.removeEventListener("keydown",n.keyboardTrapHandler),n.keyboardTrapHandler=null,As(null)),n.focusTrapStack.length>0)){const e=n.focusTrapStack[n.focusTrapStack.length-1];e&&"function"==typeof e.focus&&setTimeout(()=>{e.focus({preventScroll:!0})})}}function Ls(){const e=Is();if(!e)return;document.querySelectorAll("[data-moe-prev-aria-hidden]").forEach(e=>{if(e instanceof HTMLElement){const t=e.getAttribute("data-moe-prev-aria-hidden");"false"===t?e.removeAttribute("aria-hidden"):"true"===t?e.setAttribute("aria-hidden","true"):"null"===t&&e.removeAttribute("aria-hidden"),e.removeAttribute("data-moe-prev-aria-hidden")}});document.querySelectorAll("[data-moe-prev-tabindex]").forEach(e=>{if(e instanceof HTMLElement){const t=e.getAttribute("data-moe-prev-tabindex");""===t?e.removeAttribute("tabindex"):e.setAttribute("tabindex",t),e.removeAttribute("data-moe-prev-tabindex")}});const t=e.focusTrapStack[e.focusTrapStack.length-1];if(document.querySelectorAll('[role="dialog"][aria-modal="true"]').forEach(e=>{e instanceof HTMLElement&&e!==t&&(e.removeAttribute("role"),e.removeAttribute("aria-modal"))}),0===e.focusTrapStack.length)return;const n=[],i=["a[href]","button","input","select","textarea","[tabindex]",'[contenteditable="true"]'].join(","),a=t.parentElement;if(a){for(const e of Array.from(a.children))if(e!==t&&e instanceof HTMLElement){e.hasAttribute("data-moe-prev-aria-hidden")||(e.hasAttribute("aria-hidden")?e.setAttribute("data-moe-prev-aria-hidden",e.getAttribute("aria-hidden")):e.setAttribute("data-moe-prev-aria-hidden","null")),e.setAttribute("aria-hidden","true"),n.push(e);e.querySelectorAll(i).forEach(e=>{e.hasAttribute("data-moe-prev-tabindex")||(e.hasAttribute("tabindex")?e.setAttribute("data-moe-prev-tabindex",e.getAttribute("tabindex")):e.setAttribute("data-moe-prev-tabindex","")),e.setAttribute("tabindex","-1")})}t._ariaHiddenSiblings=n}}async function ks(e,t,n,i,a,r){const s=Rr(t),o=/moe-campaign-id/g;function c(e){return new Promise((n,i)=>{const a=document.createElement("script");for(let n=0;n<e.attributes.length;n++){const{name:i}=e.attributes[n];let{value:r}=e.attributes[n];"src"===i&&(r.includes("typeform")||r.includes("tv-button"))&&(r+=`?campaignId=${t}`),a.setAttribute(i,r)}a.src?(a.onload=n,a.onerror=i):(a.innerHTML=e.innerHTML,n());document.querySelector(`#${s}`).appendChild(a)})}function l(e){try{["trackEvent","trackClick","trackDismiss","dismissMessage","leadGenFormSubmit","fetchRatingValue"].forEach(n=>{!function(e,n){const i=e.querySelectorAll("[onclick]");i.forEach(e=>{const i=e.getAttribute("onclick").replace(new RegExp(n+"\\((.*?)\\)","g"),(e,i)=>i?`${n}('${t}',${i})`:`${n}('${t}')`);e.setAttribute("onclick",i)})}(e,n)})}catch(e){$e.error(2,"InsertCustomHtmlJs.addCampaignId","Error while adding Campaign Id",e)}}await(async()=>{try{let{root:d}=e;const{styles:g,scripts:u}=e,p=document.createElement("div");p.id=s,n.parentNode.insertBefore(p,n);const m=document.querySelector(`#${s}`),h=new DOMParser;d=d.replace(o,t);const f=h.parseFromString(d,"text/html");await async function(e){try{const t=e.getElementsByTagName("a");for(let e=t.length-1;e>=0;e--)""===t[e].getAttribute("href")&&t[e].removeAttribute("href")}catch(e){$e.error(2,"InsertCustomHtmlJs.removeEmptyHrefTags","Error while removing Empty href attributes",e)}}(f),l(f);const E=g.map(e=>h.parseFromString(e,"text/html").head.childNodes[0]),S=u.map(e=>{e=e.replace(o,t);return h.parseFromString(e,"text/html").head.childNodes[0]}),_=E.map(e=>new Promise((t,n)=>{!function(e){const{node:t,onLoad:n,onError:i}=e;t instanceof HTMLMetaElement||"dns-prefetch"===t.getAttribute("rel")?n():(t.onload=()=>n(),t.onerror=()=>i()),document.querySelector(`#${s}`).appendChild(t)}({node:e,onLoad:t,onError:n})}));await Promise.all(_).catch(e=>{$e.warn(1,"InsertCustomHtmlJs","Error loading Styles",e?.message||"")});const v=f.body.childNodes[0];m.appendChild(v);async function y(e){for(const t of e)await c(t)}[...v.querySelectorAll(".brz-embed-code script")].map(e=>{!function(e){const t=document.createElement("script");t.innerHTML=e.innerHTML;for(let n=0;n<e.attributes.length;n++){const{name:i,value:a}=e.attributes[n];t.setAttribute(i,a)}e.replaceWith(t)}(e)}),y(S).then(()=>{window.Brz.emit("init.dom",window.jQuery(v)),$e.log(1,"InsertCustomHtmlJs",`Custom HTML/JS DOM Level OSM Insertion: ${s}`),function(e,t){e&&(Ds(e),window.Brz.on("elements.popup.open",Ps.bind(null,e,t)))}(t,i.templateType),a&&a(i,"OSM",!1,r)()}).catch(e=>{$e.warn(1,"InsertCustomHtmlJs","Error loading script",e?.message||"")})}catch(T){$e.error(2,"InsertCustomHtmlJs",`Failed to Insert OSM into DOM: ${s}`)}})()}class xs{static baseLogTag="MessagingDisplayManager";renderListener=null;initializationPromiseObject=null;campaignRenderOrder=[];campaignRenderMap={};testCampaign;initialInlineBodyStyle;clickTracker;dismissEvent;onsiteApiClient;constructor(e){this.clickTracker=hr,this.dismissEvent=Sr,this.onsiteApiClient=e,this.startInitialization()}async startInitialization(){const e=`${xs.baseLogTag}.startInitialization`;try{null==this.initializationPromiseObject&&(this.initializationPromiseObject=new Gn),this.initializationPromiseObject.res()}catch(t){$e.error(1,e,"Error initializing display managaer:",t)}}getOSMPusher(e){const t=document.createElement("div");if(t.id=Va,t.style.setProperty("display","block","important"),t.style.height=e+"px","FRAMESET"===document.body.nodeName){const e=document.head;e.parentNode.insertBefore(t,e)}else{const e=document.body.firstChild;e.parentNode.insertBefore(t,e)}return t}removeOSMPusher(){document.getElementById(Va)?.remove()}async queueDraftCampaign(e,t){const n=`${xs.baseLogTag}.queueDraftCampaign`;try{await this.initializationPromiseObject.p,e.position=t.position,this.testCampaign=e;const i=!("1"!==t.editorVersion||!t.htmlJsonPayload),a=!i&&xs.createDefaultIframe(this.testCampaign.draftId,t.payload);let r;$e.warn(1,n,`Going to render test campaign ${e.draftId}`),r="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,i?(await ks(t.htmlJsonPayload,this.testCampaign.draftId,r,{templateType:e.templateType},void 0,this.onsiteApiClient),this.renderTestCampaign(e,a,t)):(r.parentNode.insertBefore(a,r),a.onload=()=>{a.contentWindow.postMessage({campaignId:e.draftId},"*"),"1"===t.editorVersion?this.handleBridgeInsertion(a.contentDocument,e.draftId):this.handleClassBasedTrackingForTestCampaign(a,t,e),this.renderTestCampaign(e,a),Ps(e.draftId,e.templateType)})}catch(e){$e.error(1,n,"Error queueing draft campaign",e)}}dismissTestInapp=e=>{Ms(),Cs(e),Os(),this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):null===this.initialInlineBodyStyle&&document.body.removeAttribute("style"),this.removeOSMPusher(),this.pushCardsTemplate(0),setTimeout(()=>document.getElementById(`moe-onsite-campaign-${e}`)?.remove(),0)};async renderTestCampaign(e,t,n){if(t){if(t.style.visibility="hidden",t.style.display="block",t.style.zIndex="2147483647",e.displaySettings.config.blocking)t.style.height=`${window.innerHeight}px`,t.style.width="100%";else if(t.style.height=getComputedStyle(t.contentDocument.body).height,t.style.width=getComputedStyle(t.contentDocument.body).width,e.templateType===as.POP_UP&&(t.style.margin="0px auto"),t.srcdoc.indexOf(Fa)>-1){const n=t.srcdoc.indexOf(Ha)>-1;this.adjustPositionOfCampaign(t.style,e.position,n)}t.style.visibility="visible",this.testCampaignPositionStyling(e,t),e.displaySettings.config.scrollable||(document.body.style.overflow="hidden")}else{const t=document.getElementById(Rr(e.draftId));t.style.zIndex="2147483647",this.testCampaignPositionStyling(e,t)}e.templateType===as.BANNER&&this.bannerTestCampaignStyling(e,t,n)}async queueLiveCampaign(e,t){const n=`${xs.baseLogTag}.queueLiveCampaign`;e.campaignContext=t.campaignContext,e.editorVersion=t.editorVersion;try{if(await this.initializationPromiseObject.p,null==this.campaignRenderMap[e.campaignId]||!this.campaignRenderMap[e.campaignId].isActive()&&null===this.campaignRenderMap[e.campaignId].delayTimer){let i;this.campaignRenderOrder.push(e.campaignId),this.campaignRenderMap[e.campaignId]=new fs(e,t),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach=!("1"!==t.editorVersion||!t.htmlJsonPayload),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach?this.campaignRenderMap[e.campaignId].osmDivRendering=n=>ks(t.htmlJsonPayload,e.campaignId,n,e,fr,this.onsiteApiClient):(i=xs.createDefaultIframe(e.campaignId,this.campaignRenderMap[e.campaignId].data.payload),this.campaignRenderMap[e.campaignId].iframe=i),await this.campaignRenderMap[e.campaignId].waitForDelay,await this.canCampaignBeRendered(e)?($e.warn(1,n,`Going to render ${e.campaignId}`),this.campaignRenderMap[e.campaignId].setIsActive(!0),null!=this.renderListener&&this.renderListener(e),this.renderAllActiveCampaigns()):$e.warn(1,n,`Can not render ${e.campaignId}`)}else $e.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`)}catch(t){$e.error(1,n,`Error queuing campaign ${e.campaignId}`,t)}}async renderAllActiveCampaigns(){const e=`${xs.baseLogTag}.renderAllActiveCampaigns`,t=this.getActiveCampaigns();if(this.restoreBodyStyle(),t.length>0){for(let n=0;n<t.length;n++){if(!t[n].isJSONPayloadApproach&&"visible"===t[n].iframe.style.visibility){t[n].iframe.style.zIndex=(2147483647-(t.length-n-1)).toString();continue}if(null==document.getElementById(Rr(t[n].campaignMeta.campaignId))){let e;e="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,t[n].isJSONPayloadApproach?(await t[n].osmDivRendering(e),t[n].onFrameLoad.res(),t[n].osmDivSelector=document.getElementById(Rr(t[n].campaignMeta.campaignId))):(e.parentNode.insertBefore(t[n].iframe,e),t[n].iframe.onload=()=>{this.initialInlineBodyStyle=document.body.getAttribute("style"),Us.setScrollState(t),t[n].iframe.contentWindow.postMessage({campaignId:t[n].campaignMeta.campaignId},"*"),"1"===t[n].campaignMeta.editorVersion?(this.handleBridgeInsertion(t[n].iframe.contentDocument,t[n].campaignMeta.campaignId,t[n].campaignMeta),this.changeAnchorTagReDirectionMethod(t[n].iframe)):this.handleClassBasedTracking(t[n]),t[n].onFrameLoad.res()})}if(await t[n].onFrameLoad.p,t[n].isJSONPayloadApproach)$e.log(1,e,`zindex for ${t[n].campaignMeta.campaignId}`,2147483647..toString()),t[n].osmDivSelector.style.zIndex=(2147483647-(t.length-n-1)).toString(),this.liveCampaignPositionStyling(t[n].campaignMeta,t[n].osmDivSelector);else{if(t[n].iframe.style.visibility="hidden",t[n].iframe.style.display="block",$e.log(1,e,`zindex for ${t[n].campaignMeta.campaignId}`,2147483647..toString()),t[n].iframe.style.zIndex=(2147483647-(t.length-n-1)).toString(),t[n].iframe.style.margin="0",t[n].campaignMeta.display.config.blocking)t[n].iframe.style.height=`${window.innerHeight}px`,t[n].iframe.style.width="100%";else if(t[n].iframe.style.height=getComputedStyle(t[n].iframe.contentDocument.body).height,t[n].iframe.style.padding.includes("10px")?t[n].iframe.style.width=parseInt(getComputedStyle(t[n].iframe.contentDocument.body).width)+20+"px":t[n].iframe.style.width=getComputedStyle(t[n].iframe.contentDocument.body).width,t[n].campaignMeta.templateType===as.POP_UP&&(t[n].iframe.style.margin="0px auto"),t[n].data.payload&&t[n].data.payload.indexOf(Fa)>-1){const e=t[n].data.payload.indexOf(Ha)>-1;this.adjustPositionOfCampaign(t[n].iframe.style,t[n].data.position,e)}t[n].iframe.style.visibility="visible",this.liveCampaignPositionStyling(t[n].campaignMeta,t[n].iframe),fr(t[n].campaignMeta,"OSM",!1,this.onsiteApiClient)(),Ps(t[n].campaignMeta.campaignId,t[n].campaignMeta.templateType)}if(null==t[n].dismissInterval){const e=1e3*He(t[n].campaignMeta,"delivery.dismissInterval",0);e>0&&(t[n].dismissInterval=setTimeout(()=>{const e=this.campaignRenderMap[t[n].campaignMeta.campaignId];e&&e.isActive()&&(this.dismissInapp(t[n].campaignMeta.campaignId),window.MoeFocusHandler&&window.MoeFocusHandler(),Sr(t[n].campaignMeta,"OSM",!0))},e))}}this.bannerLiveCampaignsStyling(t)}}restoreBodyStyle(){this.removeOSMPusher(),this.pushCardsTemplate(0);let e=0;Object.keys(this.campaignRenderMap).forEach(t=>{this.campaignRenderMap[t].campaignMeta.templateType===as.POP_UP&&this.campaignRenderMap[t].isActive()&&e++}),e>=1||(this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):null===this.initialInlineBodyStyle&&document.body.removeAttribute("style"))}async canCampaignBeRendered(e){const t=`${xs.baseLogTag}.canCampaignBeRendered`;try{const t=await sr.campaingsStatsStore.getItem(e.campaignId),n=await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.GLOBAL_DELAY),i=await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME);return yr.isValid(e,t)&&yr.isValidMessagingCampaign(e,t,n,i,this.getActiveCampaigns())&&zr.getURLFilterResult(e)}catch(n){$e.error(1,t,`Error checking if campaign ${e.campaignId} can be rendered:`,n)}return!1}static createDefaultIframe(e,t){xs.baseLogTag;const n=Rr(e),i=document.createElement("iframe");return i.setAttribute("id",n),i.style.left="0px",i.style.top="0px",i.style.bottom="0px",i.style.right="0px",i.style.border="0px none",i.style.height="100%",i.style.width=window.innerWidth.toString()+"px",i.style.padding="0",i.style.overflow="hidden",i.style.overflowY="hidden",i.style.zIndex="999999",i.style.display="none",i.style.position="fixed",i.setAttribute("srcdoc",t),i}onRender(e){this.renderListener=e}dismissInapp=(e,t=!0)=>{if(Ms(document.getElementById(Rr(e))),Os(),Cs(e),0===this.getActiveCampaigns().length)return void this.dismissTestInapp(e);const n=this.getActiveCampaigns();setTimeout(()=>{n.forEach(t=>{t.campaignMeta.campaignId===e&&(t.iframe?t.iframe?.remove():t.osmDivSelector?.remove())})},0),this.campaignRenderMap[e].setIsActive(!1),this.campaignRenderOrder=this.campaignRenderOrder.filter(t=>t!==e),clearInterval(this.campaignRenderMap[e].dismissInterval),this.campaignRenderMap[e].delayTimer=null,t&&Ti.broadcastToWindow({topic:"OSM_INTERNAL_EVENT",name:"DISMISS",data:e}),this.renderAllActiveCampaigns()};getActiveCampaigns(){return this.campaignRenderOrder.map(e=>this.campaignRenderMap[e]).filter(e=>e.isActive())}destroy(){this.getActiveCampaigns().forEach(e=>{e.setIsActive(!1)}),this.renderAllActiveCampaigns(),this.campaignRenderOrder=[],this.campaignRenderMap={}}adjustPositionOfCampaign(e,t,n){t&&(Object.assign(e,Es[t]),Fn()&&n&&this.addMarginInMweb(e,t))}addMarginInMweb(e,t){const n={paddingLeft:"10px",paddingRight:"10px",marginTop:"0",marginBottom:"0"};"TOP"===t&&(n.marginTop="10px"),"BOTTOM"===t&&(n.marginBottom="10px"),Object.assign(e,n)}handleBridgeInsertion(e,t,n){const i=`${xs.baseLogTag}.handleBridgeInsertion`;try{e.head.append(_s(n,t)),$e.log(2,i,"JS-bridge script inserted successfully",t)}catch(e){$e.warn(2,i,"Failed to insert OSM JS Bridge: ",t)}}handleClassBasedTrackingForTestCampaign(e,t,n){const i=`${xs.baseLogTag}.handleClassBasedTrackingForTestCampaign`,a=e=>Array.prototype.slice.call(e),r=a(e.contentDocument.getElementsByClassName(Ba)),s=a(e.contentDocument.getElementsByClassName(Ua)),o=a(e.contentDocument.getElementsByTagName("a"));if(0===r.length&&$e.warn(1,i,"No dismiss class items present in this template"),0===s.length&&$e.warn(1,i,"No click class items present in this template"),t.payload.indexOf("TEXT_INPUT")>-1||t.payload.indexOf('dynamic-listeners="true"')>-1)e.contentDocument.body.addEventListener("click",e=>{e.target&&e.target.classList.contains(Ua)&&$e.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live"),e.target&&e.target.classList.contains(Ba)&&this.dismissTestInapp(n.draftId)});else{for(const e of s)e.addEventListener("click",e=>{$e.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live")});for(const e of r)e.addEventListener("click",()=>{this.dismissTestInapp(n.draftId)})}for(const e of o){"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}}handleClassBasedTracking(e){const t=`${xs.baseLogTag}.handleClassBasedTracking`,n=e=>Array.prototype.slice.call(e),i=e.iframe,a=n(i.contentDocument.getElementsByClassName(Ba)),r=n(i.contentDocument.getElementsByClassName(Ua)),s=n(i.contentDocument.getElementsByTagName("a"));if(0===a.length&&$e.warn(1,t,"No dismiss class items present in this template"),0===r.length&&$e.warn(1,t,"No click class items present in this template"),e.data.payload&&(e.data.payload.indexOf("TEXT_INPUT")>-1||e.data.payload.indexOf('dynamic-listeners="true"')>-1))i.contentDocument.body.addEventListener("click",t=>{if(t.target&&t.target.classList.contains(Ua)){const n=t.target.dataset.id;hr(e.campaignMeta,"OSM",{widget_id:n})()}t.target&&t.target.classList.contains(Ba)&&(this.dismissInapp(e.campaignMeta.campaignId),t.target.classList.contains(Ua)||Sr(e.campaignMeta,"OSM"))});else{for(const t of r)t.addEventListener("click",t=>{const n=t.target.dataset.id;hr(e.campaignMeta,"OSM",{widget_id:n})()});for(const t of a)t.addEventListener("click",()=>{this.dismissInapp(e.campaignMeta.campaignId),t.classList.contains(Ua)||Sr(e.campaignMeta,"OSM")})}for(const e of s){"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}}changeAnchorTagReDirectionMethod(e){const t=`${xs.baseLogTag}.changeAnchorTagReDirectionMethod`;try{const n=(e=>Array.prototype.slice.call(e))(e.contentDocument.getElementsByTagName("a"));for(const e of n){const t=e.getAttribute("target"),n=e.getAttribute("href");n&&"_parent"===t&&(e.setAttribute("onclick",`setTimeout(()=>{window.open('${n}','_parent')})`),e.removeAttribute("href"))}$e.log(1,t,`Anchor Tag Href Rendering Changed to onClick for Campaign Frame: ${e.id}`)}catch{$e.error(1,t,`Failed to Change Anchor Tag Href Rendering for Campaign Frame: ${e.id}`)}}liveCampaignPositionStyling(e,t){const n=`${xs.baseLogTag}.liveCampaignPositionStyling`;try{e.templateType===as.BANNER?e.display.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===as.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),$e.log(1,n,`Added Position Styles for CampaignId: ${e.campaignId}`)}catch{$e.error(1,n,`Failed adding Styles for CampaignId: ${e.campaignId}`)}}testCampaignPositionStyling(e,t){const n=`${xs.baseLogTag}.testCampaignPositionStyling`;try{e.templateType===as.BANNER?e.displaySettings.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===as.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),$e.log(1,n,`Added Position Styles for CampaignId: ${e.draftId}`)}catch{$e.error(1,n,`Failed adding Styles for CampaignId: ${e.draftId}`)}}bannerTestCampaignStyling(e,t,n){const i=`${xs.baseLogTag}.bannerTestCampaignStyling`;try{let n,a,r=!0;if(t)n=parseInt(getComputedStyle(t.contentDocument.body).height),r=t.srcdoc.indexOf(Fa)>-1;else{const t=document.querySelector("#"+Rr(e.draftId)+" .brz-container");n=parseInt(getComputedStyle(t).height)}a=e.displaySettings.config.pushPage&&(r&&"TOP"===e.position||!r)?this.getOSMPusher(n):this.getOSMPusher(0),this.pushCardsTemplate(n,a),$e.log(1,i,`Added Banner Styles for Test CampaignId: ${e.draftId}`)}catch{$e.error(1,i,`Failed Added Banner Styles for Test CampaignId: ${e.draftId}`)}}bannerLiveCampaignsStyling(e){const t=`${xs.baseLogTag}.bannerLiveCampaignsStyling`;let n=0,i=0;for(let a=e.filter(e=>e.campaignMeta.templateType===as.BANNER).length-1;a>=0;a--)try{if(e[a].isJSONPayloadApproach||e[a].iframe.contentDocument){let r,s=!0;e[a].isJSONPayloadApproach?r=parseInt(getComputedStyle(e[a].osmDivSelector.querySelector(".brz-container")).height):(r=parseInt(getComputedStyle(e[a].iframe.contentDocument.body).height),s=e[a].data.payload&&e[a].data.payload.indexOf(Fa)>-1),n+=r,e[a].campaignMeta.display.config.pushPage&&(s&&"TOP"===e[a].data.position||!s)&&(i+=r),$e.log(1,t,`Added Banner Styles for Live CampaignId: ${e[a].campaignMeta.campaignId}`)}}catch{$e.error(1,t,`Failed Adding Banner Styles for Live CampaignId: ${e[a].campaignMeta.campaignId}`)}const a=this.getOSMPusher(i);this.pushCardsTemplate(i,a)}pushCardsTemplate(e,t){window?.Moengage?.cards?.updatePushBannerHeight(e,t)}}class Us{static setScrollState(e){let t=!0;for(let n=0;n<e.length;n++)t=t&&e[n].campaignMeta.display.config.scrollable;t||(document.body.style.overflow="hidden")}}class Bs{campaignId;campaignName;expiryTime;updatedTime;dismissInterval;status;jsonPayload;context;urlFilters;constructor(e){this.campaignId=e.campaignId,this.campaignName=e.campaignName,this.expiryTime=e.expiryTime?new Date(e.expiryTime):null,this.updatedTime=e.updatedTime?new Date(e.updatedTime):null,this.status=e.status,this.jsonPayload=e.htmlJsonPayload,this.context=e.campaignContext,this.dismissInterval=e.delivery?.dismissInterval||0,this.urlFilters=e.triggerData?.url_condition||null}}class Fs{baseLogTag;OnsiteApiClient;displayManager;deliveryStats;constructor(e,t,n){this.baseLogTag="DeliveryFunnelManager",this.displayManager=t,this.OnsiteApiClient=new ds(e),this.deliveryStats=n}attemptCampaigns(e){e.forEach(e=>{this.deliveryStats.setStats(e,Na.ATTEMPTED.CAMPAIGN_ATTEMPTED)})}async getImpressionStats(e){const t=this.baseLogTag+".getImpressionStats";try{return await sr.campaingsStatsStore.getItem(e.campaignId)}catch(n){$e.error(1,t,`Error getting impression stats for ${e.campaignId}`,n)}}async getLastGlobalInappShown(){return await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME)}async getGlobalDelay(){return await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.GLOBAL_DELAY)}async filterValidCampaigns(e){const t=this.baseLogTag+".filterValidCampaigns";try{const n=e.map(e=>this.getImpressionStats(e)),i=await this.getLastGlobalInappShown(),a=await this.getGlobalDelay();try{const t=await Promise.all(n);return e.filter((e,n)=>{if(e.templateType!==as.SELF_HANDLED){if(!yr.isCampaignWithinFC(e,t[n]))return this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN),!1;if(!yr.hasCampaignClearedSelfDelay(e,t[n]))return this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_MIN_DELAY),!1;if(!yr.hasCampaignClearedGlobalDelay(e,a,i))return this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_GLOBAL_DELAY),!1}return!yr.isCampaignExpired(e)||(this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_EXPIRED),!1)})}catch(e){return void $e.error(1,t,"Error filtering and sorting campaigns",e)}}catch(e){return void $e.error(1,t,"Error in filterValidCampaigns",e)}}async prioritizeMessagingCampaigns(e,t=1){if(!e||0===e.length)return;const n=await this.filterValidCampaigns(e);if(!n||0===n.length)return;const i=n.sort(yr.comparator),a=i.slice(0,t),r=i.slice(t),s=(new Date).toISOString(),o=a.map(e=>e?.campaignContext?.cid);return r.forEach(e=>{this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[{cids:o,t:s}])}),a}getCampaignTagMap(e){const t={},n=[],i={cids:[],t:(new Date).toISOString()},a=new Set;for(const n of e)n.tag&&(a.add(n.tag),t[n.tag]=t[n.tag]||[],t[n.tag].push(n));return a.forEach(e=>{const a=t[e].sort(yr.comparator);if(a.length>0){const e=a[0];n.push(e),i.cids.push(e.campaignContext.cid),a.length>1&&a.slice(1).forEach(e=>{this.deliveryStats.setStats(e,Na.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[i])})}}),n}async prioritizePersonalizationCampaigns(e){const t=await this.filterValidCampaigns(e);return t.length>0?this.getCampaignTagMap(t):[]}async getOnsitePayload(e,t){const n=this.baseLogTag+".getOnsitePayload";try{const n=await this.OnsiteApiClient.getCampaignPayload(e,t);if(n&&!n.error)return await mr.processResponse(n),n;if(n&&n.error){const t=n.reason;return void this.setDeliveryFailureStats(e,t)}return void this.deliveryStats.setStats(e,Na.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}catch(t){return $e.error(1,n,"Error getting onsite payload",t),void this.deliveryStats.setStats(e,Na.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}}setDeliveryFailureStats(e,t){t&&["PAUSED","EXPIRED","personalize"].includes(t)||this.deliveryStats.setStats(e,Na.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}async getEventForPersonalisation(e){const t=await us.getTriggeringPrimaryEvent(e.campaignId);return t?new qi(t.name,t.attributes):null}async deliverMessagingCampaign(e,t){const n=this.baseLogTag+".deliverMessagingCampaign";if(e){const i=await this.getEventForPersonalisation(e)||t;if(!await mr.campaignPriorityValidation(e,i,null,this.deliveryStats))return;try{const t=await this.getOnsitePayload(e,i);if(t){if(e.onsitePayload=t,this.isGCGCampaign(e))return;return t.payload?.code===La?($e.warn(1,n,`Can not render ${e.campaignId} as it falls under Control Group.`),void fr(e,"OSM",!0,this.OnsiteApiClient)()):yr.doCampaignPayloadHasMandatoryParams(e.onsitePayload)?e:($e.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Na.DELIVERED.CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING))}}catch(e){$e.error(1,n,"Error delivering messaging campaign",e)}}}async deliverPersonalizationCampaigns(e,t,n){const i=this.baseLogTag+".deliverPersonalizationCampaigns";if(e.length>0){const a=[];for(const t of e){await mr.campaignPriorityValidation(t,n,null,this.deliveryStats)&&a.push(t)}const r=a.map(e=>this.getOnsitePayload(e,n));try{const e=await Promise.all(r),s=a.filter((n,i)=>{if(e[i]&&e[i].payload&&(n.onsitePayload=e[i],null!=n.tag&&null!=t[n.tag])){if("JSON"!==n.onsitePayload.payloadType)return!0;if((e=>{try{JSON.parse(e)}catch(e){return!1}return!0})(n.onsitePayload.payload))return!0}return!1}),o=[];for(const e of s){if(e.onsitePayload?.frequency_data){const t=pr.getEventTypeFromEvent(n);if(!await mr.campaignImpressionValidation(e,t,this.deliveryStats)){$e.warn(1,i,`Can not render ${e.campaignId} due to frequency capping`);continue}}o.push(e)}return o}catch(e){$e.error(1,i,"Error delivering personalization campaigns",e)}}}async messagingCampaignImpression(e,t){const n=this.baseLogTag+".messagingCampaignImpression";if(e)try{const i=await this.getLastGlobalInappShown(),a=await this.getGlobalDelay(),r=this.displayManager.getActiveCampaigns();if(!yr.hasCampaignClearedGlobalDelay(e,a,i))return $e.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_GLOBAL_DELAY);if(!yr.canCampaignBeRenderedOverExisting(e,r.length))return void this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE);if(!zr.getURLFilterResult(e))return $e.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_URL_CHANGED);const s=this.displayManager.campaignRenderMap[e.campaignId];if(qs.onScrollOrExitIntentCampaigns[e.campaignId]||null!=s&&(t?.name===oe||t?.name===re))return this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN),void $e.warn(1,n,`Can not render ${e.campaignId}`);if(null!=s&&s.isActive())return this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE),void $e.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`);if(e.onsitePayload?.frequency_data){const i=pr.getEventTypeFromEvent(t);if(!await mr.campaignImpressionValidation(e,i,this.deliveryStats))return void $e.warn(1,n,`Can not render ${e.campaignId} due to frequency capping`)}return e}catch(e){return void $e.error(1,n,"Error delivering messaging campaign",e)}}async mostEligibleMessagingCampaign(e,t){if(e.length>0){this.attemptCampaigns(e);const n=await this.prioritizeMessagingCampaigns(e),i=n?.[0];let a;if(Dr(i,ae)){const e=await Cr(i);e.error?this.setDeliveryFailureStats(i,e.reason):this.isGCGCampaign(e)||(a=e)}else a=await this.deliverMessagingCampaign(i,t);const r=await this.messagingCampaignImpression(a,t);return this.deliveryStats.sendDeliveryStats(e),r}}async mostEligiblePersonalizationCampaigns(e,t,n){if(e.length>0){this.attemptCampaigns(e);const i=await this.prioritizePersonalizationCampaigns(e),a=await this.deliverPersonalizationCampaigns(i,t,n);return this.deliveryStats.sendDeliveryStats(e),a||[]}return[]}async mostEligibleSelfHandledPersonalizationCampaigns(e,t){const n=this.baseLogTag+".mostEligibleSelfHandledPersonalizationCampaigns";this.attemptCampaigns(e);const i=await this.filterValidCampaigns(e);$e.log(1,n,"Eligible campaigns with tag ",t,"are",i);const a=i.sort(yr.comparator)[0];if(a){$e.log(1,n,"Campaign with highest priority for tag",t,"is",a.campaignId);const{campaignId:e}=a,i=await this.getEventForPersonalisation(a),r=pr.getEventTypeFromEvent(i);if(!await mr.campaignPriorityValidation(a,i,r,this.deliveryStats))return;const s=await this.getOnsitePayload(a,i);if(s&&s.payload){if(await mr.processResponse(s),s.frequency_data){const t=pr.getEventTypeFromEvent(i);if(!await mr.campaignImpressionValidation(a,t,this.deliveryStats))return void $e.log(2,n,`Impression frequency capping validation failed for self-handled personalization campaign: ${e}`)}a.onsitePayload=s}}return this.deliveryStats.sendDeliveryStats(e),a}async mostEligibleSelfHandledCampaigns(e,t){const n=this.baseLogTag+".mostEligibleSelfHandledCampaigns";this.attemptCampaigns(e);const i=await this.filterValidCampaigns(e);if(0===i.length)return this.deliveryStats.sendDeliveryStats(e),[];$e.log(1,n,"Eligible self-handled campaigns are ",i);const a=await this.prioritizeMessagingCampaigns(e,xa);if(a&&a.length>0){$e.log(2,n,`Prioritized campaigns: ${a.map(e=>e.campaignId).join(", ")}`);const i=pr.getEventTypeFromEvent(t),r=await mr.getSettings();if(!r){const n=Promise.all(a.map(e=>this.getOnsitePayload(e,t))).then(async e=>e.filter(e=>e?.templateType===as.SELF_HANDLED_OSM).map((e,t)=>{const n=a[t];return new Bs({...e,...n})}));return this.deliveryStats.sendDeliveryStats(e),n}const s=await mr.getDeviceFrequencyData(),o=await ur.selfhandledPriorityValidation(a,r,i,s,(e,t)=>{this.deliveryStats.setStats(e,t)});if(0===o.length)return this.deliveryStats.sendDeliveryStats(a),[];const c=Promise.all(o.map(e=>this.getOnsitePayload(e,t))).then(async e=>{for(const t of e)t?.frequency_data&&await mr.processResponse(t);const t=await mr.getSettings();if(!t)return e.filter(e=>e?.templateType===as.SELF_HANDLED_OSM).map((e,t)=>{const n=o[t];return new Bs({...e,...n})});const r=[],s=new Map;for(let t=0;t<e.length;t++)e[t]?.templateType===as.SELF_HANDLED_OSM&&(r.push(o[t]),s.set(t,o[t]));if(0===r.length)return[];const c=await mr.getDeviceFrequencyData(),l=await ur.selfhandledImpressionValidation(r,t,i,c,(e,t)=>{this.deliveryStats.setStats(e,t)}),d=[];for(let t=0;t<e.length;t++){const n=s.get(t);n&&l.includes(n)&&d.push(new Bs({...e[t],...n}))}return $e.log(2,n,`Frequency capping validation completed. Returning ${d.length} of ${o.length} campaigns (${a.length} total)`),this.deliveryStats.sendDeliveryStats(r),d});return c.catch(()=>{this.deliveryStats.sendDeliveryStats(e)}),c}}delayDeliveryCampaignStats(e){this.deliveryStats.setStats(e,Na.IMPRESSION.CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY),this.deliveryStats.sendDeliveryStats([e])}isGCGCampaign(e){const t=this.baseLogTag+".isGCGCampaign";return e.onsitePayload.payload?.code===La&&($e.warn(1,t,`Can not render ${e.campaignId} as it falls under Control Group.`),fr(e,"OSM",!0,this.OnsiteApiClient)(),!0)}}class Hs{draftId;draftType;templateType;displaySettings;action;position;locale;variation;constructor(e){this.draftId=He(e,"draft_id",null),this.draftType=He(e,"draft_type",null),this.templateType=He(e,"template_type",null),this.action=He(e,"action",null);const t=He(e,"campaign_meta",{});this.locale=He(e,"locale",null),this.variation=He(e,"variation",null),this.displaySettings=new cs({config:t.config},this.templateType)}static isValidRawJson(e){const{draft_id:t,draft_tag:n,draft_type:i}=e;return i===ve?null!=t&&null!=n:null!=t}}const Vs=(e,t,n)=>{const i="selfHandledHelper.track";return $e.log(1,i,`Self handled OSM ${t} tracking called for campaign:`,e.campaignName),e.campaignId?(t===Pa.OSM.IMPRESSION&&(Er(e.campaignId),Or(e.campaignId).then(async t=>{const a=t?pr.getEventTypeFromCampaign(t):qa;if(!await mr.getSettings())return void $e.log(2,i,"Frequency capping not enabled, skipping update for self-handled campaign");if(n){const n=t?.delivery?.fcMeta;if(n&&He(n,"ignoreFcCount",!1))return void $e.log(2,i,`Skipping frequency capping tracking for self-handled campaign ${e.campaignId} as ignoreFcCount flag is set`)}const r={campaignId:e.campaignId,tags:t?.tags||[],delivery:t?.delivery},s=await mr.validateAndUpdateFrequencyData(r,a,n,!0);s.isValid||$e.log(2,i,`Self-handled campaign ${e.campaignId} blocked by frequency capping rule: ${s.failedRules?.join(", ")}`)}).catch(e=>{$e.error(2,i,"Failed to update frequency capping data for self-handled campaign:",e)})),Ge().track_event(t,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Pa.OSM.TYPE,...e.context})):new Promise((e,t)=>{t("Moengage error: Campaign ID not found")})};class Ws{static baseLogTag="EventTriggerHandler";selfHandledOSMCallback;async handler(e,t,n,i,a,r,s){const o=Ws.baseLogTag+".handler";$e.log(1,o,s?.name&&`Triggered for ${s.name}: `||"Campaign(s) triggered: ",r);const c=r.filter(e=>e.templateType===as.SELF_HANDLED),l=r.filter(e=>e.templateType!==as.SELF_HANDLED&&e.templateType!==as.SELF_HANDLED_OSM),d=r.filter(e=>e.templateType===as.SELF_HANDLED_OSM);if(c.length>0){const i=await e.mostEligiblePersonalizationCampaigns(c,t,s);i.length>0&&n(i)}if(l.length>0){const t=await e.mostEligibleMessagingCampaign(l,s);if(s?.timestamp&&s.timestamp<window.Moengage?.pageChangeHandlerCallingTime)return void $e.log(1,o,"Stopped triggering the campaign because handle_page_change was called: ",r);t&&i(t)}if(d.length>0&&this.selfHandledOSMCallback){const t=await e.mostEligibleSelfHandledCampaigns(d,s);t.length>0&&(t.forEach(e=>{Vs(e,Pa.OSM.DELIVERED,a)}),this.selfHandledOSMCallback(t))}}}class Gs{baseLogTag;OnsiteApiClient;batchId;constructor(e){this.baseLogTag="DeliveryStats",this.OnsiteApiClient=new ds(e),this.batchId=vn()}async sendDeliveryStats(e){const t=this.baseLogTag+".sendDeliveryStats";if(!window.navigator.onLine)return $e.error(1,t,"No internet connection. Delivery stats will not be sent"),void gs.setOnlineEventListner(()=>{this.sendDeliveryStats(e)});if(e.length>0)try{const t={};e.forEach(e=>{t[e.campaignContext.cid]||(t[e.campaignContext.cid]=e.stats,e.stats={})});const n={stats:t};this.OnsiteApiClient.callStatsAPI(n,this.batchId)}catch(e){$e.error(1,t,"Error in sending delivery funnel stats",e)}}setStats(e,t,n){const i=(new Date).toISOString();e&&(e.stats[t]=e.stats[t]||[],n?e.stats[t]=n:e.stats[t].some(e=>e.t===i)||e.stats[t].push({t:i}))}}const Ks=new Gn;class qs{static baseLogTag="MoeOnsite";initData;initializationPomise=null;OnsiteApiClient;testDraftInfo=null;triggerManager=null;displayManager=null;selfHandledWebpTriggerListeners={};funnelManager=null;eventTriggerHandler=null;deliveryStats=null;static identityListenerAdded=!1;static onScrollOrExitIntentCampaigns={};static handleSDKEnableAndDisableLisetner=!1;constructor(e){this.initData=e,$e.setLogLevel(e.debugLevel),this.OnsiteApiClient=new ds(this.initData),qs.handleSDKEnableAndDisableLisetner||(window.addEventListener(C.TOPIC_NAME,async e=>{const t=e?.detail?.name;t===C.EVENT_NAMES.SDK_ENABLED?await To.enableOSM():t===C.EVENT_NAMES.SDK_DISABLED&&await To.disableOSM(!1,!0)}),qs.handleSDKEnableAndDisableLisetner=!0)}setLogLevel(e){$e.setLogLevel(e,!1)}async isTestCampaignAvailable(){const e=qs.baseLogTag+".isTestCampaignAvailable";window.opener?(window.addEventListener("message",async t=>{if(t.data&&"inapp_test"===t.data.action){const n=t.data;if(Hs.isValidRawJson(n)){const t=new Hs(n);$e.log(1,e,"Valid test campaign data found checking TestCampaign",n),await this.checkForTestCampaign(t)}else $e.error(1,e,"Data is not a valid test campaign",n);Ks.res()}},!1),window.opener.postMessage("moe_test_osm","*"),setTimeout(async()=>{Ks.res()},100)):Ks.res()}initialize(){const e=qs.baseLogTag+".initialize";return $e.log(1,e,"Initialising onsite module"),null==this.initializationPomise&&Ei()&&(this.initializationPomise=new Promise(async t=>{try{await sr.initialize(),await ur.validateAndTrackSession(),await this.isTestCampaignAvailable(),Ks.p.then(async()=>{await this.syncCampaigns();const n=await Pr(),i=this.isExitIntentCampaignFound(n);i.length&&await this.prefetchExitIntentCampaigns(i);const a=n.filter(e=>null!=e.triggerData);if(this.displayManager=new xs(this.OnsiteApiClient),this.displayManager.onRender(t=>{$e.log(1,e,`Campaign rendered: ${t.campaignId}`),sr.serviceMetaStore.setItem(Oa.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME,new Date)}),null!=this.testDraftInfo&&this.testDraftInfo.draftType===ye){$e.log(1,e,"Test campaigns present, will be showing only the test campaign."),$e.log(1,e,"No live campaign will be shown till draft campaign showing");try{$e.log(1,e,`Trying to render draft campaign with id ${this.testDraftInfo.draftId}`);const t=await this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);$e.log(1,e,"Test campaign payload: ",t),t&&this.displayManager.queueDraftCampaign(this.testDraftInfo,t),this.testDraftInfo=null}catch(t){$e.error(1,e,`Error fetching data for test campaign ${this.testDraftInfo.draftId}: `,t)}}else{this.initData?.enableSPA&&this.handleSPA(),qs.attachIdentityUpdateHandler(),this.deliveryStats=new Gs(this.initData),this.triggerManager=new hs(a),this.funnelManager=new Fs(this.initData,this.displayManager,this.deliveryStats),this.eventTriggerHandler=new Ws;const e=this.eventTriggerHandler.handler.bind(this.eventTriggerHandler,this.funnelManager,this.selfHandledWebpTriggerListeners,this.handlePersonalizationCampaigns.bind(this),this.handleMessagingCampaigns.bind(this),this.OnsiteApiClient);this.triggerManager.onTrigger(e),ps.setListener(e),ms.setDeliveryStats(this.deliveryStats),ps.setDeliveryStats(this.deliveryStats),await ps.logDeliveryFunnelForExpiredTimerCampaigns(),await ms.updateCampaignTimeInSecondaryEventsStore(),await ps.createNewTimers(),this.triggerManager.startWatching()}Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.OSM_INIT}),t(!0)})}catch(t){$e.error(1,e,t)}})),this.initializationPomise}async handleMessagingCampaigns(e){const t=`${qs.baseLogTag}.handleMessagingCampaigns`;e.onsitePayload&&this.displayManager&&($e.log(1,t,`Campaign triggered: ${e.campaignId}`),$e.log(1,t,"Payload for campaign:",e.onsitePayload),this.displayManager.queueLiveCampaign(e,e.onsitePayload))}async handlePersonalizationCampaigns(e){const t=`${qs.baseLogTag}.handlePersonalizationCampaigns`;e.length>0&&e.forEach(e=>{null!=e.tag&&($e.log(1,t,`Personlization Campaign triggered: ${e.campaignId}`),this.selfHandledWebpTriggerListeners[e.tag].forEach(t=>{this.handleSelfHandledCallback(e,e.onsitePayload,t)}))})}async logout(e=!1,t=!1){const n=`${qs.baseLogTag}.logout`;if($e.log(1,n,"Starting module logout"),this.initData?.enableSPA&&this.removeHandlePageChange(),this.initializationPomise=null,this.displayManager){Ar(this.displayManager);const e=Object.keys(this.displayManager?.campaignRenderMap);this.displayManager.testCampaign?.draftId&&e.push(this.displayManager.testCampaign?.draftId),e.forEach(e=>{const t=document.getElementById(`moe-onsite-campaign-${e}`);t&&t.remove()}),this.displayManager.destroy()}this.triggerManager&&(Ir(this.triggerManager),wr(this.triggerManager),this.triggerManager.destroy()),$i.clear(),ms.destroy(),ps.destroy(),e&&(qs.onScrollOrExitIntentCampaigns={}),this.displayManager=null,this.funnelManager=null,this.eventTriggerHandler=null,await ps.deleteAllPendingTimers(),t?sr.sdkOptOut():(await sr.serviceMetaStore.removeItem(Oa.SERVICE_META.KEYS.LAST_META_CALL_TIME),await sr.clear(e)),$e.log(1,n,"Starting module logout complete")}async checkForTestCampaign(e){const t=qs.baseLogTag+".checkForTestCampaign";try{const n=e;null==n?($e.log(1,t,"No draft campaign found"),this.testDraftInfo=null):($e.log(1,t,"Found draft campaign: ",n),this.testDraftInfo=n,null==this.testDraftInfo.draftId&&(this.testDraftInfo.draftType=ve))}catch(e){$e.error(1,t,"Error getting test campaign",e)}}async getData(e,t){const n=`${qs.baseLogTag}.getData`;null==t&&($e.warn(1,n,"Moengage.onsite.getData called without a providing a callback."),t=()=>{});try{if(await this.initializationPomise,null!=this.testDraftInfo){if($e.log(1,n,"Fetching test campaign: ",this.testDraftInfo),this.testDraftInfo.draftType===ve){const e=await this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);this.testDraftInfo=null,t(null,{payload:e.payload,click:()=>{$e.log(1,n,"This is a test campaign")},imp:()=>{$e.log(1,n,"This is a test campaign")}})}}else{const i=await sr.campaingsTagsStore.getItem(e);if(i){const a=(await Promise.all(i.map(e=>Or(e)))).filter(e=>null==e.triggerData),r=await this.funnelManager.mostEligibleSelfHandledPersonalizationCampaigns(a,e);r&&r.onsitePayload?this.handleSelfHandledCallback(r,r.onsitePayload,t):($e.error(1,n,"Error fetching campaign payload"),t({message:"There was an error fetching data for this tag"},null))}else $e.warn(1,n,"Could not find any eligible campaign for tag",e),t({message:"Could not find any eligible campaign for tag "+e},null)}}catch(e){$e.error(1,n,"Error getting campaign",e)}}async registerCallback(e,t){const n=`${qs.baseLogTag}.registerCallback`;try{await this.initializationPomise,null==this.selfHandledWebpTriggerListeners[e]?this.selfHandledWebpTriggerListeners[e]=[t]:this.selfHandledWebpTriggerListeners[e].push(t)}catch(t){$e.error(1,n,"Error setting callback for tag",e),$e.error(1,n,"Error stack:",t)}}async handleSelfHandledCallback(e,t,n){const i=`${qs.baseLogTag}.handleSelfHandledCallback`;if(e.campaignContext=t.campaignContext,"JSON"===t.payloadType)try{t.payload=JSON.parse(t.payload);const i=He(e,"triggerData.trigger_delay.delayInSeconds",0)||0;setTimeout(()=>{_r(e,"WP"),n(null,{payload:t.payload,click:t=>{hr(e,"WP",t)()},imp:fr(e,"WP",!1,this.OnsiteApiClient)})},1e3*i)}catch(a){const r=`Payload for campaign_id ${e.campaignId} is not a valid JSON`;$e.error(1,i,r),$e.error(1,i,"Payload provided:",t.payload),n({message:r},null)}else _r(e,"WP"),n(null,{payload:t.payload,click:t=>{hr(e,"WP",t)()},imp:fr(e,"WP",!1,this.OnsiteApiClient)})}async syncCampaigns(){const e=qs.baseLogTag+".syncCampaigns";try{await this.shouldClearMetaStorage()&&(await sr.campaingsMetaStore.clear(),await this.rebuildTagStore()),await this.shouldSaveRemoteCampaigns()&&await this.saveRemoteCampaigns()}catch(t){$e.error(1,e,"Error getting remote campaigns: ",t)}}async shouldClearMetaStorage(){return await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION)!==Ge().getSdkVersion()}async shouldSaveRemoteCampaigns(){const e=qs.baseLogTag+".shouldSaveRemoteCampaigns",t=await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION);let n=await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.LAST_META_CALL_TIME);n=new Date(n);const i=(new Date).getTime();if(null==n||i-n>Ra)return!0;if($e.remoteLogTracking(1,"info",e,"Last fetch was less than 15 mins ago at ",n),t!==Ge().getSdkVersion())return $e.remoteLogTracking(1,"info",e,"Version change detected. Will proceed to fetch latest campaigns"),!0;const a=await sr.serviceMetaStore.getItem(Oa.SERVICE_META.KEYS.UNIQUE_ID);if(a){const t=gn.get(be.USER_DATA)?.deviceUuid;if(a!==t)return $e.remoteLogTracking(1,"info",e,"Unique device id change detected. Will proceed to fetch latest campaigns"),!0}return!1}async saveRemoteCampaigns(){const e=qs.baseLogTag+".saveRemoteCampaigns";await sr.campaingsMetaStore.clear(),await sr.exitIntentCampaignStore.clear();const t=await this.OnsiteApiClient.getCampaignsMeta();null!=t&&(await this.addCampaignsToDB(t.campaignsMeta),$e.log(1,e,"Inapp campaigns meta saved!")),await ms.pruneRemovedCampaigns(),await ms.removeStaleTriggeringPrimaryEventCampaigns(),await sr.serviceMetaStore.setItem(Oa.SERVICE_META.KEYS.GLOBAL_DELAY,t.globalDelayBetweenInapps),await sr.serviceMetaStore.setItem(Oa.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION,Ge().getSdkVersion())}async addCampaignsToDB(e){const t=qs.baseLogTag+".addCampaignsToDB";$e.log(1,t,`Adding/Updating ${e.length} campaigns in DB`,e.map(e=>e.campaignId));try{await Promise.all(e.map(e=>sr.campaingsMetaStore.setItem(e.campaignId,e))),await this.rebuildTagStore()}catch(e){$e.error(1,t,"Error saving remote campaigns:",e)}}async rebuildTagStore(){const e=qs.baseLogTag+".rebuildTagStore";try{await sr.campaingsTagsStore.clear();const e=await Pr(),t={};for(const n of e)null!=n.tag&&(null==t[n.tag]&&(t[n.tag]=[]),t[n.tag].push(n.campaignId));const n=[];await sr.campaingsTagsStore.clear();for(const e in t)t.hasOwnProperty(e)&&n.push(sr.campaingsTagsStore.setItem(e,t[e]));await Promise.all(n)}catch(t){$e.error(1,e,"Error updating tags store:",t)}}isExitIntentCampaignFound(e){return e.filter(e=>e.templateType!==as.SELF_HANDLED&&Dr(e,ae))}async prefetchExitIntentCampaigns(e){const t=qs.baseLogTag+".prefetchExitIntentCampaigns",n=await qi.createEvent(oe,[]),i=(await Tr(e)).filter(e=>zr.getFilterResult(n,e));if(i&&i.length){const e=await Cr(i[0]);if(e&&e.onsitePayload&&e.onsitePayload.updatedTime.getTime()===i[0].updatedTime.getTime())return;const{campaignId:n}=i[0];if(!await mr.campaignPriorityValidation(i[0],null,za,this.deliveryStats))return;const a=await this.OnsiteApiClient.getCampaignPayload(i[0]);return void(a.payload||a.htmlJsonPayload?(await mr.processResponse(a),a.updatedTime=i[0].updatedTime,await sr.exitIntentCampaignStore.setItem(n,a),$e.log(1,t,`Exit intent campaign prefetched: ${n}`)):a.error&&a.reason&&await sr.exitIntentCampaignStore.setItem(n,a))}return $e.log(1,t,"Exit intent campaign not eligible to prefetch"),!1}static handleDisableModule(e){Ti.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_OSM",data:{isUserLogout:e}})}async sendDelayCampaignStats(e,t){const n=qs.baseLogTag+".sendDelayCampaignStats";if(!e)return;const i=Object.keys(e.campaignRenderMap).filter(t=>!e.campaignRenderMap[t].campaignRendered);i.length>0&&($e.log(1,n,"Campaigns found:",i),t.delayDeliveryCampaignStats(e.campaignRenderMap[i[0]].campaignMeta))}handleSPA(){const e=qs.baseLogTag+".handleSPA";$e.log(2,e,"Adding SPA event listener for OSM"),window.addEventListener(N.TOPIC_NAME,Mr,{once:!0})}removeHandlePageChange(){const e=qs.baseLogTag+".removeHandlePageChange";$e.log(2,e,"Removing SPA event listener for OSM"),window.removeEventListener(N.TOPIC_NAME,Mr)}static async identityUpdateHandler(e){const t=`${qs.baseLogTag}.identityUpdateHandler`;if($e.log(2,t,`Received event: ${e.detail.name}`),e.detail.name===P.EVENT_NAMES.USER_IDENTITY_UPDATE){const e=(e=>{if(!e)return[];try{return e.getActiveCampaigns().map(e=>e.campaignMeta.campaignId)}catch(e){return $e.error(2,"getAllActiveCampaign","Error getting active campaigns:",e),[]}})(window?.Moengage?.onsite.displayManager);e&&e.length>0?(await sr.serviceMetaStore.removeItem(Oa.SERVICE_META.KEYS.LAST_META_CALL_TIME),(e=>{const t="handleLoginOnDismiss";if(!e||0===e.length)return;const n=new Set(e),i="OSM_INTERNAL_EVENT",a=r=>{try{const{detail:{name:s,data:o}}=r;if("DISMISS"===s&&o&&e.includes(o)){const e=r.detail?.data;e&&n.has(e)&&(n.delete(e),$e.log(2,t,`Campaign ${e} dismissed. Remaining: ${n.size}`),0===n.size&&($e.log(2,t,"All campaigns dismissed, broadcasting module action"),window.removeEventListener(i,a),Ti.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"})))}}catch(e){$e.error(2,t,"Error handling dismiss event:",e)}};window.addEventListener(i,a)})(e),window.addEventListener(P.TOPIC_NAME,qs.identityUpdateHandler)):Ti.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"})}else e.detail.name===P.EVENT_NAMES.LOGOUT&&(removeEventListener(P.TOPIC_NAME,qs.identityUpdateHandler),qs.identityListenerAdded=!1,qs.handleDisableModule(!0))}static attachIdentityUpdateHandler(){qs.identityListenerAdded||(window.addEventListener(P.TOPIC_NAME,qs.identityUpdateHandler),qs.identityListenerAdded=!0)}getSelfHandledOSM(e){const t=qs.baseLogTag+".getSelfHandledOSM";e&&"function"==typeof e?($e.log(1,t,"Self handled OSM callback requested"),this.initializationPomise.then(()=>{this.eventTriggerHandler?this.eventTriggerHandler.selfHandledOSMCallback=e:$e.warn(1,t,"OSM module not initialised properly for self handled OSM to work; or it is in test campaign mode.")}).catch(n=>{$e.error(1,t,"Error during initialization:",n),e(n,null)})):$e.error(1,t,"Self handled OSM callback is not a function.")}selfHandledShown(e){return Vs(e,Pa.OSM.IMPRESSION,this.OnsiteApiClient)}selfHandledClicked(e){return Vs(e,Pa.OSM.CLICK,this.OnsiteApiClient)}selfHandledDismissed(e){return Vs(e,Pa.OSM.DISMISS,this.OnsiteApiClient)}}window[Ma]=qs,window.MoeOsm=Ts();const $s={code:1e3,reason:"Web push not supported in current browser environment"},Ys={code:1001,reason:"Registering the service worker failed"},js={code:1002,reason:"Web push settings not configured"},zs={code:1004,reason:"Hard ask was dismissed to many times"},Js={code:1005,reason:"Service worker can not be registered on this page due to scope issues"},Qs="default",Xs="prompt",Zs="denied",eo="IOS_PERMISSION_DENIED",to="https://media.giphy.com/media/90F8aUepslB84/giphy.gif",no="https://media.giphy.com/media/KDRv3QggAjyo/giphy.gif";class io{static callbacks={};static addCallback(e,t){null!=e&&null!=t&&(null==io.callbacks[e]&&(io.callbacks[e]=[]),io.callbacks[e].push(t))}static getCallbacks(e){return io.callbacks[e]||[]}static runCallbacks(e){io.getCallbacks(e).forEach(e=>{e()})}}function ao(){const e=document.getElementById("moe-push-div");null!=e&&(e.style.visibility="none",e.style.opacity="0",e.parentNode.removeChild(e))}class ro{static baseLogTag="HTTPS-NotificationManager";sdkSettings;swRegisterPromise=null;static registeredServiceWorker;overlayTimer;swActiveRetries=1;constructor(e){const t=ro.baseLogTag+".constructor";this.sdkSettings=e,this.registerServiceWorker().then(e=>{this.sendDataToServiceWorker()}).catch(e=>{$e.error(1,t,"Error registering serviceworker:",e)})}showHardAsk(){const e=ro.baseLogTag+".showHardAsk";return new Promise((t,n)=>{ro.isWebPushSupported().then(i=>{i?this.getCurrentPermissionState().then(i=>{Ei()&&this.registerServiceWorker().then(a=>{i!==ji.DENIED?($e.remoteLogTracking(1,"info",e,"Attempting to open hard ask"),Ge()?.track_event(Z),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.HARD_ASK_ATTEMPTED}),this.showOverlay(),Ei()&&this.askPermission().then(n=>{Ei()&&(this.hideOverlay(),$e.remoteLogTracking(2,"info",e,"Permission state after hard ask:",n),n===ji.GRANTED?this.getPushTokenDetails().then(e=>{this.sendDataToServiceWorker(e.token),t({state:n,subscriptionDetails:e})}):(this.sendDataToServiceWorker(),t({state:n,subscriptionDetails:null})))}).catch(t=>{$e.error(1,e,t),n(Ys)})):($e.remoteLogTracking(1,"info",e,"Hard ask not shown as permission state is",i),t({state:i,subscriptionDetails:null}))}).catch(t=>{$e.error(1,e,"Error registering serviceworker:",t),n(t)})}).catch(t=>{$e.error(1,e,"Registering service worker failed:",t),n(Ys)}):($e.warn(1,e,"Web push not supported in current browser environment"),n($s))})})}sendDataToServiceWorker(e){return new Promise(n=>{zi.collectGetParams().then(n=>{const i=je.get();if(e&&(n.push_id=e||ni()||void 0),n.isWebPushEnabled=this.sdkSettings.isWebPushEnabled&&!i.disableWebPush,n.isBatchingEnabled=gn.get(be.WEB_SETTINGS).configs.isBatchingEnabled,i.proxyDomains?.api&&(n.proxyDomains=i.proxyDomains),$n()||i.swScope){t().createInstance({driver:[t().INDEXEDDB],name:"moe_database",storeName:"moe_data"}).setItem("reportParams",{data:n})}else navigator.serviceWorker.ready.then(()=>{this.sendDataToServiceWorkerOnControllerReady(n)})})})}sendDataToServiceWorkerOnControllerReady(e){if(navigator.serviceWorker.controller){if("chrome-extension:"===window.location.protocol)return void chrome.runtime.sendMessage({data:e});navigator.serviceWorker.controller.postMessage({data:e})}else this.swActiveRetries<3&&setTimeout(()=>{this.swActiveRetries++,this.sendDataToServiceWorkerOnControllerReady(e)},500)}getCurrentPermissionState(){return Qn.getInstance().then(e=>navigator.permissions&&!e.isSafari()?navigator.permissions.query({name:"notifications"}).then(e=>ro.parsePermissionState(e.state)).catch(e=>{}):new Promise(t=>{let n=window.Notification?.permission;e.isSafari()&&n===Qs&&(n=Xs,gn.get(eo)&&(n=Zs)),t(ro.parsePermissionState(n))}))}getPushTokenDetails(){const e=ro.baseLogTag+".getPushTokenDetails";return new Promise((t,n)=>{this.getCurrentPermissionState().then(n=>{Qn.getInstance().then(i=>{n!==ji.GRANTED?t({token:null,raw:null}):this.registerServiceWorker().then(n=>{let a=null;const r={userVisibleOnly:!0};qn(this.sdkSettings.webPushPlatformData,i)&&(a=Yn(this.sdkSettings.webPushPlatformData,i),r.applicationServerKey=di(a));const s=()=>{n.pushManager.subscribe(r).then(e=>{(e=>{const n=e.toJSON(),a=e.endpoint.substring(0,n.endpoint.lastIndexOf("/")+1),r=n.expirationTime;let s=n.endpoint.split("/")[n.endpoint.split("/").length-1];i.isEdge()&&(s=s.replace("?token=",""));const o={};if(n.keys)for(const e in n.keys)n.keys.hasOwnProperty(e)&&(o[e]=n.keys[e]);t({token:s,endpoint:a,keys:o,expirationTime:r,raw:n})})(e)}).catch(n=>{$e.error(1,e,"Error in subscribtion: ",n),t({token:null,raw:null})})};n.pushManager.getSubscription().then(e=>{if(e)if("vapid"===this.sdkSettings.webPushPlatformData.chrome.subscriptionMode&&e.options&&e.options.applicationServerKey){const t=gi(e.options.applicationServerKey);[a,a+"=",a+"==",gi(di(a))].indexOf(t)<0?e.unsubscribe().then(()=>{s()}):s()}else s();else s()})}).catch(n=>{$e.error(1,e,"Error in getting push token: ",n),t({token:null,raw:null})})})})})}removeToken(){return gn.remove(be.PUSH_TOKEN),gn.remove(be.OPTED_STATUS_TRACK_TIME),gn.remove(be.SUBSCRIPTION_DETAILS),Promise.resolve()}trackHardAskShownEvents(){gn.set(be.OPT_IN_SHOWN_TIME,Date.now()),Ge()?.track_event(z),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.HARD_ASK_SHOWN}),io.runCallbacks(O.EVENT_NAMES.HARD_ASK_SHOWN),Ti.deprecatedSdkCallback("opt_in_shown")}askPermission(){return new Promise((e,t)=>{this.trackHardAskShownEvents(),window.Notification?.requestPermission().then(t=>{e(ro.parsePermissionState(t))}).catch(e=>{t(zs)})})}registerServiceWorker(){const e=ro.baseLogTag+".registerServiceWorker";return"chrome-extension:"===window.location.protocol?navigator.serviceWorker.ready:(null!=this.swRegisterPromise||(this.swRegisterPromise=new Promise((t,n)=>{if(ro.registeredServiceWorker)t(ro.registeredServiceWorker);else if("serviceWorker"in navigator){let i="serviceworker.js",a=!1;if(je.get()&&null!=je.get().swPath&&(i=je.get().swPath,a=!0),"/"===i[0]||i.startsWith("http")||(i="/"+i),$n())$e.log(1,e,"Removing scope in case of shopify."),this.registerScopedSW(i,/moengage/,t,n);else{let r="/";je.get()&&null!=je.get().swScope?(r=je.get().swScope,this.registerScopedSW(i,r,t,n)):(a&&($e.log(1,e,"Using user defined path to serviceworker:",i),r=i.substr(0,i.lastIndexOf("/")+1),ro.canSwBeRegisteredWithScope(r)||($e.error(1,e,"Service worker can only be registered from same directory or child directory."),n(Js))),navigator.serviceWorker.register(i,{scope:r}).then(i=>{$e.log(2,e,"Serviceworker registered"),navigator.serviceWorker.ready.then(n=>{$e.log(2,e,"Serviceworker ready"),ro.registeredServiceWorker=n,je.get()&&je.get().forceSwUpdate&&n.update(),t(n)}).catch(t=>{$e.error(1,e,"Service worker register failed:",t),n(Ys)})}).catch(t=>{$e.error(1,e,"Service worker register failed:",t),n(Ys)})),$e.log(1,e,"Scope for serviceworker:",r)}}else $e.error(1,e,"Service worker not supported"),n("Service worker not supported")})),this.swRegisterPromise)}registerScopedSW(e,t,n,i){const a=ro.baseLogTag+".registerScopedSW";navigator.serviceWorker.register(e).then(e=>{$e.log(2,a,"Serviceworker registered"),navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{setTimeout(()=>{e.active&&e.active.scriptURL.match(t)&&($e.log(2,a,"Serviceworker ready"),ro.registeredServiceWorker=e,je.get()&&je.get().forceSwUpdate&&e.update(),n(e))},100)})}).catch(e=>{$e.error(1,a,"Service worker register failed:",e),i(Ys)})}).catch(e=>{$e.error(1,a,"Service worker register failed:",e),i(Ys)})}static canSwBeRegisteredWithScope(e){const t=window.location.pathname;return n=e,!((i=t).indexOf(n)<0)&&i.substring(i.indexOf(n)).length>=0;var n,i}static isWebPushSupported(){return new Promise(e=>{Qn.getInstance().then(t=>{t.isIncognito?e(!1):"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&t.isWebPushCompatible()?e(!0):e(!1)})})}static parsePermissionState(e){return"prompt"===e?ji.PROMPT:"granted"===e?ji.GRANTED:"denied"===e?ji.DENIED:"default"===e?ji.DISMISSED:null}showNotification(e){const t=ro.baseLogTag+".showNotification";this.registerServiceWorker().then(n=>{e?e.title?e.body?(null==e.requireInteraction&&(e.requireInteraction=!0),n.showNotification(e.title,e)):$e.error(1,t,"Notification body can not be blank"):$e.error(1,t,"Notification title can not be blank"):$e.error(1,t,"Notification object can not be blank")}).catch(e=>{$e.error(1,t,"Error registering serviceworker:",e)})}showOverlay(){if(this.sdkSettings.toShowOverlay&&this.sdkSettings.optInType===oa.ONE_STEP){const e=document.createElement("div");e.id="moe-push-div",e.style.display="none",e.className="moe-push-class",Qn.getInstance().then(async t=>{t.isMobile?e.innerHTML=(await ai(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).mobileUI:e.innerHTML=(await ai(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).webUI;const n=document.body.firstChild;n.parentNode.insertBefore(e,n);const i=t.name;let a;if(i===Qn.BROWSER_NAMES.CHROME||i===Qn.BROWSER_NAMES.OPERA_NEON?a=document.getElementsByClassName("moe_chrome"):i===Qn.BROWSER_NAMES.FIREFOX?a=document.getElementsByClassName("moe_firefox"):(i===Qn.BROWSER_NAMES.OPERA||i===Qn.BROWSER_NAMES.SAFARI)&&(a=document.getElementsByClassName("moe_opera")),0===a.length)document.getElementById("moe-push-div").style.display="none";else for(let e=a.length-1;e>=0;e--)a[e].style.display="block";this.overlayTimer=window.setTimeout(()=>{""===e.style.opacity&&(e.style.display="block")},1500),e.onclick=()=>{this.hideOverlay()}})}}hideOverlay(){clearTimeout(this.overlayTimer),ao()}}const so="Web push settings not configured on MoEngage dashboard: "+ue;class oo{static baseLogTag="NotificationManager";config;browser;currentManager=null;constructor(e,t){const n=oo.baseLogTag+".constructor";this.config=e,this.browser=t,this.browser.isWebPushCompatible()?e.webPushPlatformData.chrome&&(e.isWebPushEnabled?"https"===function(){if(window){if("localhost"===window.location.hostname)return"https";if("http:"===window.location.protocol)return"http";if("https:"===window.location.protocol)return"https";if("chrome-extension:"===window.location.protocol)return"https"}}()?this.currentManager=new ro(e):$e.error(1,n,"Web Push does not work in http mode"):($n()&&new ro(e),$e.warn(1,n,"Web push settings not configured. Please configure at ",ue))):this.browser.name===Qn.BROWSER_NAMES.SAFARI&&"safari"in window&&"pushNotification"in window.safari&&(this.currentManager=null,$e.warn(1,n,"Web push is only supported on Safari 16 and above."))}showHardAsk(){const e=oo.baseLogTag+".showHardAsk";return new Promise((t,n)=>{this.getCurrentPermissionState().then(i=>{null!=this.currentManager?i===ji.PROMPT?this.currentManager.showHardAsk().then(n=>{n.state===ji.DISMISSED?(Ge()?.track_event(Q),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.HARD_ASK_DISMISSED}),Ti.deprecatedSdkCallback("opt_in_dismissed"),io.runCallbacks(O.EVENT_NAMES.HARD_ASK_DISMISSED),$e.log(1,e,"Hard ask was dismissed")):n.state===ji.GRANTED?(Ge()?.track_event(J),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.HARD_ASK_ALLOWED,data:n.subscriptionDetails}),Ti.deprecatedSdkCallback("opt_in_allowed"),io.runCallbacks(O.EVENT_NAMES.HARD_ASK_ALLOWED),$e.log(1,e,"Push permission was granted"),$e.customLabel(1,e,"token",n.subscriptionDetails.token)):n.state===ji.DENIED&&(Ge()?.track_event(X),Ge()?.track_event("Web Push Opt-in Denied"),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.HARD_ASK_DENIED}),Ti.deprecatedSdkCallback("opt_in_blocked"),io.runCallbacks(O.EVENT_NAMES.HARD_ASK_DENIED),$e.log(1,e,"Notification permission was denied")),t(n)}).catch(n=>{$e.error(1,e,"Error showing hard ask:",n),t({state:i,subscriptionDetails:null})}):($e.log(1,e,"Not showing Hard Ask as current permission state is",i),this.getPushTokenDetails().then(n=>{$e.customLabel(1,e,"token",n.token),t({state:i,subscriptionDetails:n})}).catch(n=>{$e.warn(1,e,"Could not get push token details"),t({state:i,subscriptionDetails:null})})):($e.log(1,e,"MoEngage web push settings not configured. Please configure at",ue),n(js))}).catch(e=>{n(e)})})}getCurrentPermissionState(){return null!=this.currentManager?this.currentManager.getCurrentPermissionState():Promise.reject(so)}getPushTokenDetails(){return null!=this.currentManager?this.currentManager.getPushTokenDetails():Promise.reject(so)}removeToken(){return null!=this.currentManager?this.currentManager.removeToken():Promise.reject(so)}showNotification(e){const t=oo.baseLogTag+".showNotification";if(null!=this.currentManager)return this.currentManager.showNotification(e);$e.warn(1,t,so)}}class co{static baseLogTag="SoftAskManager";config;moeDiv;mainDivs=[];constructor(e){this.config=e}showSoftAsk(){const e=co.baseLogTag+".showSoftAsk";return new Promise((t,n)=>{let i=this.config.loadTime;Qn.getInstance().then(n=>{(this.config.optInType===oa.SELF_HANDLED||n.isSafari()&&this.config.optInType===oa.ONE_STEP)&&(i=0),i&&$e.log(1,e,"Delay of",i," second(s) requested before opt-in flow"),setTimeout(()=>{if(!n.isWebPushCompatible()||this.config.optInType!==oa.TWO_STEP&&this.config.optInType!==oa.SELF_HANDLED)gn.set(be.SOFT_ASK_STATUS,lo.NOT_SHOWN),t({showHardAsk:!0,softAskState:lo.NOT_SHOWN});else{const n=()=>{$e.log(1,e,"Soft ask was shown"),Ge()?.track_event($),gn.set(be.OPT_IN_SHOWN_TIME,Date.now()),gn.set(be.SOFT_ASK_STATUS,lo.SHOWN),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.SOFT_ASK_SHOWN}),Ti.deprecatedSdkCallback("soft_ask_shown"),io.runCallbacks(O.EVENT_NAMES.SOFT_ASK_SHOWN)},i=()=>{Ge()?.track_event(j),this.hideOptIn(),Os(),$e.log(1,e,"Soft ask was allowed"),gn.set(be.SOFT_ASK_STATUS,lo.ALLOWED),t({showHardAsk:!0,softAskState:lo.ALLOWED}),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.SOFT_ASK_ALLOWED}),Ti.deprecatedSdkCallback("soft_ask_allowed"),io.runCallbacks(O.EVENT_NAMES.SOFT_ASK_ALLOWED)},a=()=>{this.hideOptIn(),Os(),Ge()?.track_event(Y),$e.log(1,e,"Soft ask was dismissed"),gn.set(be.SOFT_ASK_STATUS,lo.DISMISSED),t({showHardAsk:!1,softAskState:lo.DISMISSED}),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:O.EVENT_NAMES.SOFT_ASK_DISMISSED}),Ti.deprecatedSdkCallback("soft_ask_closed"),io.runCallbacks(O.EVENT_NAMES.SOFT_ASK_DISMISSED)},r=e=>{e=!!e,this.hideOptIn(),t({showHardAsk:e,softAskState:lo.NOT_SHOWN})};this.showOptIn(n,i,a,r)}},1e3*i)})})}showOptIn(e,t,n,i){const a=co.baseLogTag+".showOptIn";if(this.config.optInType===oa.TWO_STEP){let r=document.getElementById("moe-push-div");null==r&&(r=document.createElement("div"),r.id="moe-push-div",r.className="moe-push-class"),Qn.getInstance().then(s=>{let o=null;if(o=s.isMobile?ii(this.config.optInPreview,this.config.isBrandingHidden).mobileUI:ii(this.config.optInPreview,this.config.isBrandingHidden).webUI,null!=o){r.innerHTML=o;const s=document.body.firstChild;s?.parentNode.insertBefore(r,s),this.moeDiv=r;const c=r.firstElementChild;c&&(c.tabIndex=0,c.setAttribute("role","alert"),c.setAttribute("aria-live","polite"),Ns(r.firstElementChild));const l=document.getElementById("optInText")||document.getElementById("optInTextConventional"),d=document.getElementById("moe-dontallow_button");null==l?($e.error(1,a,"Error showing soft ask. Allow button id is missing"),i()):(e(),l.onclick=()=>{t()},d?d.onclick=()=>{n()}:window.moeRemoveBanner=()=>{n()})}else $e.error(1,a,"Error displaying soft ask"),i()})}else if(this.config.optInType===oa.SELF_HANDLED){const r=je.get();if(r.customSoftAsk){const s=document.getElementsByClassName(r.customSoftAsk.mainClass),o=document.getElementsByClassName(r.customSoftAsk.allowClass),c=document.getElementsByClassName(r.customSoftAsk.dismissClass);if(s.length<1)$e.error(1,a,"Could not find main class for the soft ask. Class name given:",r.customSoftAsk.mainClass),Qn.getInstance().then(e=>{e.isWebPushCompatible()&&($e.warn(1,a,"Proceeding to hard ask directly"),i(!0))});else{e(),o.length<1&&($e.warn(1,a,"Could not find any element for allow button. Class name given:",r.customSoftAsk.allowClass),$e.warn(1,a,"Docs for self-handled opt in available here - ",ge.SELF_HANDLED_DOCS)),c.length<1&&$e.warn(1,a,"Could not find any element for dismiss button. Class name given:",r.customSoftAsk.dismissClass);for(let e=s.length-1;e>=0;e--){const t=s[e];this.mainDivs.push(t),t.style.display="block",Ns(t)}for(let e=o.length-1;e>=0;e--){o[e].onclick=()=>{t()}}for(let e=c.length-1;e>=0;e--){c[e].onclick=()=>{n()}}}}else Qn.getInstance().then(e=>{e.isWebPushCompatible()?($e.warn(1,a,"No soft ask configured. Proceeding to hard ask directly. \n\nYou can ignore this message if you do not want any soft ask."),i(!0)):($e.error(1,a,"Soft ask needs to be present in case of http implementation. Can not show hard ask otherwise."),i())})}}hideOptIn(){null!=this.moeDiv&&(this.moeDiv.style.display="none"),this.mainDivs.length>0&&this.mainDivs.map(e=>{e.style.display="none"})}}var lo;!function(e){e.SHOWN="shown",e.NOT_SHOWN="not shown",e.ALLOWED="allowed",e.DISMISSED="dismissed"}(lo||(lo={}));class go{static baseLogTag="WebPushManager";static handleSdkDisableListener=!1;browser;notificationManager=null;softAskManager=null;sdkSettings;constructor(e,t){go.baseLogTag;this.sdkSettings=e,this.browser=t,this.softAskManager=new co(this.sdkSettings),this.notificationManager=new oo(this.sdkSettings,t),go.handleSdkDisableListener||(window.addEventListener(C.TOPIC_NAME,async e=>{const t=e?.detail?.name;t===C.EVENT_NAMES.SDK_DISABLED&&ao()}),go.handleSdkDisableListener=!0)}callWebPush(){const e=go.baseLogTag+".callWebPush";var t,n;t=this.sdkSettings,n=this.browser,!je.get()?.disableWebPush&&t.isWebPushEnabled&&Fe.includes(n.name)&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window&&this.notificationManager.getCurrentPermissionState().then(async t=>{const n=(n=t)=>{li.get().then(t=>{t.deviceAdded=this.sdkSettings?.isPushSubBilling?oi.shouldTriggerSubscriberBilling({sdkSettings:this.sdkSettings,user:t,pushToken:null})||!!fi():t.deviceAdded,t.save().then(()=>{this.notificationManager.removeToken().then(()=>{Ge()?.track_event(te,{[E]:!1}),Ge()?.track_event(ie),n===ji.DENIED?(gn.set(be.HARD_ASK_STATUS,n),$e.log(1,e,"Not asking for permission as current state is denied.")):(gn.remove(be.OPT_IN_SHOWN_TIME),this.startPushSubscription())})})})},i=await Qn.getInstance(),a=ni(),r=t===ji.DENIED&&!this.sdkSettings.isDomainLevelStorage;if(null==a&&t!==ji.DENIED)this.startPushSubscription();else if(null!=a&&(r||i.isSafari()&&t===ji.PROMPT))$e.log(1,e,"User has removed the permission"),$e.image(1,no),i.isSafari()&&t===ji.PROMPT&&(gn.set(eo,!0),t=ji.DENIED),n(t);else if(r)$e.warn(1,e,"Not proceeding with push subscription as current state is denied");else if(null!=a&&t===ji.GRANTED)this.browser.name===Qn.BROWSER_NAMES.CHROME?qn(this.sdkSettings.webPushPlatformData,this.browser)?this.startPushSubscription():$e.warn(1,e,"Subscription mode is not VAPID type. Cannot subscribe to web push."):(this.startPushSubscription(),this.notificationManager.getPushTokenDetails().then(t=>{$e.customLabel(1,e,"token",t.token)}));else if(this.sdkSettings.isDomainLevelStorage)if(ln.get(be.HARD_ASK_STATUS)===ji.GRANTED){const i=ln.get(be.SUBSCRIPTION_DETAILS)?.domain;i&&i===window.location.origin?($e.log(1,e,"It seems that the user has unsubscribed manually. Starting push subscription.."),n(t)):$e.log(1,e,"Not showing opt-in as user subscribed to sub-domain")}else this.startPushSubscription();else n()}).catch(t=>{$e.error(1,e,"Error in getting current state:",t)})}startPushSubscription(){const e=go.baseLogTag+".startPushSubscription",t=()=>{gn.set(be.HARD_ASK_STATUS,ji.PROMPT);const t=ni();this.notificationManager.showHardAsk().then(n=>{gn.set(be.HARD_ASK_STATUS,n.state),n.state===ji.GRANTED?null!=n.subscriptionDetails.token?(gn.set(be.PUSH_TOKEN,n.subscriptionDetails.token),n.subscriptionDetails.domain=window.location.origin,gn.set(be.SUBSCRIPTION_DETAILS,n.subscriptionDetails),n.subscriptionDetails.token&&t!==n.subscriptionDetails.token&&zi.deviceAdd().then(()=>{$e.image(1,to),li.getSync().subscribedToOldSdk?$e.remoteLogTracking(1,"info",e,"User subscribed from older sdk, hence not sending subscription event"):(null!=t?Ge()?.add_user_attribute("Web Migrated User","true"):Ge()?.add_user_attribute("Web Subscription URL",location.href),Ge()?.track_event(ne,{MOE_WEB_PUSH_TOKEN:n.subscriptionDetails.token,migrated_user:!!window.location.search.includes("moe_migration=true")||void 0}))}),this.sdkSettings.isDomainLevelStorage&&ln.set(be.SUBSCRIPTION_DETAILS,{domain:n.subscriptionDetails.domain,token:n.subscriptionDetails.token,endpoint:n.subscriptionDetails.endpoint,keys:n.subscriptionDetails.keys})):($e.error(1,e,"Push token was received as null."),$e.error(1,e,"Please contact MoEngage support if this troubleshooting does not solve the issue.")):n.state===ji.DENIED&&$e.image(1,no)}).catch(t=>{$e.warn(1,e,t)})},n=()=>{this.softAskManager?this.softAskManager.showSoftAsk().then(e=>{e.showHardAsk&&t()}):$e.log(1,e,"SoftAskManager not set.")};this.notificationManager.getCurrentPermissionState().then(i=>{if(i===ji.GRANTED)this.sdkSettings.optInType!==oa.ONE_STEP&&$e.remoteLogTracking(1,"info",e,"Skipping soft ask as browser permission is set to allow all notifications"),t();else if(i!==ji.DENIED){const t=parseInt(gn.get(be.OPT_IN_SHOWN_TIME)),i=(Date.now()-t)/36e5;if(!t||this.sdkSettings.optInType===oa.SELF_HANDLED||i>this.sdkSettings.promptAgain)if(this.browser.name===Qn.BROWSER_NAMES.SAFARI&&this.sdkSettings.optInType===oa.ONE_STEP){$e.log(1,e,"1 step optin configured. In Safari 16+ and macOS 13+, the web push optin will be shown after a user click. Any delay will be ignored.");const t=()=>{window.removeEventListener("click",t),n()};window.addEventListener("click",t)}else n();else{let n,a;i<1?(n=Math.floor(60*i),a="minute(s)"):(n=Math.floor(100*i)/100,a="hour(s)"),$e.remoteLogTracking(1,"info",e,"Not showing opt in as last it was shown",n,a,"back on",new Date(t),". Reappear time is set to",this.sdkSettings.promptAgain,"hours."),$e.log(1,e,"You can clear localstorage to get opt-in again.")}}else $e.log(2,e,"Not showing opt-in as permission is denied."),gn.set(be.HARD_ASK_STATUS,i)})}getPermissionState(){return this.notificationManager.getCurrentPermissionState()}showNotification(e){this.notificationManager&&this.notificationManager.showNotification(e)}trackPushOptedDeviceAttribute(){return new Promise(e=>{const t=gn.get(be.OPTED_STATUS_TRACK_TIME);if(t&&Date.now()-t>864e5){const e=ni();Ge()?.track_event(te,{[E]:!!e}),gn.set(be.OPTED_STATUS_TRACK_TIME,Date.now())}e(null)})}}class uo{swPath;swScope;customSoftAsk=null;forceSwUpdate;disableWebPush;static get(){return We.get(Ie)}static save(e){We.set(Ie,e),gn.set(be.INIT_DATA,e)}static setSoftAskConfig(e){const t=uo.get(),n={mainClass:He(e,"main_class",He(e,"mainClass",null)),allowClass:He(e,"allow_class",He(e,"allowClass",null)),dismissClass:He(e,"block_class",He(e,"dismissClass",null))};uo.save({...t,customSoftAsk:n})}}class po{static baseLogTag="PushModule";initialize(e){const t=po.baseLogTag+".initialize";po.handlePublicFunctions(),Qn.getInstance().then(n=>{const i=new go(e,n);if(i&&Kn(e,n)){[oa.ONE_STEP,oa.TWO_STEP].indexOf(e.optInType)>=0?i.callWebPush():($e.log(1,t,"Self handled setting. Will show opt-in on manual invocation, if required."),i.getPermissionState().then(e=>{const n=ni();(e===ji.GRANTED||null!=n&&e===ji.DENIED)&&(e===ji.GRANTED&&$e.log(1,t,"Notification permission already granted. Proceeding to subscribe the user"),i.callWebPush())}).catch(e=>{$e.warn(1,t,"Cannot get permission state: ",e)})),i.trackPushOptedDeviceAttribute()}else Fe.includes(n.name)||$e.warn(1,t,"Web push not supported on this browser. Supported browsers are:\n\t\t1. Google Chrome\n\t\t2. Mozilla Firefox\n\t\t3. Opera\n\t\t4. Edge\n\t\t5. Safari 16 and above + macOS 13 and above")})}static getPermissionState(e){return new Promise((t,n)=>{Xn().then(i=>{Qn.getInstance().then(a=>{new go(i,a).getPermissionState().then(n=>{t(n),e&&e(null,n)}).catch(t=>{n(t),e&&e(t,null)})})}).catch(t=>{n(t),e&&e(t,null)})})}static handlePublicFunctions(){const e=Ge();e.callWebPush=po.callWebPush,e.call_web_push=po.callWebPush,e.showNotification=po.showNotification,e.getPermissionState=po.getPermissionState}static callWebPush(e){const t=po.baseLogTag+".callWebPush";Ei()?Xn().then(n=>{n.isWebPushEnabled?n.optInType===oa.SELF_HANDLED?($e.log(1,t,"Starting web push functions"),null!=e&&uo.setSoftAskConfig(e),Qn.getInstance().then(e=>{new go(n,e).callWebPush()})):$e.warn(1,t,"This feature can only be used when you have chosed self-handled approach in the dashboard. You can check dashboard here:",ue):$e.log(1,t,"Web push settings not configured on dashboard yet. To start web push subscriptions, please configure the settings on dashboard.")}).catch(e=>{$e.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}):$e.warn(2,t,"Cannot initiate web push as Web SDK has been disabled.")}static showNotification(e){Xn().then(t=>{Qn.getInstance().then(n=>{new go(t,n).showNotification(e)})}).catch(e=>{})}}const mo="MOE_WEBP_MESSAGE_SHOWN",ho="MOE_WEBP_MESSAGE_CLICKED",fo="MOE_OFFERING_CLICKED",Eo="MOE_OFFERING_SHOWN";function So(e){if(!e||"object"!=typeof e)return!1;return["moe_offering_id","moe_offering_name","moe_offering_type","moe_decision_policy_id","moe_decision_policy_name"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function _o(e){if(!e||"object"!=typeof e)return!1;return["cid","moe_locale_id","moe_variation_id"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function vo(e,t){if(e&&"object"==typeof e&&!Array.isArray(e))return e;if("string"==typeof e)try{const n=JSON.parse(e);return n&&"object"==typeof n&&!Array.isArray(n)?n:($e.error(2,t,"Parsed JSON is not a valid object"),null)}catch(e){return $e.error(2,t,"Error parsing JSON string:",e),null}return null}class yo{static baseLogTag="Web Personalization Tracking";initialize=()=>{Ge().personalize={trackClick:this.trackClick,trackImpression:this.trackImpression,onUpdateDeviceId:this.onUpdateDeviceId,offeringClicked:this.offeringClicked,offeringShown:this.offeringShown},yo.setupFetchExperiencesFunction()};static setupFetchExperiencesFunction=()=>{const e=()=>{const e=Ge();e&&e.personalize&&(e.personalize.fetchExperiences=window.MoeWebP.fetchExperiences)};window.MoeWebP&&window.MoeWebP.fetchExperiences?e():window.addEventListener(C.TOPIC_NAME,t=>{t.detail.name===C.EVENT_NAMES.WEBP_INIT&&e()})};getDeviceUniqueId=e=>{window.addEventListener(C.TOPIC_NAME,t=>{if(t.detail.name===C.EVENT_NAMES.DEVICE_UUID){const n=t.detail.data;e(n)}})};onUpdateDeviceId=e=>{this.getDeviceUniqueId(e)};offeringClicked=(e,t)=>yo.track(e,fo,So,"Invalid offering context, missing required fields",t);offeringShown=(e,t)=>yo.track(e,Eo,So,"Invalid offering context, missing required fields",t);trackClick=(e,t)=>yo.track(e,ho,_o,"Invalid experience context, missing required fields",t);trackImpression=(e,t)=>yo.track(e,mo,_o,"Invalid experience context, missing required fields",t);static track=(e,t,n,i,a)=>{const r=yo.baseLogTag+".track",s=vo(e,r);if(!s)return $e.error(2,r,"Invalid context"),Promise.reject(new Error("Invalid context"));if(!n(s))return $e.error(2,r,i),Promise.reject(new Error(i));const o=a&&vo(a,r)||{},c={...s,...o};try{const e=Ge();return e?($e.log(2,r,t+": Event Tracked"),e.track_event(t,c)):(window.moengage_q=window.moengage_q||[]).push({f:"track_event",a:[t,c]}),Promise.resolve()}catch(e){return $e.error(2,r,"Failed tracking expression",e),Promise.reject(e)}}}class To{static baseLogTag="ModuleManager";static loadPromises={};constructor(){To.handleEventListeners()}static loadModule(e){const t=To.baseLogTag+".loadModule";return null!=To.loadPromises[e.name]||($e.log(1,t,"Starting to fetch module: ",e.name),To.loadPromises[e.name]=new Promise((t,n)=>{!function(e,t){if(document){const n=document.createElement("script");n.setAttribute("src",hi(e)),n.onload=t,n.async=!0,document.body.appendChild(n)}}(e.src,(...n)=>{const i=new(0,window[Te[e.name].windowLocation])(je.get());t(i)})})),To.loadPromises[e.name]}static async enableOSM(){const e=je.get();void 0===Ge().onsite.OnsiteApiClient&&(Ge().onsite=new qs(e),await Ge().onsite.initialize())}static async disableOSM(e=!1,t=!1){const n=Ge();n.onsite.OnsiteApiClient&&($e.log(2,To.baseLogTag,`Logging out from OSM module - userLogoutHappen: ${e}, OsmOptOut: ${t}`),await Ge().onsite.logout(e,t),n.onsite=null,n.onsite=Aa)}static async enableCards(e){const t=Ge();To.loadModule(Te.CARDS).then(n=>{n.initialize(e),t.cards=n}).catch(e=>{$e.error(1,"enableCards","Error in loading Cards Module:",e)})}static async disableCards(){const e=Ge();e.cards&&await e.cards.disableCardsModule()}static async enablePush(e){(new po).initialize(e)}static handleEventListeners(){window.addEventListener("MODULE_ACTIONS",async e=>{"DISABLE_OSM"===e.detail.name&&To.disableOSM(e.detail.data?.isUserLogout),"DISABLE_ENABLE_OSM"===e.detail.name&&Ge()?.onsite.initData?.appId&&(await To.disableOSM(),To.enableOSM())})}static async enableWebPersonalizationTracking(){(new yo).initialize()}}class bo{deviceToLogout;constructor(e){this.deviceToLogout=He(e,"deviceToLogout",null)}static get(){return new bo(gn.get(be.GRACEFUL_DATA))}save(){gn.set(be.GRACEFUL_DATA,this)}}class Io{static CLEANUP_THROTTLE_MS=500;static MOUSE_OUT_THRESHOLD_PX=5;static isCleanupInProgress=!1;static isBatchingEnabled=!1;static listenersAdded=!1;static lastCleanupAttempt=0;onWindowVisibilityChange(e){We.set("isWindowActive",!0),document.addEventListener("focus",()=>{t(!0)},!1),document.addEventListener("blur",()=>{t(!1)},!1),window.addEventListener("focus",()=>{t(!0)},!1),window.addEventListener("blur",()=>{"IFRAME"!==document.activeElement.tagName&&t(!1)},!1);const t=e=>"boolean"==typeof e?n(e?"visible":"hidden"):document.hidden?n("hidden"):n("visible"),n=t=>{We.set("isWindowActive","visible"===t),e(t)};window.addEventListener("visibilitychange",t,!1)}static executeCleanup(){const e=Date.now();if(e-Io.lastCleanupAttempt<Io.CLEANUP_THROTTLE_MS)return;if(Io.lastCleanupAttempt=e,Io.isCleanupInProgress)return;const{reportsCount:t,remoteLogsCount:n}=Io.getBatchCounts();if(0!==t||0!==n){Io.isCleanupInProgress=!0;try{if(Io.isBatchingEnabled&&(Ui.windowClosed=!0,t>0&&(Vi.sendBeacon(),Vi.reactToTriggerEvents())),window.Moengage.onsite?.displayManager){const{sendDelayCampaignStats:e,displayManager:t,funnelManager:n}=window.Moengage.onsite;e(t,n)}}catch(e){$e.error(0,"WindowEventManager.executeCleanup","Error during cleanup execution:",e)}finally{Io.isCleanupInProgress=!1}}}static beforeUnload(){Io.shouldExecuteCleanup()&&Io.executeCleanup()}static pageHide(e){!(!(!e||"boolean"!=typeof e.persisted)&&e.persisted)&&Io.shouldExecuteCleanup()&&Io.executeCleanup()}static shouldExecuteCleanup(){if(Io.isCleanupInProgress)return!1;const{reportsCount:e,remoteLogsCount:t}=Io.getBatchCounts();return e>0||t>0}static getBatchCounts(){return{reportsCount:Vi.reports?.length||0,remoteLogsCount:Vi.remoteLogs?.length||0}}static manageMobileEventListeners(e){if(!Fn())return;const t=e?"addEventListener":"removeEventListener",n=Io.mobileAppStateChange;window[t]("focus",n,!1),window[t]("blur",n,!1),document[t]("touchstart",n,!1)}static visibilityChangeForCleanup(){document.hidden&&Io.shouldExecuteCleanup()&&($e.log(2,"WindowEventManager.visibilityChangeForCleanup","Visibility change detected, executing cleanup"),Io.executeCleanup())}static mouseOut(e){(null===e.relatedTarget||e.clientY<=Io.MOUSE_OUT_THRESHOLD_PX)&&($e.log(2,"WindowEventManager.mouseOut","Mouse left window or browser header detected"),Io.shouldExecuteCleanup()&&Io.executeCleanup())}static mobileAppStateChange(){Io.shouldExecuteCleanup()&&($e.log(2,"WindowEventManager.mobileAppStateChange","Mobile app state change detected, executing cleanup"),Io.executeCleanup())}static removeAllCleanupListeners(){Io.listenersAdded&&($e.log(2,"WindowEventManager.removeAllCleanupListeners","Removing all enhanced event listeners"),Io.isCleanupInProgress=!1,Io.listenersAdded=!1,Io.lastCleanupAttempt=0,window.removeEventListener("beforeunload",Io.beforeUnload,!1),"onpagehide"in window&&window.removeEventListener("pagehide",Io.pageHide,!1),document.removeEventListener("visibilitychange",Io.visibilityChangeForCleanup,!1),document.removeEventListener("mouseout",Io.mouseOut,!1),Io.manageMobileEventListeners(!1))}static addAllCleanupListeners(e){Io.listenersAdded||($e.log(2,"WindowEventManager.addAllCleanupListeners","Adding enhanced event listeners for incognito mode, batching enabled:",e),e&&(Io.isBatchingEnabled=!0),Io.isCleanupInProgress=!1,Io.listenersAdded=!0,Io.lastCleanupAttempt=0,document.addEventListener("visibilitychange",Io.visibilityChangeForCleanup,!1),"onpagehide"in window&&window.addEventListener("pagehide",Io.pageHide,!1),window.addEventListener("beforeunload",Io.beforeUnload,!1),document.addEventListener("mouseout",Io.mouseOut,!1),Io.manageMobileEventListeners(!0))}}const Ao="MoEngage.logoutHandler";function wo(){try{if("undefined"==typeof localStorage)return!1;const e=gn.get(be.LOGOUT_IN_PROGRESS);return!0===e||"true"===e}catch(e){return!1}}function Do(e){if("undefined"!=typeof localStorage)if(e){gn.set(be.LOGOUT_IN_PROGRESS,!0);const e=Ao+".setLogoutProgress";$e.log(2,e,"Logout in progress flag set")}else gn.remove(be.LOGOUT_IN_PROGRESS)}const Co="MoEngage.user";class Oo{static addAttribute(e,t,n=ti.USER_ATTRIBUTE_LEVEL.PROJECT){const i=Co+".addUserAttribute";return new Promise((a,r)=>{if(!Ei())return $e.warn(2,i,`Not tracking the attribute "${e}" as Web SDK has been disabled.`),void a(!1);const s=je.get();Xn().then(r=>{if("string"!=typeof e||null==e)$e.error(1,i,"Attribute name needs to be a string"),a({error:5e3,message:"Attribute name needs to be a string. Type provided was "+typeof e});else if(""===e)$e.error(1,i,"Attribute name can not be an empty string"),a({error:5001,message:"Attribute name can not be an empty string"});else if(null==t)$e.error(1,i,"Attribute value null"),a({error:5003,message:"Attribute value was empty"});else if("string"==typeof t&&""===t)$e.error(1,i,"Attribute value needs to be non-empty string or non-empty object"),a({error:5004,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Ri(t)&&On.includes(e))$e.error(1,i,`Value of '${e}' attribute cannot be an object`),a({error:5002,message:"Attribute value cannot be an object"});else if("object"==typeof t&&Array.isArray(t)&&!t.length)$e.error(1,i,"Attribute value needs to be non-empty string or non-empty object"),a({error:5006,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Ri(t)&&!Object.keys(t).length)$e.error(1,i,"Attribute value cannot be empty object"),a({error:5005,message:"Attribute value cannot be empty object"});else if(n!==ti.USER_ATTRIBUTE_LEVEL.PORTFOLIO||s?.projectId)if(n!==ti.USER_ATTRIBUTE_LEVEL.PORTFOLIO||"id"!==e&&e!==o)if(n===ti.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&r.configs.blacklistedPortfolioUserAttributes.includes(e))$e.error(1,i,"Cannot track this portfolio attribute as it is blacklisted"),a({error:5007,message:"Cannot track this portfolio attribute as it is blacklisted"});else{const c=new ti(e,t,n),l=()=>{li.get().then(e=>{e.addAttribute(c).then(async e=>{s?.projectId||await this.checkAndAddAttributeInIdentityMap(c,t,r),e?(c.key===o&&(await jn.updateIdentifiersIDB({moe_user_id:c.value}),$e.log(1,i,"Logging in the user with id: ",c.value)),qi.createUserAttributeEvent(c).then(e=>{$e.log(2,i,"Event to be converted to report:",e),$i.addEvent(e),zi.collectGetParams().then(t=>{const i=new Ki(Ki.REPORT_ADD_TYPE.USER_ATTRIBUTE,t,e,n);zi.reportAdd(i).then(()=>{a(!0)})})})):($e.error(1,i,"Attribute already present/queued. Not adding again."),a({error:5005,message:"Attribute already present/queued. Not adding again."}))})})};"id"===e?li.get().then(async e=>{const n=e.indexOfAttribute("id");if(n>-1)if(t===e.attributes[n].value)$e.log(1,i,"User already logged in with id:",t),a(!0);else{$e.log(1,i,"Logging out previous user with id:",e.attributes[n].value),Ti.broadcastToWindow({topic:"USER_ACTIONS",name:"FORCED_LOGOUT",data:{id:t}});const a=jn.getUserIdentities(),s=a?.uid;Oo.logout(!0,t).then(async()=>{await this.forcedLogoutUpdateInIdentityMap(t,s,r),l()})}else await this.uidLoginUpdateIdentityMap(t,r),l()}):(Ti.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGIN",data:{id:t}}),l())}else $e.error(1,i,"uid cannot be tracked as portfolio attribute"),a({error:5007,message:"uid cannot be tracked as portfolio attribute"});else $e.error(1,i,"Cannot track this attribute at portfolio level as project id is missing in integration"),a({error:5007,message:"Cannot track this attribute at portfolio level as project id is missing in integration"})}).catch(n=>{window.moengage_q?.push({f:"add_user_attribute",a:[e,t]}),$e.error(1,i,"Error in getting Web SDK Settings. ",n),a({error:5007,message:"Error in getting Web SDK Settings.",err:n})})})}static login(e){return Oo.addAttribute("id",e)}static async identifyUser(e){const t=Co+".identifyUser";if(Ei())if("string"==typeof e&&e.length||function(e){if("object"!=typeof e||null===e)return!1;let t=!0;for(const n in e){t=!1;const i=e[n];if("string"!=typeof i||!i.length)return!1}return!t}(e)){let n,i={};if("string"==typeof e?i.uid=e:i={...e},je.get().projectId){if(!i.uid)return void $e.error(1,t,"Only 'uid' can be set as identity in project level.");i={uid:i.uid},$e.log(1,t,"Project level integration. Only uid is accepted as identity.")}try{n=await Xn()}catch(e){$e.warn(1,t,"Could not fetch sdk config.")}await async function(){try{const e=Ao+".waitForLogoutCompletion";let t=wo();if(!t)return;$e.log(2,e,"Logout in progress, waiting for completion...");let n=!1,i=null;"undefined"!=typeof window&&(i=e=>{"MOE_DATA"===e.key&&(wo()||(n=!0))},window.addEventListener("storage",i));const a=Date.now()+Be;let r=0;const s=xe;for(;t&&!n&&Date.now()<a&&r<s;)await new Promise(e=>setTimeout(e,Ue)),t=wo(),r++;i&&"undefined"!=typeof window&&window.removeEventListener("storage",i),t&&($e.error(2,e,"Timeout waiting for logout to complete. Proceeding anyway."),Do(!1))}catch(e){const t=Ao+".waitForLogoutCompletion";$e.error(2,t,"Error in waitForLogoutCompletion:",e)}}();const a=await li.get(),r=jn.getUserIdentities()||{};let s=!1,o=!1;const c={};for(const e in i){if("string"!=typeof i[e])return void $e.error(1,t,`Identity '${e}' has a non-string value. Rejecting the IdentityMap.`);r[e]&&r[e]===i[e]||(s=!0),r[e]&&r[e]!==i[e]&&(c[e]=r[e]),!o&&n?.isPushSubBilling&&!a.deviceAdded&&oi.shouldTriggerSubscriberBilling({user:a,sdkSettings:n,identities:{[e]:i[e]}})&&(o=!0)}if(s){const e=Object.keys(jn.getUserIdentities()||{}).length||a.getAttribute("id");e&&await Vi.flushReports();let s=!1;if(o)try{await zi.deviceAdd(),s=!0}catch(e){$e.error(1,t,"Error occurred while adding device: ",e)}i.uid&&i.uid!==r.uid&&(await a.addAttribute(new ti("id",i.uid)),await jn.updateIdentifiersIDB({moe_user_id:i.uid})),await jn.updateCurrentUserIdentities(i),Object.keys(c).length&&await jn.updatePreviousUserIdentities(c);try{!e&&Vi.reports.length||!n||n.isPushSubBilling&&(!n.isPushSubBilling||!a.deviceAdded&&!s)||await zi.sendBatchOfReports([])}catch(e){$e.error(1,t,"Error occurred while sending identities request: ",e)}jn.broadcastUserIdentityUpdate()}else $e.warn(1,t,"Identities not updated as same values were passed again.")}else $e.error(1,t,"type of the argument 'identities' is not supported OR empty identity received.");else $e.warn(2,t,"Not tracking user identities as Web SDK has been disabled.")}static logout(e,t){const n=Co+".logout";if(!Ei())return $e.warn(2,n,"Not tracking user logout as Web SDK has been disabled."),Promise.resolve(!1);const i=e?{type:"forced",new_uid:t}:null;return Do(!0),function(){const e=bo.get();null!=li.getSync()&&(e.deviceToLogout=li.getSync().deviceUuid,e.save())}(),new Promise(e=>{Yi.track(ee,i).then(async()=>{$e.log(1,n,"Logging out now!"),await Vi.flushReports(!0),Io.removeAllCleanupListeners(),Xn().then(async t=>{t.isDomainLevelStorage&&(ln.remove(be.USER_DATA),ln.remove(be.IDENTITY_MAP)),$i.clear(),jn.broadcastLogout(),await li.logout(),gn.logout(),await jn.updateIdentifiersIDB({}),gn.remove(be.GRACEFUL_DATA),zi.onDeviceAdd=new Gn,We.set(De,!0),Do(!1),setTimeout(()=>{Ti.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGOUT_COMPLETED"})},100),Ke.setRemoteLogging(null,!1),e(!0)}).catch(t=>{$e.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),Do(!1),e(!1)})}).catch(t=>{$e.error(2,n,"Error in logout event tracking:",t),Do(!1),e(!1)})})}static updateUniqueId(e){const t=Co+".updateUniqueId";return Ei()?new Promise(n=>{li.get().then(async i=>{const a=i.indexOfAttribute(o),r=i.indexOfAttribute("oldUniqueIds");if(!(a>-1))return $e.log(2,t,"Logging in as no id found"),Oo.login(e);{const s=i.attributes[a].value;e!==s?($e.log(2,t,"Different ids found"),r>-1?(i.attributes[r].value.push(s),i.attributes.splice(a,1)):(i.attributes.splice(a,1),i.addAttribute(new ti("oldUniqueIds",[s]))),i.save().then(()=>{Oo.login(e).then(()=>{n(!0)})})):($e.warn(1,t,"New id and old id are the same. Not updating the id."),n(!0))}})}):($e.warn(2,t,"Not updating user ID as Web SDK has been disabled."),Promise.resolve(!1))}static getAttributes(e=ti.USER_ATTRIBUTE_LEVEL.PROJECT){const t=li.getSync().attributes,n={};return t.forEach(t=>{(!t.level&&e===ti.USER_ATTRIBUTE_LEVEL.PROJECT||t.level===e)&&(n[t.key]=t.value)}),n}static setAttributes(e){const t=`${Co}.setAttributes`;li.getSync().attributes=e,$e.log(2,t,"User attributes have been updated")}static async checkAndAddAttributeInIdentityMap(e,t,n){const i=Co+".checkAndAddAttributeInIdentityMap";if(e.key!==o&&"string"==typeof t){const a=f.find(t=>t.attributeName===e.key)?.moeName||e.key;n.configs.identityAttributes.includes(a)&&($e.log(1,i,`Attribute to be tracked: '${e.key}' is an identity.`),await this.identifyUser({[a]:t}))}}static async forcedLogoutUpdateInIdentityMap(e,t,n){n.configs.identityAttributes.includes(_)&&t&&t!==e&&await jn.updateCurrentUserIdentities({uid:e})}static async uidLoginUpdateIdentityMap(e,t){if(t.configs?.identityAttributes?.includes(_)){const t=jn.getUserIdentities();t?.uid&&t.uid!==e&&(await Vi.flushReports(),await jn.updatePreviousUserIdentities({uid:t.uid})),await jn.updateCurrentUserIdentities({uid:e})}jn.broadcastUserIdentityUpdate()}}class Po{static isIntegrated(){try{const e=localStorage.getItem(Ea),t=localStorage.getItem(Sa),n=localStorage.getItem(_a),i=localStorage.getItem(va),a=localStorage.getItem(ba),r=localStorage.getItem(Ta),s=localStorage.getItem(ya),o={};e&&(o.cluster=e),t&&(o.swPath=t),n&&(o.swScope=n),i&&(o.enableSPA="true"===i),r&&(o.disableCookies="true"===r),a&&(o.disable_onsite="true"===r),s&&(o.cards=JSON.parse(s));const c=e||t||n||i||r||a||s;return c&&$e.log(1,".isSegmentDataFound","Data found for segment initialisation",o),!!c&&o}catch(e){return!1}}}const No=()=>new Promise(e=>{"complete"!==window.document.readyState?window.addEventListener("load",()=>{e(!0)}):e(!0)});class Ro{static baseLogTag="SdkMethods";static moeDataStore;static enableSdk(){const e=this.baseLogTag+".enableSdk";return new Promise(t=>{Ei()?($e.warn(2,e,"SDK is already enabled."),t(!0)):(this.setDisabledFlag(!1),Fo(),Wo().then(()=>{this.broadcastSdkEnabled(),Bi.initialize().then(()=>{this.setDisabledFlagIDB(!1)}),Ii(),t(!0)}))})}static disableSdk(){const e=this.baseLogTag+".disableSdk";return new Promise(t=>{Ei()?(this.broadcastSdkDisabled(),this.setDisabledFlag(!0),this.setDisabledFlagIDB(!0).then(e=>{this.disableSdkActivities(),(new Pi).clearSessionAndSource(),this.filterAndClearUserAttributesCache(),t(e)})):($e.warn(2,e,"SDK is already disabled."),t(!0))})}static setDisabledFlag(e){gn.set(be.SDK_DISABLED,e),ln.set(be.SDK_DISABLED,e)}static filterAndClearUserAttributesCache(){const e=gn.get(be.WEB_SETTINGS),t=e?.configs?.identityAttributes,n=e?.configs?.subscriberBasedBillingAttributes,i=gn.get(be.USER_DATA);i?.attributes?.length&&(i.attributes=i.attributes.filter(i=>{if(t?.length){const e=f.find(e=>e.attributeName===i.key)?.moeName||i.key;if(t.includes(e))return!0}const a=[c,u,"Web Migrated User","Web Subscription URL"];return!(!e?.isPushSubBilling||!(a.includes(i.key)||n?.length&&n.includes(i.key)))}),Oo.setAttributes(i.attributes),gn.set(be.USER_DATA,i))}static broadcastSdkEnabled(){Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.SDK_ENABLED})}static broadcastSdkDisabled(){Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.SDK_DISABLED})}static async setDisabledFlagIDB(e=!1){return new Promise(n=>{this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Me,storeName:Le})),this.moeDataStore?this.moeDataStore.setItem(be.SDK_DISABLED,e).then(()=>{n(!0)}).catch(()=>n(!1)):n(!1)})}static disableSdkActivities(){Vi.suspendBatching(),je.get()?.enableSPA&&ua.removeURLChangeObserver(),Io.removeAllCleanupListeners();for(const e in be.Q)un.purge(e);"function"==typeof Bi.offlineDataStore?.clear&&Bi.offlineDataStore.clear()}}class Mo{static track_event=(e,t)=>Yi.track(e,t);static add_unique_user_id=e=>Oo.login(e);static update_unique_user_id=e=>Oo.updateUniqueId(e);static add_user_attribute=(e,t,n=ti.USER_ATTRIBUTE_LEVEL.PROJECT)=>Oo.addAttribute(e,t,n);static add_first_name=e=>Oo.addAttribute("first_name",e);static add_last_name=e=>Oo.addAttribute("last_name",e);static add_email=e=>Oo.addAttribute("email",e);static add_mobile=e=>Oo.addAttribute("mobile",e);static add_user_name=e=>Oo.addAttribute("name",e);static add_gender=e=>Oo.addAttribute("gender",e);static add_birthday=e=>Oo.addAttribute("birthday",e);static destroy_session=()=>Oo.logout();static track_page_view=()=>(Yi.track(K,{timestamp:Number(Date.now())}),Yi.track(q,{timestamp:Number(Date.now())}));static identifyUser=e=>Oo.identifyUser(e);static getUserIdentities=()=>jn.getUserIdentities();static enableSdk=()=>Ro.enableSdk();static disableSdk=()=>Ro.disableSdk();static isSdkEnabled=()=>Ei();static user={getAttributes:Oo.getAttributes};static getUserId=()=>Oo.getAttributes()?.USER_ATTRIBUTE_UNIQUE_ID||"";static getUserAttribute=(e,t=ti.USER_ATTRIBUTE_LEVEL.PROJECT)=>Oo.getAttributes(t)[e]||"";static userAttributeLevel=ti.USER_ATTRIBUTE_LEVEL}class Lo{static getUuid(){return gn.get(be.USER_DATA).deviceUuid}static getPushToken(){const e=gn.get(be.SUBSCRIPTION_DETAILS);return e?.token||null}static getDeviceData(){return gn.get(be.DEVICE_DATA)}static setDeviceData(e,t){gn.set(be.DEVICE_DATA,{...this.getDeviceData(),[e]:t})}static createNewDeviceUniqueId(){this.setDeviceData("deviceUniqueId",vn())}}function ko(e){const t="Pre-Initialization";if((e=>{const t=["bot","spider","crawler","crawling","Applebot","PetalBot","pingbot","proximic","AdsBot-Google","Googlebot","Cincraw","SnapchatBot","Snapchat-Proxy/1.0","SnapchatAds","Snapchat-Ads/1.0","YandexRenderResourcesBot","bingbot","slurp","MicrosoftPreview","Baiduspider","HeadlessChrome",...Array.isArray(e)?e:[]];return new RegExp(t.join("|"),"i").test(navigator.userAgent)})(e?.bots_list))return void $e.error(1,t,"Bot detected, Can't initialise the MoEngage Web SDK");const n=Ge();if(n&&n.initialised>0)return $e.error(1,t,"MoEngage Web SDK initialised multiple times. Please integrate the Web SDK only once!"),n;if("undefined"==typeof Promise)return $e.error(1,t,"Promises not supported"),Da;if(e.app_id||e.appId){const n=Po.isIntegrated();n&&(e=Object.assign({},e,n)),je.save(e);const i=je.get();No().then(()=>{Vo(),new To,Bo(i),Uo(e.disableSdk),Ei()||xo()?(Fo(),Ho(),Wo().then(()=>{Ii()})):$e.warn(2,t,"Not initialising the SDK as it has been disabled."),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.MOE_INIT,data:e},!0)});const a=window.moengage_object||"Moengage",r={...Ia,...Mo,onsite:Aa};return window[a]=r,r}return $e.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",ge.WEBSDK_DOCS),Da}const xo=()=>!(!Si()&&!ln.get(Pe)||!1!==ln.get(be.SDK_DISABLED))&&(gn.set(be.SDK_DISABLED,!1),!0),Uo=e=>{var n,i;(n=Me,i=Le,new Promise(e=>{const t=indexedDB.open(n);t.onsuccess=()=>{t.result.objectStoreNames.contains(i)?e(!0):e(!1)},t.onerror=()=>{e(!1)}})).then(n=>{if(n){const n=t().createInstance({driver:[t().INDEXEDDB],name:Me,storeName:Le});if(n&&(n.setItem("isSdkDisabledAtInit",!!e),Si()||ln.get(Pe))){const e=ln.get(be.SDK_DISABLED);"boolean"==typeof e?n.setItem(be.SDK_DISABLED,e):n.removeItem(be.SDK_DISABLED)}}})},Bo=e=>{const t="handleLogger";$e.setLogLevel(e.debugLevel),$e.log(1,t,"Init data: ",e),$e.log(1,t,"Script loaded!"),$e.customLabel(1,t,"SDK Version","2.64.00"),e.debugLevel>0&&($e.warn(1,t,"You are currently using MoEngage in debug environment. You'll find all the data captured in this environment in the TEST mode on the dashoard."),$e.warn(1,t,"Please initialize with debugLevel as",0,"when using on your production environment."))},Fo=()=>{window.addEventListener("USER_ACTIONS",e=>{"LOGOUT_COMPLETED"===e.detail.name&&Wo(!0)})},Ho=()=>{window.addEventListener(C.TOPIC_NAME,e=>{if(e.detail.name===C.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD){const e="handleLandingPageDeviceAdd";ga.getWebSDKSettings().then(t=>{if(t?.configs?.landingPageTracking)return li.get().then(t=>{t.deviceAdded||($e.log(2,e,"Landing page tracking enabled and device not added, triggering device add"),zi.deviceAdd(!1))})}).catch(t=>{$e.error(2,e,"Error getting SDK settings or checking device status for landing page device add:",t),zi.deviceAdd(!1)})}})},Vo=()=>{if(Hn()===k.WEB){t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne,storeName:Re}).clear()}};window&&(window.moe=ko,window.moeBannerText="banner",window[he]=$i);const Wo=(e=!1)=>{const t="Initialization";return new Promise(n=>ga.getWebSDKSettings().then(i=>{const{isDomainLevelStorage:a,isPushSubBilling:r,isWebPushEnabled:s,configs:{isBatchingEnabled:o,remoteLogTracking:c,logLevel:l,isCardsModuleEnabled:d}}=i;Ke.setRemoteLogging(l,c),Ko(a),qo(o,c,i);const g=Lo.getDeviceData();return g?.deviceUniqueId||Lo.createNewDeviceUniqueId(),li.get().then(async o=>{if(zi.checkAndTrackUniversalLink(),i.configs?.identityAttributes?.includes(_)&&!jn.getUserIdentities()?.uid&&jn.copyUidIntoIdentityMap(o),bo.get().deviceToLogout===o.deviceUuid)return $e.remoteLogTracking(1,"info",t,"User was not able to logout last time. Completing the logout now and starting new session."),Oo.logout();{o.deviceAdded&&zi.onDeviceAdd.res(),r&&$e.warn(1,t,"You are under push subscriber based billing plan. We are only tracking users with an email, phone number or have subscribed to web push. All user attributes and events will be stored in a queue till we receive either of the properties.");const c=new Pi;if((new Io).onWindowVisibilityChange(c.handleBrowserInactivity),$e.customLabel(1,t,"Device UUID",o.deviceUuid),$e.customLabel(1,t,"Device Added",o.deviceAdded),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.SETTINGS_FETCHED,data:i}),Ti.broadcastToWindow({topic:C.TOPIC_NAME,name:C.EVENT_NAMES.DEVICE_UUID,data:o.deviceUuid}),(!i.isPushSubBilling&&(!o.deviceAdded||e)||i.isPushSubBilling&&(oi.shouldTriggerSubscriberBilling({user:o,sdkSettings:i})&&e||fi()))&&zi.deviceAdd(),Mo.track_page_view(),Xi.clear(be.Q.DEVICE),Xi.clear(be.Q.REPORT),je.get().enableSPA&&!ua.isObserverRunning){(new ua).addURLChangeObserver(a)}Qn.getInstance().then(e=>{const n=!window.MoeWebP?.isEditorModeEnabled?.();s&&!je.get().disableWebPush&&n?To.enablePush(i):$e.warn(1,t,"Web push feature not enabled for current environment"),!je.get().disableOnsite&&n?zi.onDeviceAdd.p.then(()=>{To.enableOSM()}):$e.warn(1,t,"Onsite is disabled in this page since `disableOnsite: true` is passed during initialization."),d&&je.get().cards?.enable&&n?To.enableCards(i):To.disableCards(),i.configs?.isWebPersonalizationModuleEnabled&&To.enableWebPersonalizationTracking(),Go()}),n(!0)}})}).catch(e=>{$e.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),n(!1)}))},Go=()=>{const e="Moengage.clearWindowQ";try{const t=Ge();let n=window.moengage_q;if(t&&n){if(window.moengage_q=[],n&&n.length>0&&t)for(let i=0;i<n.length;i++){$e.remoteLogTracking(1,"info",e,"Method called before SDK downloaded:",[n[i].f],n[i].a);const a=n[i].f;"onsite.getData"===a?t.onsite.getData(...n[i].a):"onsite.registerCallback"===a?t.onsite.registerCallback(...n[i].a):"onsite.getSelfHandledOSM"===a?t.onsite.getSelfHandledOSM(...n[i].a):"landingPages.trackImpression"===a?t.landingPages.trackImpression.apply(null,n[i].a):null!=t[n[i].f]&&t[n[i].f].apply(null,n[i].a)}n=[]}}catch(t){$e.error(1,e,t)}},Ko=e=>{e&&(gn.isSharedWithCookie=!0,gn.copyKeysFromCookie())},qo=(e,t,n)=>{Io.addAllCleanupListeners(e),(e||t)&&(Vi.init(n),$e.log(1,"handleBatching",`Enabled Batching for ${e?"Event Tracking":""}${t?", Remote Logs Tracking":""}`))},$o={clearWindowQ:Go,clearEventsFromIDB:Vo,initialize:ko,isWindowLoaded:No}})()})();